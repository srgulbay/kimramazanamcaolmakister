<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ramazanamca Matematik Bilgi YarÄ±ÅŸmasÄ±</title>
    <link rel="stylesheet" href="styles.css">
    </head>
<body>
    <div id="quiz-container">
        <h1>Ramazanamca Matematik Bilgi YarÄ±ÅŸmasÄ± </h1>

        <div id="name-entry">
            <div class="player-input-group">
                <label for="player-1-name-input">Oyuncu 1 AdÄ±:</label>
                <input type="text" id="player-1-name-input" placeholder="Ä°sim..." maxlength="20">
                <label for="player-1-age-input">YaÅŸÄ± (7-18):</label>
                <input type="number" id="player-1-age-input" min="7" max="18" placeholder="YaÅŸ...">
            </div>
            <div class="player-input-group">
                <label for="player-2-name-input">Oyuncu 2 AdÄ±:</label>
                <input type="text" id="player-2-name-input" placeholder="Ä°sim..." maxlength="20">
                <label for="player-2-age-input">YaÅŸÄ± (7-18):</label>
                <input type="number" id="player-2-age-input" min="7" max="18" placeholder="YaÅŸ...">
            </div>
            <div class="player-input-group">
                <label for="player-3-name-input">Oyuncu 3 AdÄ±:</label>
                <input type="text" id="player-3-name-input" placeholder="Ä°sim..." maxlength="20">
                <label for="player-3-age-input">YaÅŸÄ± (7-18):</label>
                <input type="number" id="player-3-age-input" min="7" max="18" placeholder="YaÅŸ...">
            </div>
            <div id="confirm-container">
                <button id="confirm-names-button">YarÄ±ÅŸmayÄ± BaÅŸlat</button>
            </div>
            <p id="tts-support-warning" style="color: red; width: 100%; text-align: center; margin-top: 10px; display: none;">TarayÄ±cÄ±nÄ±z metin seslendirme Ã¶zelliÄŸini desteklemiyor olabilir. AnlatÄ±m seslendirilemeyecek.</p>
        </div>

        <div id="quiz-content">
            <div id="narration-area" style="display: none;">
                <p id="narration-info">Åimdi dikkatle dinleyin...</p>
                <button id="play-narration-btn">AnlatÄ±mÄ± Seslendir</button>
            </div>
            <div id="loading-indicator">SÄ±radaki sorular hazÄ±rlanÄ±yor...</div>
            <div id="scoreboard" style="display: none;">
                <h3>Skor Tablosu</h3>
                <ul id="scoreboard-list"></ul>
            </div>
            <div id="players-area">
                <div class="player-quiz-area" id="player-area-1">
                    <div class="player-info">
                        <span class="player-name" id="player-1-name-display">Oyuncu 1</span>
                        <span class="player-age" id="player-1-age-display">(YaÅŸ)</span>
                    </div>
                    <div class="player-question" id="question-player-1">Soru yÃ¼kleniyor...</div>
                    <div class="player-options" id="options-player-1"></div>
                    <div class="player-feedback" id="feedback-player-1"></div>
                </div>
                <div class="player-quiz-area" id="player-area-2">
                    <div class="player-info">
                         <span class="player-name" id="player-2-name-display">Oyuncu 2</span>
                         <span class="player-age" id="player-2-age-display">(YaÅŸ)</span>
                    </div>
                    <div class="player-question" id="question-player-2">Soru yÃ¼kleniyor...</div>
                    <div class="player-options" id="options-player-2"></div>
                    <div class="player-feedback" id="feedback-player-2"></div>
                </div>
                <div class="player-quiz-area" id="player-area-3">
                    <div class="player-info">
                        <span class="player-name" id="player-3-name-display">Oyuncu 3</span>
                        <span class="player-age" id="player-3-age-display">(YaÅŸ)</span>
                    </div>
                    <div class="player-question" id="question-player-3">Soru yÃ¼kleniyor...</div>
                    <div class="player-options" id="options-player-3"></div>
                    <div class="player-feedback" id="feedback-player-3"></div>
                </div>
            </div>
        </div>

        <div id="results">
            <h2>YarÄ±ÅŸma Bitti!</h2>
            <div id="final-scores"></div>
            <p id="winner-info"></p>
            <button id="restart-button">Yeni Oyun (Yeni Ä°simlerle)</button>
        </div>
    </div>

    <script src="questions.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- SORU HAVUZU & SEGMENTLER DIÅARIDAN questions.js'den GELÄ°YOR ---
            // Bu deÄŸiÅŸkenlerin (questionPool, quizSegments) questions.js iÃ§inde tanÄ±mlÄ± olduÄŸunu varsayÄ±yoruz.
            // questions.js iÃ§eriÄŸi matematik konularÄ± ve sorularÄ± ile gÃ¼ncellenmelidir.

            // --- Oyuncu Bilgileri ---
            const players = [
                { id: 1, name: "Oyuncu 1", age: 0, score: 0, answered: false, themeClass: '', currentQuestion: null },
                { id: 2, name: "Oyuncu 2", age: 0, score: 0, answered: false, themeClass: '', currentQuestion: null },
                { id: 3, name: "Oyuncu 3", age: 0, score: 0, answered: false, themeClass: '', currentQuestion: null }
            ];
            // --- DeÄŸiÅŸkenler ---
            let currentSegmentIndex = 0;
            let playersAnsweredCount = 0; // Bu deÄŸiÅŸkeni kullanmasak da kalabilir, checkRoundCompletion daha gÃ¼venilir.
            let askedQuestionIds = []; // Sorulan soru ID'lerini tut

            // --- Element ReferanslarÄ± ---
            const nameEntrySection = document.getElementById('name-entry');
            const confirmNamesButton = document.getElementById('confirm-names-button');
            const ttsSupportWarning = document.getElementById('tts-support-warning');
            const quizContent = document.getElementById('quiz-content');
            const narrationArea = document.getElementById('narration-area');
            const narrationInfo = document.getElementById('narration-info');
            const playNarrationButton = document.getElementById('play-narration-btn');
            const scoreboardElement = document.getElementById('scoreboard');
            const scoreboardListElement = document.getElementById('scoreboard-list');
            const playersArea = document.getElementById('players-area');
            const loadingIndicator = document.getElementById('loading-indicator');
            const resultsElement = document.getElementById('results');
            const finalScoresElement = document.getElementById('final-scores');
            const restartButton = document.getElementById('restart-button');
            const winnerInfoElement = document.getElementById('winner-info');
            const nameInputs = []; const ageInputs = []; const nameDisplays = []; const ageDisplays = [];
            const playerAreaElements = []; const playerQuestionElements = []; const playerOptionsElements = []; const playerFeedbackElements = [];

            for (let i = 1; i <= 3; i++) {
                nameInputs.push(document.getElementById(`player-${i}-name-input`));
                ageInputs.push(document.getElementById(`player-${i}-age-input`));
                nameDisplays.push(document.getElementById(`player-${i}-name-display`));
                ageDisplays.push(document.getElementById(`player-${i}-age-display`));
                playerAreaElements.push(document.getElementById(`player-area-${i}`));
                playerQuestionElements.push(document.getElementById(`question-player-${i}`));
                playerOptionsElements.push(document.getElementById(`options-player-${i}`));
                playerFeedbackElements.push(document.getElementById(`feedback-player-${i}`));
            }

             // --- Fonksiyonlar (shuffleArray, updateScoreboard, getThemeClass vb. - DeÄŸiÅŸiklik Yok) ---
             // Bu fonksiyonlar genel amaÃ§lÄ± olduÄŸu iÃ§in aynÄ± kalabilir.
             function shuffleArray(array) {
                  let currentIndex = array.length,  randomIndex;
                  while (currentIndex > 0) {
                      randomIndex = Math.floor(Math.random() * currentIndex);
                      currentIndex--;
                      [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
                  }
                  return array;
              }

              function updateScoreboard() {
                  scoreboardListElement.innerHTML = '';
                  const sortedByIdPlayers = [...players].sort((a, b) => a.id - b.id);
                  sortedByIdPlayers.forEach(player => {
                      // Sadece aktif (yaÅŸÄ± geÃ§erli) oyuncularÄ± skorbordda gÃ¶ster
                      if (player.age >= 7 && player.age <= 18) {
                          const listItem = document.createElement('li');
                          const nameSpan = `<span class="name ${player.themeClass}">${player.name}</span>`;
                          listItem.innerHTML = `${nameSpan}: <span class="score">${player.score} Puan</span>`;
                          scoreboardListElement.appendChild(listItem);
                      }
                  });
              }

              function getThemeClass(age) {
                  if (age >= 7 && age <= 10) return 'theme-child';
                  if (age >= 11 && age <= 14) return 'theme-teen';
                  if (age >= 15 && age <= 18) return 'theme-young-adult';
                  return 'theme-default'; // Gerekirse varsayÄ±lan tema
              }

             function getThemeBorderColorVar(themeClass) {
                  switch (themeClass) {
                      case 'theme-child': return 'var(--theme-child-border)';
                      case 'theme-teen': return 'var(--theme-teen-border)';
                      case 'theme-young-adult': return 'var(--theme-young-adult-border)';
                      default: return 'transparent'; // VarsayÄ±lan veya hata durumu
                  }
              }


             function loadSegment(segmentIndex) {
                 if ('speechSynthesis' in window && window.speechSynthesis.speaking) {
                      window.speechSynthesis.cancel();
                 }

                 if (segmentIndex >= quizSegments.length) {
                      showResults(); return;
                 }
                 currentSegmentIndex = segmentIndex;
                 const segmentData = quizSegments[segmentIndex];
                 // Oyuncu alanlarÄ±nÄ± gizle (animasyon iÃ§in opacity'yi sÄ±fÄ±rla)
                 playerAreaElements.forEach(el => {
                      if(el) el.classList.remove('visible');
                 });
                 // KÄ±sa bir gecikme sonrasÄ± display:none yapabiliriz ama genellikle opacity yeterli
                 playersArea.style.display = 'none'; // Flex'i kaldÄ±r


                 loadingIndicator.style.display = 'none';
                 narrationArea.style.display = 'block';
                 scoreboardElement.style.display = 'block';
                 // narrationTitle matematik konusuna gÃ¶re gÃ¼ncellenecektir (questions.js'den)
                 narrationInfo.textContent = `Segment ${segmentIndex + 1}: "${segmentData.narrationTitle}" konusunu dinlemek iÃ§in butona basÄ±n.`;
                 playNarrationButton.disabled = false;
                 playNarrationButton.textContent = "AnlatÄ±mÄ± Seslendir";

                 // Ã–nceki geri bildirimleri ve borderlarÄ± temizle
                 players.forEach(player => {
                      // Sadece aktif oyuncularÄ±n elementlerini temizle
                      if (player.age >= 7 && player.age <= 18) {
                          const feedbackEl = playerFeedbackElements[player.id-1];
                          const areaEl = playerAreaElements[player.id-1];
                          if(feedbackEl) feedbackEl.textContent = '';
                          if(areaEl) {
                              // JS ile border rengini sÄ±fÄ±rla
                              areaEl.style.borderTopColor = 'transparent';
                              areaEl.style.borderBottomColor = 'transparent';
                          }
                      }
                 });
                 updateScoreboard();
             }

             function handleNarrationEnd() {
                 console.log("Seslendirme bitti, sorular yÃ¼kleniyor...");
                 if(playNarrationButton) { // Buton varsa gÃ¼ncelle
                      playNarrationButton.textContent = "AnlatÄ±m Bitti";
                      playNarrationButton.disabled = true;
                 }
                 if(narrationArea) narrationArea.style.display = 'none';
                 if(loadingIndicator) loadingIndicator.style.display = 'block';

                 setTimeout(() => {
                      loadQuestionsForPlayers(currentSegmentIndex);
                      if(loadingIndicator) loadingIndicator.style.display = 'none';
                      if(playersArea) playersArea.style.display = 'flex'; // Flex'i tekrar etkinleÅŸtir
                      // Aktif oyuncu alanlarÄ±nÄ± animasyonla gÃ¶ster
                      players.forEach(player => {
                          if (player.age >= 7 && player.age <= 18) {
                              const areaEl = playerAreaElements[player.id - 1];
                              if(areaEl) areaEl.classList.add('visible');
                          }
                      });

                 }, 500);
             }


             function loadQuestionsForPlayers(segmentIdx) {
                 playersAnsweredCount = 0; // Teknik olarak kullanÄ±lmÄ±yor ama sÄ±fÄ±rlamak iyi pratik
                 let currentRoundSelectedIds = [];

                 // questions.js yÃ¼klenememe kontrolÃ¼
                 if (typeof quizSegments === 'undefined' || typeof questionPool === 'undefined') {
                      console.error("HATA: Soru verileri (questions.js) yÃ¼klenemedi!");
                      alert("Kritik Hata: Soru verileri yÃ¼klenemedi. LÃ¼tfen sayfayÄ± yenileyin ve questions.js dosyasÄ±nÄ±n index.html ile aynÄ± dizinde olduÄŸundan emin olun.");
                      resetToNameEntry(); // BaÅŸlangÄ±ca dÃ¶n
                      return;
                 }

                 players.forEach(player => {
                      // Sadece aktif oyuncular iÃ§in soru yÃ¼kle
                      if (!(player.age >= 7 && player.age <= 18)) {
                          player.answered = true; // Aktif olmayanlarÄ± cevaplamÄ±ÅŸ say
                          return; // Sonraki oyuncuya geÃ§
                      }

                      player.answered = false;
                      player.currentQuestion = null;
                      const optionsEl = playerOptionsElements[player.id-1];
                      const feedbackEl = playerFeedbackElements[player.id-1];
                      const questionEl = playerQuestionElements[player.id-1];
                      const sectionEl = playerAreaElements[player.id-1];

                      if (optionsEl) optionsEl.innerHTML = '';
                      if (feedbackEl) feedbackEl.textContent = '';
                      if (questionEl) questionEl.textContent = 'Soru aranÄ±yor...';
                      if (sectionEl) {
                          sectionEl.style.borderTopColor = 'transparent';
                          sectionEl.style.borderBottomColor = 'transparent';
                      }

                      // Matematik sorularÄ±nÄ± filtrele (segment, yaÅŸ, daha Ã¶nce sorulmamÄ±ÅŸ, bu turda seÃ§ilmemiÅŸ)
                      const suitableQuestions = questionPool.filter(q =>
                          q.segmentId === quizSegments[segmentIdx].segmentId &&
                          player.age >= q.minAge &&
                          player.age <= q.maxAge &&
                          !askedQuestionIds.includes(q.questionId) &&
                          !currentRoundSelectedIds.includes(q.questionId)
                      );

                      let questionData = null;
                      if (suitableQuestions.length > 0) {
                          questionData = suitableQuestions[Math.floor(Math.random() * suitableQuestions.length)];
                          player.currentQuestion = questionData;
                          askedQuestionIds.push(questionData.questionId);
                          currentRoundSelectedIds.push(questionData.questionId);

                          if (questionEl) questionEl.textContent = questionData.questionText;
                          if (optionsEl) {
                              const shuffledOptions = shuffleArray([...questionData.options]);
                              shuffledOptions.forEach(option => {
                                  const button = document.createElement('button');
                                  button.textContent = option;
                                  button.onclick = () => handleAnswer(player.id, option);
                                  optionsEl.appendChild(button);
                              });
                          }
                      } else {
                          if (questionEl) questionEl.textContent = 'Size uygun soru bulunamadÄ±.';
                          player.answered = true; // Soru bulunamayan da cevaplamÄ±ÅŸ sayÄ±lÄ±r
                      }
                 });

                 // Turun bitip bitmediÄŸini kontrol et (sadece aktif oyunculara gÃ¶re)
                 checkRoundCompletion();
             }

             // Yeni fonksiyon: Aktif oyuncularÄ±n hepsinin cevaplayÄ±p cevaplamadÄ±ÄŸÄ±nÄ± kontrol eder
             function checkRoundCompletion() {
                  const activePlayers = players.filter(p => p.age >= 7 && p.age <= 18);
                  const allActiveAnswered = activePlayers.every(p => p.answered);

                  // EÄŸer aktif oyuncu yoksa veya hepsi cevapladÄ±ysa (veya soru bulamadÄ±ysa)
                  if (activePlayers.length === 0 || allActiveAnswered) {
                      console.log("Tur tamamlandÄ± (aktif oyunculara gÃ¶re), sonraki segmente geÃ§iliyor.");
                      if(loadingIndicator) loadingIndicator.style.display = 'block';
                      // Oyuncu alanlarÄ±nÄ± animasyonla gizle
                      playerAreaElements.forEach(el => {
                          if(el) el.classList.remove('visible');
                      });
                      // Gecikmeli olarak display:none yap ve sonraki segmenti yÃ¼kle
                      setTimeout(() => {
                          if(playersArea) playersArea.style.display = 'none';
                          loadSegment(currentSegmentIndex + 1);
                      }, 1800); // Geri bildirimi gÃ¶rmek iÃ§in bekleme sÃ¼resi
                  }
             }


             function handleAnswer(playerId, selectedOption) {
                 const player = players.find(p => p.id === playerId);
                 if (!player || player.answered || !player.currentQuestion || !(player.age >= 7 && player.age <= 18)) return; // Sadece aktif oyuncular cevaplayabilir

                 player.answered = true;

                 const feedbackEl = playerFeedbackElements[player.id - 1];
                 const sectionEl = playerAreaElements[player.id - 1];
                 const playerOptionButtons = playerOptionsElements[player.id - 1]?.getElementsByTagName('button'); // Null check

                 if (!feedbackEl || !sectionEl || !playerOptionButtons) {
                     console.error(`Oyuncu ${playerId} iÃ§in UI elementleri bulunamadÄ±.`);
                     return;
                 }

                 for (let btn of playerOptionButtons) {
                     btn.disabled = true;
                     if (btn.textContent !== selectedOption) {
                          btn.style.opacity = '0.6';
                     }
                 }

                 const correctBorderColor = getThemeBorderColorVar(player.themeClass);
                 const incorrectBorderColor = 'var(--incorrect-border)'; // CSS'de tanÄ±mlÄ± olmalÄ±

                 if (selectedOption === player.currentQuestion.correctAnswer) {
                     player.score++;
                     feedbackEl.textContent = "DoÄŸru!";
                     feedbackEl.className = 'player-feedback feedback-correct';
                      sectionEl.style.borderTopColor = correctBorderColor;
                      sectionEl.style.borderBottomColor = correctBorderColor;

                 } else {
                     feedbackEl.textContent = `YanlÄ±ÅŸ! DoÄŸru: ${player.currentQuestion.correctAnswer}`;
                     feedbackEl.className = 'player-feedback feedback-incorrect';
                      sectionEl.style.borderTopColor = incorrectBorderColor;
                      sectionEl.style.borderBottomColor = incorrectBorderColor;
                 }

                 updateScoreboard();
                 checkRoundCompletion(); // Her cevaptan sonra turun bitip bitmediÄŸini kontrol et
             }


             function showResults() {
                  if ('speechSynthesis' in window && window.speechSynthesis.speaking) {
                      window.speechSynthesis.cancel();
                  }
                  if(quizContent) quizContent.style.display = 'none';
                  if(resultsElement) resultsElement.style.display = 'block';
                  if(finalScoresElement) finalScoresElement.innerHTML = '';
                  let maxScore = -1;
                  let winners = [];

                  // Sadece aktif oyuncularÄ± sÄ±rala ve gÃ¶ster
                  const activePlayers = players.filter(p => p.age >= 7 && p.age <= 18);
                  const sortedPlayers = [...activePlayers].sort((a, b) => b.score - a.score);

                  if (sortedPlayers.length === 0) {
                      if(winnerInfoElement) winnerInfoElement.textContent = "YarÄ±ÅŸmaya katÄ±lan geÃ§erli oyuncu bulunamadÄ±.";
                      return;
                  }

                  sortedPlayers.forEach(player => {
                      const resultLine = document.createElement('div');
                      resultLine.classList.add('result-line');
                      resultLine.innerHTML = `<span class="name ${player.themeClass}">${player.name} (${player.age} yaÅŸ)</span> <span class="score">${player.score} Puan</span>`;
                      if(finalScoresElement) finalScoresElement.appendChild(resultLine);

                      if (player.score > maxScore) {
                          maxScore = player.score;
                          winners = [player.name];
                      } else if (player.score === maxScore && maxScore >= 0) { // Sadece 0 veya daha yÃ¼ksek skorlarda beraberlik olur
                          winners.push(player.name);
                      }
                  });

                  if(winnerInfoElement){
                       if (maxScore <= 0 && winners.length === 0 && sortedPlayers.length > 0) { // EÄŸer oyuncu var ama kimse puan alamadÄ±ysa
                            winnerInfoElement.textContent = "Kimse puan alamadÄ±!";
                       } else if (maxScore <= 0 && winners.length > 0) { // EÄŸer 0 puanla kazanan(lar) varsa
                           if (winners.length > 1) {
                               winnerInfoElement.textContent = `ğŸ† Kazananlar (Berabere - 0 Puan): ${winners.join(', ')}! ğŸ‰`;
                           } else {
                               winnerInfoElement.textContent = `ğŸ† Kazanan (0 Puan): ${winners[0]}! ğŸ‰`;
                           }
                       } else if (winners.length > 1) {
                           winnerInfoElement.textContent = `ğŸ† Kazananlar (Berabere): ${winners.join(', ')} (${maxScore} puan)! ğŸ‰`;
                       } else {
                           winnerInfoElement.textContent = `ğŸ† Kazanan: ${winners[0]} (${maxScore} puan)! ğŸ‰`;
                       }
                  }
             }


             function initializeQuiz() {
                  let allAgesValid = true;
                  let playerCount = 0; // Girilen ve potansiyel olarak geÃ§erli oyuncu sayÄ±sÄ±

                  players.forEach((player, index) => {
                      const nameInput = nameInputs[index];
                      const ageInput = ageInputs[index];
                      const areaEl = playerAreaElements[player.id - 1]; // AlanÄ± al

                      if (!nameInput || !ageInput) {
                          console.error(`Oyuncu ${index + 1} iÃ§in input elementleri bulunamadÄ±.`);
                          if(areaEl) areaEl.style.display = 'none'; // Hata varsa alanÄ± gizle
                          return;
                      }

                      const name = nameInput.value.trim();
                      const ageString = ageInput.value;

                      // Oyuncu slotu boÅŸsa veya sadece boÅŸluk girilmiÅŸse
                      if (name === '' && ageString === '') {
                          player.age = 0; // YaÅŸÄ± sÄ±fÄ±rla (aktif deÄŸil)
                          player.score = 0;
                          player.themeClass = '';
                          if (areaEl) areaEl.style.display = 'none'; // AlanÄ± gizle
                          return; // Sonraki oyuncuya geÃ§
                      }

                      // Ä°sim veya yaÅŸ girilmiÅŸse, geÃ§erli bir oyuncu adayÄ±dÄ±r
                      playerCount++;
                      player.name = name === '' ? `Oyuncu ${player.id}` : name;
                      const age = parseInt(ageString);

                      if (isNaN(age) || age < 7 || age > 18) {
                          alert(`Oyuncu "${player.name}" iÃ§in geÃ§erli bir yaÅŸ (7-18 arasÄ±) girmelisiniz veya alanÄ± boÅŸ bÄ±rakmalÄ±sÄ±nÄ±z.`);
                          ageInput.style.border = '2px solid red';
                          allAgesValid = false;
                          player.age = 0; // GeÃ§ersiz yaÅŸ, oyuncu aktif deÄŸil
                          if (areaEl) areaEl.style.display = 'flex'; // Hata olsa da alanÄ± gÃ¶sterelim ki input gÃ¶rÃ¼nsÃ¼n
                      } else {
                          player.age = age; // GeÃ§erli yaÅŸ
                          player.themeClass = getThemeClass(age);
                          ageInput.style.border = ''; // Hata iÅŸaretini kaldÄ±r
                           if (areaEl) areaEl.style.display = 'flex'; // GeÃ§erli oyuncu, alanÄ± gÃ¶ster
                      }
                      // BaÅŸlangÄ±Ã§ skorlarÄ± ve durumlarÄ± sÄ±fÄ±rla
                      player.score = 0;
                      player.answered = false;
                      player.currentQuestion = null;
                  });

                  // GeÃ§erli yaÅŸ girmiÅŸ en az bir oyuncu var mÄ± kontrolÃ¼
                  const validPlayerCount = players.filter(p => p.age >= 7 && p.age <= 18).length;

                  // YaÅŸlarda hata varsa veya hiÃ§ geÃ§erli oyuncu girilmemiÅŸse baÅŸlatma
                  if (!allAgesValid || validPlayerCount === 0) {
                       if (validPlayerCount === 0 && allAgesValid && playerCount > 0) alert("LÃ¼tfen en az bir oyuncu iÃ§in geÃ§erli bir yaÅŸ (7-18) girin.");
                       else if (validPlayerCount === 0 && playerCount === 0) alert("LÃ¼tfen en az bir oyuncu iÃ§in isim ve yaÅŸ girin.");
                      return; // BaÅŸlatma
                   }


                  // GeÃ§erli oyuncularÄ±n UI'larÄ±nÄ± gÃ¼ncelle (isim, yaÅŸ, tema class)
                  players.forEach((player) => {
                        if (player.age >= 7 && player.age <= 18) { // Sadece aktif oyuncular
                            const areaEl = playerAreaElements[player.id - 1];
                            const nameEl = nameDisplays[player.id - 1];
                            const ageEl = ageDisplays[player.id - 1];

                            if (areaEl) {
                                // className'i doÄŸrudan ayarlamak daha temiz olabilir
                                areaEl.className = `player-quiz-area ${player.themeClass}`; // Ã–nceki classlarÄ± temizler
                                areaEl.style.display = 'flex'; // Emin olmak iÃ§in tekrar gÃ¶ster
                                areaEl.style.borderTopColor = 'transparent';
                                areaEl.style.borderBottomColor = 'transparent';
                            } else { console.error(`player-area-${player.id} bulunamadÄ±`); }

                            if (nameEl) { nameEl.textContent = player.name; }
                            else { console.error(`player-${player.id}-name-display bulunamadÄ±`); }

                            if (ageEl) { ageEl.textContent = `(${player.age} yaÅŸ)`; }
                            else { console.error(`player-${player.id}-age-display bulunamadÄ±`); }
                        } else {
                             // Aktif olmayan oyuncularÄ±n alanlarÄ±nÄ± gizle
                             const areaEl = playerAreaElements[player.id - 1];
                             if (areaEl) areaEl.style.display = 'none';
                        }
                  });


                  if(nameEntrySection) nameEntrySection.style.display = 'none';
                  if(resultsElement) resultsElement.style.display = 'none';
                  if(quizContent) quizContent.style.display = 'block';
                  startQuiz(); // YarÄ±ÅŸmayÄ± baÅŸlat
             }


             function startQuiz() {
                  askedQuestionIds = [];
                  currentSegmentIndex = 0;
                  // Skorlar initializeQuiz'da sÄ±fÄ±rlandÄ±
                  updateScoreboard(); // BaÅŸlangÄ±Ã§ skorbordunu gÃ¶ster (sadece aktif oyuncularla)
                  loadSegment(currentSegmentIndex);
             }

             function resetToNameEntry() {
                  if ('speechSynthesis' in window && window.speechSynthesis.speaking) {
                      window.speechSynthesis.cancel();
                  }
                  if(quizContent) quizContent.style.display = 'none';
                  if(resultsElement) resultsElement.style.display = 'none';
                  if(nameEntrySection) nameEntrySection.style.display = 'flex'; // Tekrar flex yapalÄ±m

                   // InputlarÄ± temizle, borderlarÄ± sÄ±fÄ±rla
                   nameInputs.forEach(input => { if(input) input.value = ''; });
                   ageInputs.forEach(input => { if(input) { input.value = ''; input.style.border = ''; } });

                   // BaÅŸlangÄ±Ã§ta oyuncu alanlarÄ±nÄ± gÃ¶sterme, initializeQuiz karar versin
                   playerAreaElements.forEach(el => { if(el) el.style.display = 'flex'; }); // Inputlar gÃ¶rÃ¼nsÃ¼n diye flex yapalÄ±m
                   // Skorbordu temizle ve gizle
                   if(scoreboardListElement) scoreboardListElement.innerHTML = '';
                   if(scoreboardElement) scoreboardElement.style.display = 'none';

                  checkTtsSupport(); // TTS desteÄŸini kontrol et ve uyarÄ±yÄ± ayarla
             }

             function checkTtsSupport() {
                 const hasTts = 'speechSynthesis' in window && window.speechSynthesis;
                 const warningEl = document.getElementById('tts-support-warning');
                 if (warningEl) {
                      warningEl.style.display = hasTts ? 'none' : 'block';
                 }
                 // Oynatma butonu baÅŸlangÄ±Ã§ta etkin olmalÄ± (eÄŸer varsa)
                 if (playNarrationButton) {
                      playNarrationButton.disabled = false;
                      playNarrationButton.textContent = "AnlatÄ±mÄ± Seslendir";
                 }
             }

            // --- Olay Dinleyicileri ---
             if (confirmNamesButton) {
                  confirmNamesButton.addEventListener('click', initializeQuiz);
             } else { console.error("confirm-names-button bulunamadÄ±!"); }

             if (restartButton) {
                  restartButton.addEventListener('click', resetToNameEntry);
             } else { console.error("restart-button bulunamadÄ±!"); }

             if (playNarrationButton) {
                  playNarrationButton.addEventListener('click', () => {
                      if (!('speechSynthesis' in window) || !window.speechSynthesis) {
                          alert("TarayÄ±cÄ±nÄ±z metin seslendirme Ã¶zelliÄŸini desteklemiyor.");
                          handleNarrationEnd(); // Destek yoksa direkt sorulara geÃ§
                          return;
                      }
                       window.speechSynthesis.cancel(); // Ã–nceki konuÅŸmayÄ± durdur

                       // Segment verisi kontrolÃ¼
                      if (typeof quizSegments === 'undefined' || !quizSegments[currentSegmentIndex] || !quizSegments[currentSegmentIndex].narrationText) {
                           console.error("Seslendirilecek metin bulunamadÄ± veya segment verisi eksik!");
                           alert("Seslendirilecek anlatÄ±m metni bulunamadÄ±!");
                           handleNarrationEnd(); // Hata olsa bile sorulara geÃ§meyi dene
                           return;
                       }
                       const segmentData = quizSegments[currentSegmentIndex];
                       const utterance = new SpeechSynthesisUtterance(segmentData.narrationText);
                       utterance.lang = 'tr-TR'; utterance.rate = 0.9; utterance.pitch = 1;

                       utterance.onend = handleNarrationEnd; // Bitince sorularÄ± yÃ¼kle
                       utterance.onerror = (event) => {
                           console.error('TTS HatasÄ±:', event);
                           alert(`Seslendirme sÄ±rasÄ±nda bir hata oluÅŸtu: ${event.error}. Sorulara devam edilecek.`);
                           playNarrationButton.textContent = "Hata!";
                           playNarrationButton.disabled = false; // Tekrar denenebilir? Ya da direkt geÃ§meli.
                           handleNarrationEnd(); // Hata olsa bile sorularÄ± yÃ¼kle
                       };

                       playNarrationButton.disabled = true; playNarrationButton.textContent = "Seslendiriliyor...";
                       window.speechSynthesis.speak(utterance);
                  });
             } else { console.error("play-narration-btn bulunamadÄ±!"); }


            // --- BaÅŸlangÄ±Ã§ ---
             if (typeof quizSegments === 'undefined' || typeof questionPool === 'undefined') {
                  console.error("HATA: Soru verileri (questions.js) yÃ¼klenemedi! Uygulama baÅŸlatÄ±lamÄ±yor.");
                  const container = document.getElementById('quiz-container');
                  if(container) {
                      container.innerHTML = `<h1>Hata!</h1><p>YarÄ±ÅŸma verileri yÃ¼klenemedi. LÃ¼tfen 'questions.js' dosyasÄ±nÄ±n 'index.html' ile aynÄ± klasÃ¶rde olduÄŸundan emin olun ve sayfayÄ± yenileyin.</p>`;
                      container.style.color = 'red'; container.style.textAlign = 'center';
                  }
             } else {
                  resetToNameEntry(); // Uygulama baÅŸlangÄ±Ã§ noktasÄ±
             }

        }); // DOMContentLoaded Sonu
    </script>

</body>
</html>
