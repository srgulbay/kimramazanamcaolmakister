<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ramazanamca Matematik Bilgi Yarışması</title>
    <link rel="stylesheet" href="styles.css">
    </head>
<body>
    <div id="quiz-container">
        <h1>Ramazanamca Matematik Bilgi Yarışması </h1>

        <div id="name-entry">
            <div class="player-input-group">
                <label for="player-1-name-input">Oyuncu 1 Adı:</label>
                <input type="text" id="player-1-name-input" placeholder="İsim..." maxlength="20">
                <label for="player-1-age-input">Yaşı (7-18):</label>
                <input type="number" id="player-1-age-input" min="7" max="18" placeholder="Yaş...">
            </div>
            <div class="player-input-group">
                <label for="player-2-name-input">Oyuncu 2 Adı:</label>
                <input type="text" id="player-2-name-input" placeholder="İsim..." maxlength="20">
                <label for="player-2-age-input">Yaşı (7-18):</label>
                <input type="number" id="player-2-age-input" min="7" max="18" placeholder="Yaş...">
            </div>
            <div class="player-input-group">
                <label for="player-3-name-input">Oyuncu 3 Adı:</label>
                <input type="text" id="player-3-name-input" placeholder="İsim..." maxlength="20">
                <label for="player-3-age-input">Yaşı (7-18):</label>
                <input type="number" id="player-3-age-input" min="7" max="18" placeholder="Yaş...">
            </div>
            <div id="confirm-container">
                <button id="confirm-names-button">Yarışmayı Başlat</button>
            </div>
            <p id="tts-support-warning" style="color: red; width: 100%; text-align: center; margin-top: 10px; display: none;">Tarayıcınız metin seslendirme özelliğini desteklemiyor olabilir. Anlatım seslendirilemeyecek.</p>
        </div>

        <div id="quiz-content">
            <div id="narration-area" style="display: none;">
                <p id="narration-info">Şimdi dikkatle dinleyin...</p>
                <button id="play-narration-btn">Anlatımı Seslendir</button>
            </div>
            <div id="loading-indicator">Sıradaki sorular hazırlanıyor...</div>
            <div id="scoreboard" style="display: none;">
                <h3>Skor Tablosu</h3>
                <ul id="scoreboard-list"></ul>
            </div>
            <div id="players-area">
                <div class="player-quiz-area" id="player-area-1">
                    <div class="player-info">
                        <span class="player-name" id="player-1-name-display">Oyuncu 1</span>
                        <span class="player-age" id="player-1-age-display">(Yaş)</span>
                    </div>
                    <div class="player-question" id="question-player-1">Soru yükleniyor...</div>
                    <div class="player-options" id="options-player-1"></div>
                    <div class="player-feedback" id="feedback-player-1"></div>
                </div>
                <div class="player-quiz-area" id="player-area-2">
                    <div class="player-info">
                         <span class="player-name" id="player-2-name-display">Oyuncu 2</span>
                         <span class="player-age" id="player-2-age-display">(Yaş)</span>
                    </div>
                    <div class="player-question" id="question-player-2">Soru yükleniyor...</div>
                    <div class="player-options" id="options-player-2"></div>
                    <div class="player-feedback" id="feedback-player-2"></div>
                </div>
                <div class="player-quiz-area" id="player-area-3">
                    <div class="player-info">
                        <span class="player-name" id="player-3-name-display">Oyuncu 3</span>
                        <span class="player-age" id="player-3-age-display">(Yaş)</span>
                    </div>
                    <div class="player-question" id="question-player-3">Soru yükleniyor...</div>
                    <div class="player-options" id="options-player-3"></div>
                    <div class="player-feedback" id="feedback-player-3"></div>
                </div>
            </div>
        </div>

        <div id="results">
            <h2>Yarışma Bitti!</h2>
            <div id="final-scores"></div>
            <p id="winner-info"></p>
            <button id="restart-button">Yeni Oyun (Yeni İsimlerle)</button>
        </div>
    </div>

    <script src="questions.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- SORU HAVUZU & SEGMENTLER DIŞARIDAN questions.js'den GELİYOR ---
            if (typeof questionPool === 'undefined' || typeof quizSegments === 'undefined') {
                 console.error("CRITICAL ERROR: questions.js could not be loaded or is missing data.");
                 // Kullanıcıya daha görünür bir hata mesajı gösterilebilir
                 const container = document.getElementById('quiz-container');
                 if (container) {
                    container.innerHTML = `<h1>Hata!</h1><p>Yarışma verileri (questions.js) yüklenemedi. Lütfen dosyanın doğru yerde olduğundan ve içeriğinin geçerli olduğundan emin olun. Sayfayı yenilemeyi deneyin.</p>`;
                    container.style.color = 'red';
                    container.style.textAlign = 'center';
                 }
                 return; // Hata durumunda scriptin geri kalanını çalıştırma
             }

            // --- Oyuncu Bilgileri ---
            const players = [
                { id: 1, name: "Oyuncu 1", age: 0, score: 0, answered: false, themeClass: '', currentQuestion: null },
                { id: 2, name: "Oyuncu 2", age: 0, score: 0, answered: false, themeClass: '', currentQuestion: null },
                { id: 3, name: "Oyuncu 3", age: 0, score: 0, answered: false, themeClass: '', currentQuestion: null }
            ];
            // --- Değişkenler ---
            let currentSegmentIndex = 0;
            let askedQuestionIds = []; // Sorulan soru ID'lerini tut

            // --- Element Referansları ---
            const nameEntrySection = document.getElementById('name-entry');
            const confirmNamesButton = document.getElementById('confirm-names-button');
            const ttsSupportWarning = document.getElementById('tts-support-warning');
            const quizContent = document.getElementById('quiz-content');
            const narrationArea = document.getElementById('narration-area');
            const narrationInfo = document.getElementById('narration-info');
            const playNarrationButton = document.getElementById('play-narration-btn');
            const scoreboardElement = document.getElementById('scoreboard');
            const scoreboardListElement = document.getElementById('scoreboard-list');
            const playersArea = document.getElementById('players-area');
            const loadingIndicator = document.getElementById('loading-indicator');
            const resultsElement = document.getElementById('results');
            const finalScoresElement = document.getElementById('final-scores');
            const restartButton = document.getElementById('restart-button');
            const winnerInfoElement = document.getElementById('winner-info');
            const nameInputs = []; const ageInputs = []; const nameDisplays = []; const ageDisplays = [];
            const playerAreaElements = []; const playerQuestionElements = []; const playerOptionsElements = []; const playerFeedbackElements = [];

            for (let i = 1; i <= 3; i++) {
                // Elementlerin varlığını kontrol etmek iyi bir pratik olabilir ama şimdilik varsayalım.
                nameInputs.push(document.getElementById(`player-${i}-name-input`));
                ageInputs.push(document.getElementById(`player-${i}-age-input`));
                nameDisplays.push(document.getElementById(`player-${i}-name-display`));
                ageDisplays.push(document.getElementById(`player-${i}-age-display`));
                playerAreaElements.push(document.getElementById(`player-area-${i}`));
                playerQuestionElements.push(document.getElementById(`question-player-${i}`));
                playerOptionsElements.push(document.getElementById(`options-player-${i}`));
                playerFeedbackElements.push(document.getElementById(`feedback-player-${i}`));
            }

             // --- Yardımcı Fonksiyonlar ---
             function shuffleArray(array) {
                  let currentIndex = array.length,  randomIndex;
                  while (currentIndex > 0) {
                      randomIndex = Math.floor(Math.random() * currentIndex);
                      currentIndex--;
                      [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
                  }
                  return array;
              }

             function getThemeClass(age) {
                  if (age >= 7 && age <= 10) return 'theme-child';
                  if (age >= 11 && age <= 14) return 'theme-teen';
                  if (age >= 15 && age <= 18) return 'theme-young-adult';
                  return 'theme-default';
              }

              // Skor tablosunu güncelleme fonksiyonu (CSS uyumlu)
              function updateScoreboard() {
                  scoreboardListElement.innerHTML = '';
                  const sortedByIdPlayers = [...players].sort((a, b) => a.id - b.id);
                  sortedByIdPlayers.forEach(player => {
                      if (player.age >= 7 && player.age <= 18) {
                          const listItem = document.createElement('li');
                          // **DÜZELTME:** Tema sınıfını doğrudan li elementine ekle
                          listItem.classList.add(player.themeClass);

                          // Önceki skoru kontrol etmek için bir data attribute ekleyebiliriz (animasyon için)
                          const currentScore = player.score;
                          const prevScore = parseInt(listItem.dataset.prevScore || '0');
                          if (currentScore > prevScore) {
                              listItem.classList.add('score-update-animation');
                              // Animasyon bittikten sonra sınıfı kaldırmak iyi olabilir
                              listItem.addEventListener('animationend', () => {
                                  listItem.classList.remove('score-update-animation');
                              }, { once: true });
                          }
                          listItem.dataset.prevScore = currentScore;

                          // İçeriği ayarla
                          const nameSpan = `<span class="name">${player.name}</span>`; // span içinden tema sınıfı kaldırıldı
                          listItem.innerHTML = `${nameSpan}: <span class="score">${currentScore} Puan</span>`;
                          scoreboardListElement.appendChild(listItem);
                      }
                  });
              }

              // --- Quiz Akış Fonksiyonları ---

              function loadSegment(segmentIndex) {
                  if ('speechSynthesis' in window && window.speechSynthesis.speaking) {
                       window.speechSynthesis.cancel();
                  }

                  if (segmentIndex >= quizSegments.length) {
                       showResults(); return;
                  }
                  currentSegmentIndex = segmentIndex;
                  const segmentData = quizSegments[segmentIndex];

                  // Oyuncu alanlarını gizle ve sıfırla
                  playerAreaElements.forEach((el, index) => {
                      if(el) {
                          el.classList.remove('visible', 'answered-correct', 'answered-incorrect');
                          // Tema sınıfı initializeQuiz'de eklendiği için burada tekrar eklemeye gerek yok
                          // Alt ve üst border renkleri tema class'ı ve answered-* class'ları ile CSS'de yönetiliyor.
                          const feedbackEl = playerFeedbackElements[index];
                          if(feedbackEl) feedbackEl.textContent = '';
                      }
                  });
                  playersArea.style.display = 'none';

                  loadingIndicator.style.display = 'none';
                  narrationArea.style.display = 'block';
                  scoreboardElement.style.display = 'block';
                  narrationInfo.textContent = `Segment ${segmentIndex + 1}: "${segmentData.narrationTitle}" konusunu dinlemek için butona basın.`;
                  playNarrationButton.disabled = false;
                  playNarrationButton.textContent = "Anlatımı Seslendir";

                  updateScoreboard(); // Her segment başında skor tablosunu güncelle
              }

             function handleNarrationEnd() {
                  console.log("Seslendirme bitti, sorular yükleniyor...");
                  if(playNarrationButton) {
                       playNarrationButton.textContent = "Anlatım Bitti";
                       playNarrationButton.disabled = true;
                  }
                  if(narrationArea) narrationArea.style.display = 'none';
                  if(loadingIndicator) loadingIndicator.style.display = 'block';

                  setTimeout(() => {
                       loadQuestionsForPlayers(currentSegmentIndex);
                       if(loadingIndicator) loadingIndicator.style.display = 'none';
                       if(playersArea) playersArea.style.display = 'flex';
                       // Aktif oyuncu alanlarını animasyonla göster
                       players.forEach(player => {
                           if (player.age >= 7 && player.age <= 18) {
                               const areaEl = playerAreaElements[player.id - 1];
                               if(areaEl) areaEl.classList.add('visible');
                           }
                       });
                  }, 500); // Kısa bir bekleme süresi
              }

             function loadQuestionsForPlayers(segmentIdx) {
                  let currentRoundSelectedIds = [];

                  players.forEach(player => {
                       const playerIndex = player.id - 1;
                       const areaEl = playerAreaElements[playerIndex];
                       const optionsEl = playerOptionsElements[playerIndex];
                       const feedbackEl = playerFeedbackElements[playerIndex];
                       const questionEl = playerQuestionElements[playerIndex];

                       // Sadece aktif oyuncular için işlem yap
                       if (!(player.age >= 7 && player.age <= 18)) {
                           player.answered = true; // Aktif olmayanları cevaplamış say
                           if(areaEl) areaEl.style.display = 'none'; // Alanını gizle
                           return;
                       }

                       player.answered = false;
                       player.currentQuestion = null;

                       // Önceki turdan kalan sınıfları temizle
                       if(areaEl) areaEl.classList.remove('answered-correct', 'answered-incorrect');
                       if(optionsEl) optionsEl.innerHTML = ''; // Seçenekleri temizle (butonları yeniden oluşturacağız)
                       if(feedbackEl) feedbackEl.textContent = '';
                       if(questionEl) questionEl.textContent = 'Soru aranıyor...';
                       if(areaEl && areaEl.style.display === 'none') areaEl.style.display = 'flex'; // Alanın görünür olduğundan emin ol

                       // Uygun soruları filtrele
                       const suitableQuestions = questionPool.filter(q =>
                           q.segmentId === quizSegments[segmentIdx].segmentId &&
                           player.age >= q.minAge &&
                           player.age <= q.maxAge &&
                           !askedQuestionIds.includes(q.questionId) &&
                           !currentRoundSelectedIds.includes(q.questionId)
                       );

                       let questionData = null;
                       if (suitableQuestions.length > 0) {
                           questionData = suitableQuestions[Math.floor(Math.random() * suitableQuestions.length)];
                           player.currentQuestion = questionData;
                           askedQuestionIds.push(questionData.questionId);
                           currentRoundSelectedIds.push(questionData.questionId);

                           if (questionEl) questionEl.textContent = questionData.questionText;
                           if (optionsEl) {
                               const shuffledOptions = shuffleArray([...questionData.options]);
                               shuffledOptions.forEach(option => {
                                   const button = document.createElement('button');
                                   button.textContent = option;
                                   button.onclick = () => handleAnswer(player.id, option, button); // Buton referansını da gönder
                                   optionsEl.appendChild(button);
                               });
                           }
                       } else {
                           if (questionEl) questionEl.textContent = 'Size uygun soru bulunamadı.';
                           player.answered = true; // Soru bulunamayan da cevaplamış sayılır
                       }
                  });

                  checkRoundCompletion(); // Sorular yüklendikten sonra kontrol et
             }

             // Turun tamamlanıp tamamlanmadığını kontrol etme fonksiyonu
             function checkRoundCompletion() {
                  const activePlayers = players.filter(p => p.age >= 7 && p.age <= 18);
                  const allActiveAnswered = activePlayers.every(p => p.answered);

                  if (activePlayers.length === 0 || allActiveAnswered) {
                      console.log("Tur tamamlandı, sonraki segmente geçiliyor.");
                      if(loadingIndicator) loadingIndicator.style.display = 'block';
                      playerAreaElements.forEach(el => {
                          if(el) el.classList.remove('visible'); // Animasyonla gizle
                      });
                      setTimeout(() => {
                          if(playersArea) playersArea.style.display = 'none';
                          loadSegment(currentSegmentIndex + 1);
                      }, 1800); // Geri bildirimi görmek için bekleme süresi
                  }
             }

            // Cevap işleme fonksiyonu (CSS uyumlu)
            function handleAnswer(playerId, selectedOption, clickedButton) {
                 const player = players.find(p => p.id === playerId);
                 if (!player || player.answered || !player.currentQuestion || !(player.age >= 7 && player.age <= 18)) return;

                 player.answered = true;

                 const playerIndex = player.id - 1;
                 const feedbackEl = playerFeedbackElements[playerIndex];
                 const sectionEl = playerAreaElements[playerIndex];
                 const optionsContainer = playerOptionsElements[playerIndex];
                 const playerOptionButtons = optionsContainer?.getElementsByTagName('button');

                 if (!feedbackEl || !sectionEl || !optionsContainer || !playerOptionButtons) {
                     console.error(`Oyuncu ${playerId} için UI elementleri bulunamadı.`);
                     checkRoundCompletion(); // Hata olsa bile turu bitirme kontrolü yap
                     return;
                 }

                 const isCorrect = (selectedOption === player.currentQuestion.correctAnswer);
                 const correctAnswerText = player.currentQuestion.correctAnswer;

                 // Tüm butonları devre dışı bırak
                 for (let btn of playerOptionButtons) {
                     btn.disabled = true;
                     // Tıklanan butonu işaretle
                     if (btn === clickedButton) {
                         btn.classList.add(isCorrect ? 'selected-correct' : 'selected-incorrect');
                     }
                     // Eğer yanlış cevap verildiyse ve bu buton doğru cevap ise, onu da işaretle
                     if (!isCorrect && btn.textContent === correctAnswerText) {
                         btn.classList.add('reveal-correct');
                     }
                     // Diğer butonları biraz soldur (isteğe bağlı)
                     if (btn !== clickedButton && btn.textContent !== correctAnswerText) {
                        // btn.style.opacity = '0.6'; // CSS zaten disabled stili veriyor, bu gerekmeyebilir
                     }
                 }

                 // Geri bildirim metnini ve alanın alt border class'ını ayarla
                 if (isCorrect) {
                     player.score++;
                     feedbackEl.textContent = "Doğru!";
                     feedbackEl.className = 'player-feedback feedback-correct';
                     sectionEl.classList.add('answered-correct');
                 } else {
                     feedbackEl.textContent = `Yanlış! Doğru: ${correctAnswerText}`;
                     feedbackEl.className = 'player-feedback feedback-incorrect';
                     sectionEl.classList.add('answered-incorrect');
                 }

                 updateScoreboard(); // Skoru güncelle (ve animasyonu tetikle)
                 checkRoundCompletion(); // Turun bitip bitmediğini kontrol et
            }


            // Sonuçları gösterme fonksiyonu (CSS uyumlu)
            function showResults() {
                 if ('speechSynthesis' in window && window.speechSynthesis.speaking) {
                     window.speechSynthesis.cancel();
                 }
                 if(quizContent) quizContent.style.display = 'none';
                 if(resultsElement) resultsElement.style.display = 'block';
                 if(finalScoresElement) finalScoresElement.innerHTML = '';
                 let maxScore = -1;
                 let winners = [];

                 const activePlayers = players.filter(p => p.age >= 7 && p.age <= 18);
                 if (activePlayers.length === 0) {
                     if(winnerInfoElement) winnerInfoElement.textContent = "Yarışmaya katılan geçerli oyuncu bulunamadı.";
                     // Sonuç listesini boş bırak
                      if(finalScoresElement) finalScoresElement.innerHTML = '<p style="text-align: center; color: grey;">Gösterilecek skor yok.</p>';
                     return;
                 }

                 const sortedPlayers = [...activePlayers].sort((a, b) => b.score - a.score);

                 sortedPlayers.forEach(player => {
                     const resultLine = document.createElement('div');
                     resultLine.classList.add('result-line');
                     // **DÜZELTME:** Sonuç satırına tema sınıfını ekle
                     resultLine.classList.add(player.themeClass);

                     resultLine.innerHTML = `<span class="name">${player.name} (${player.age} yaş)</span> <span class="score">${player.score} Puan</span>`;
                     if(finalScoresElement) finalScoresElement.appendChild(resultLine);

                     // Kazananları belirle (0 puan da dahil)
                     if (player.score >= maxScore) {
                         if (player.score > maxScore) {
                             maxScore = player.score;
                             winners = [player.name];
                         } else { // player.score === maxScore
                             winners.push(player.name);
                         }
                     }
                 });

                 // Kazanan bilgisini ayarla
                 if(winnerInfoElement){
                      if (maxScore < 0 && activePlayers.length > 0) { // Eğer aktif oyuncu var ama max skor negatifse (yani hiç kimse skor alamadıysa veya başlangıçta kaldıysa)
                          winnerInfoElement.textContent = "Kimse puan alamadı!";
                      } else if (winners.length > 1) {
                          winnerInfoElement.textContent = `🏆 Kazananlar (Berabere): ${winners.join(', ')} (${maxScore} puan)! 🎉`;
                      } else if (winners.length === 1) {
                          winnerInfoElement.textContent = `🏆 Kazanan: ${winners[0]} (${maxScore} puan)! 🎉`;
                      } else {
                           winnerInfoElement.textContent = "Kazanan belirlenemedi."; // Beklenmedik durum
                      }
                 }
            }


             // Quiz'i başlatma ve isim/yaş kontrolü
             function initializeQuiz() {
                  let allAgesValid = true;
                  let playerCount = 0;

                  players.forEach((player, index) => {
                      const nameInput = nameInputs[index];
                      const ageInput = ageInputs[index];
                      const areaEl = playerAreaElements[index];

                      if (!nameInput || !ageInput || !areaEl) {
                          console.error(`Oyuncu ${index + 1} için UI elementleri eksik.`);
                          // Eksik element varsa bu oyuncu slotunu tamamen devre dışı bırak
                          player.age = 0;
                          if(areaEl) areaEl.style.display = 'none';
                          return;
                      }

                      const name = nameInput.value.trim();
                      const ageString = ageInput.value;

                      // Oyuncu slotu boşsa
                      if (name === '' && ageString === '') {
                          player.age = 0; player.score = 0; player.themeClass = '';
                          areaEl.style.display = 'none'; // Gizle
                          return;
                      }

                      // En az bir bilgi girilmişse oyuncu adayıdır
                      playerCount++;
                      player.name = name === '' ? `Oyuncu ${player.id}` : name;
                      const age = parseInt(ageString);

                      // Yaş kontrolü
                      if (isNaN(age) || age < 7 || age > 18) {
                          alert(`Oyuncu "${player.name}" için geçerli bir yaş (7-18) girmelisiniz.`);
                          ageInput.style.border = '2px solid red';
                          allAgesValid = false;
                          player.age = 0; // Geçersiz kıl
                          areaEl.style.display = 'flex'; // Input görünsün
                          areaEl.className = 'player-quiz-area'; // Temayı kaldır
                      } else {
                          player.age = age;
                          player.themeClass = getThemeClass(age);
                          ageInput.style.border = ''; // Hata işaretini kaldır
                          areaEl.style.display = 'flex'; // Göster
                           // Tema sınıfını burada uygula
                           areaEl.className = `player-quiz-area ${player.themeClass}`;
                           // Diğer UI güncellemeleri
                           const nameEl = nameDisplays[index];
                           const ageEl = ageDisplays[index];
                           if(nameEl) nameEl.textContent = player.name;
                           if(ageEl) ageEl.textContent = `(${player.age} yaş)`;
                      }
                      // Başlangıç skorları ve durumları sıfırla
                      player.score = 0;
                      player.answered = false;
                      player.currentQuestion = null;
                  });

                  const validPlayerCount = players.filter(p => p.age >= 7 && p.age <= 18).length;

                  if (!allAgesValid || validPlayerCount === 0) {
                       if (validPlayerCount === 0 && allAgesValid && playerCount > 0) alert("Lütfen en az bir oyuncu için geçerli bir yaş (7-18) girin.");
                       else if (validPlayerCount === 0 && playerCount === 0) alert("Lütfen en az bir oyuncu için isim ve yaş girin.");
                      return; // Başlatma
                   }

                  // Başlatmaya hazırız, UI geçişlerini yap
                  if(nameEntrySection) nameEntrySection.style.display = 'none';
                  if(resultsElement) resultsElement.style.display = 'none';
                  if(quizContent) quizContent.style.display = 'block';
                  startQuiz();
             }


             function startQuiz() {
                  askedQuestionIds = []; // Sorulan soruları sıfırla
                  currentSegmentIndex = 0; // İlk segmentten başla
                  // Skorlar initializeQuiz'da sıfırlandı
                  updateScoreboard(); // Başlangıç skor tablosunu göster
                  loadSegment(currentSegmentIndex); // İlk segmenti yükle
             }

             // İsim giriş ekranına dönme fonksiyonu
             function resetToNameEntry() {
                 if ('speechSynthesis' in window && window.speechSynthesis.speaking) {
                     window.speechSynthesis.cancel();
                 }
                 if(quizContent) quizContent.style.display = 'none';
                 if(resultsElement) resultsElement.style.display = 'none';
                 if(nameEntrySection) nameEntrySection.style.display = 'flex';

                 // Inputları temizle
                 nameInputs.forEach(input => { if(input) input.value = ''; });
                 ageInputs.forEach(input => { if(input) { input.value = ''; input.style.border = ''; } });

                 // Oyuncu alanlarını sıfırla ve göster (initializeQuiz gizlemesi gerekenleri gizleyecek)
                 playerAreaElements.forEach((el, index) => {
                     if(el) {
                         el.style.display = 'flex';
                         el.className = 'player-quiz-area'; // Tüm tema ve durum sınıflarını kaldır
                         const feedbackEl = playerFeedbackElements[index];
                         const questionEl = playerQuestionElements[index];
                         const optionsEl = playerOptionsElements[index];
                         const nameEl = nameDisplays[index];
                         const ageEl = ageDisplays[index];
                         if(feedbackEl) feedbackEl.textContent = '';
                         if(questionEl) questionEl.textContent = 'Soru yükleniyor...';
                         if(optionsEl) optionsEl.innerHTML = '';
                         if(nameEl) nameEl.textContent = `Oyuncu ${index + 1}`;
                         if(ageEl) ageEl.textContent = '(Yaş)';
                     }
                 });

                 // Skorbordu temizle ve gizle
                 if(scoreboardListElement) scoreboardListElement.innerHTML = '';
                 if(scoreboardElement) scoreboardElement.style.display = 'none';

                 checkTtsSupport(); // TTS desteğini kontrol et
             }

             // TTS Desteğini Kontrol Et
             function checkTtsSupport() {
                 const hasTts = 'speechSynthesis' in window && window.speechSynthesis;
                 if (ttsSupportWarning) {
                      ttsSupportWarning.style.display = hasTts ? 'none' : 'block';
                 }
                 if (playNarrationButton) {
                      playNarrationButton.disabled = false;
                      playNarrationButton.textContent = "Anlatımı Seslendir";
                 }
             }

            // --- Olay Dinleyicileri ---
             if (confirmNamesButton) {
                  confirmNamesButton.addEventListener('click', initializeQuiz);
             } else { console.error("confirm-names-button bulunamadı!"); }

             if (restartButton) {
                  restartButton.addEventListener('click', resetToNameEntry);
             } else { console.error("restart-button bulunamadı!"); }

             if (playNarrationButton) {
                  playNarrationButton.addEventListener('click', () => {
                      if (!('speechSynthesis' in window) || !window.speechSynthesis) {
                          alert("Tarayıcınız metin seslendirme özelliğini desteklemiyor.");
                          handleNarrationEnd(); return;
                      }
                       window.speechSynthesis.cancel();

                      if (!quizSegments[currentSegmentIndex]?.narrationText) {
                           console.error("Seslendirilecek metin bulunamadı!");
                           alert("Anlatım metni bulunamadı!");
                           handleNarrationEnd(); return;
                       }
                       const segmentData = quizSegments[currentSegmentIndex];
                       const utterance = new SpeechSynthesisUtterance(segmentData.narrationText);
                       utterance.lang = 'tr-TR'; utterance.rate = 0.9; utterance.pitch = 1;
                       utterance.onend = handleNarrationEnd;
                       utterance.onerror = (event) => {
                           console.error('TTS Hatası:', event);
                           alert(`Seslendirme sırasında bir hata oluştu: ${event.error}. Sorulara devam edilecek.`);
                           handleNarrationEnd(); // Hata olsa bile devam et
                       };
                       playNarrationButton.disabled = true; playNarrationButton.textContent = "Seslendiriliyor...";
                       window.speechSynthesis.speak(utterance);
                  });
             } else { console.error("play-narration-btn bulunamadı!"); }


            // --- Başlangıç ---
            resetToNameEntry(); // Uygulamayı başlat

        }); // DOMContentLoaded Sonu
    </script>

</body>
</html>
