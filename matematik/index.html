<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ramazanamca Matematik Bilgi YarÄ±ÅŸmasÄ±</title>
    <link rel="stylesheet" href="styles.css">
    </head>
<body>
    <div id="quiz-container">
        <h1>Ramazanamca Matematik Bilgi YarÄ±ÅŸmasÄ± </h1>

        <div id="name-entry">
            <div class="player-input-group">
                 <label for="player-1-name-input">Oyuncu 1 AdÄ±:</label>
                 <input type="text" id="player-1-name-input" placeholder="Ä°sim..." maxlength="20">
                 <label for="player-1-age-input">YaÅŸÄ± (7-18):</label>
                 <input type="number" id="player-1-age-input" min="7" max="18" placeholder="YaÅŸ...">
             </div>
             <div class="player-input-group">
                 <label for="player-2-name-input">Oyuncu 2 AdÄ±:</label>
                 <input type="text" id="player-2-name-input" placeholder="Ä°sim..." maxlength="20">
                 <label for="player-2-age-input">YaÅŸÄ± (7-18):</label>
                 <input type="number" id="player-2-age-input" min="7" max="18" placeholder="YaÅŸ...">
             </div>
             <div class="player-input-group">
                 <label for="player-3-name-input">Oyuncu 3 AdÄ±:</label>
                 <input type="text" id="player-3-name-input" placeholder="Ä°sim..." maxlength="20">
                 <label for="player-3-age-input">YaÅŸÄ± (7-18):</label>
                 <input type="number" id="player-3-age-input" min="7" max="18" placeholder="YaÅŸ...">
             </div>
             <div id="confirm-container">
                 <button id="confirm-names-button">YarÄ±ÅŸmayÄ± BaÅŸlat</button>
             </div>
            <p id="tts-support-warning" class="tts-warning">TarayÄ±cÄ±nÄ±z metin seslendirme Ã¶zelliÄŸini desteklemiyor olabilir. AnlatÄ±m seslendirilemeyecek.</p>
        </div>

        <div id="quiz-content">
             <div id="narration-area" style="display: none;">
                 <p id="narration-info">Åžimdi dikkatle dinleyin...</p>
                 <button id="play-narration-btn">AnlatÄ±mÄ± Seslendir</button>
             </div>
             <div id="loading-indicator">SÄ±radaki sorular hazÄ±rlanÄ±yor...</div>
             <div id="scoreboard" style="display: none;">
                 <h3>Skor Tablosu</h3>
                 <ul id="scoreboard-list"></ul>
             </div>
             <div id="players-area">
                 <div class="player-quiz-area" id="player-area-1">
                     <div class="player-info">
                         <span class="player-name" id="player-1-name-display">Oyuncu 1</span>
                         <span class="player-age" id="player-1-age-display">(YaÅŸ)</span>
                     </div>
                     <div class="player-question" id="question-player-1">Soru yÃ¼kleniyor...</div>
                     <div class="player-options" id="options-player-1"></div>
                     <div class="player-feedback" id="feedback-player-1"></div>
                 </div>
                 <div class="player-quiz-area" id="player-area-2">
                     <div class="player-info">
                          <span class="player-name" id="player-2-name-display">Oyuncu 2</span>
                          <span class="player-age" id="player-2-age-display">(YaÅŸ)</span>
                     </div>
                     <div class="player-question" id="question-player-2">Soru yÃ¼kleniyor...</div>
                     <div class="player-options" id="options-player-2"></div>
                     <div class="player-feedback" id="feedback-player-2"></div>
                 </div>
                 <div class="player-quiz-area" id="player-area-3">
                     <div class="player-info">
                         <span class="player-name" id="player-3-name-display">Oyuncu 3</span>
                         <span class="player-age" id="player-3-age-display">(YaÅŸ)</span>
                     </div>
                     <div class="player-question" id="question-player-3">Soru yÃ¼kleniyor...</div>
                     <div class="player-options" id="options-player-3"></div>
                     <div class="player-feedback" id="feedback-player-3"></div>
                 </div>
             </div>
        </div>

        <div id="results">
            <h2>YarÄ±ÅŸma Bitti!</h2>
             <div id="final-scores"></div>
             <p id="winner-info"></p>
             <button id="restart-button">Yeni Oyun (Yeni Ä°simlerle)</button>
        </div>
    </div>

    <script src="questions.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM YÃ¼klendi, script baÅŸlÄ±yor.");

            // --- VERÄ° KONTROLÃœ ---
            if (typeof questionPool === 'undefined' || typeof quizSegments === 'undefined' || !Array.isArray(questionPool) || !Array.isArray(quizSegments)) {
                 console.error("CRITICAL ERROR: questionPool veya quizSegments yÃ¼klenemedi, tanÄ±msÄ±z veya dizi deÄŸil.");
                 displayGlobalError("YarÄ±ÅŸma verileri yÃ¼klenemedi veya geÃ§ersiz. LÃ¼tfen 'questions.js' dosyasÄ±nÄ± kontrol edin.");
                 return;
             }
            if (quizSegments.length === 0) {
                console.error("CRITICAL ERROR: quizSegments dizisi boÅŸ.");
                displayGlobalError("YarÄ±ÅŸma segmentleri bulunamadÄ±. LÃ¼tfen 'questions.js' dosyasÄ±nÄ± kontrol edin.");
                return;
            }
            console.log(`questions.js yÃ¼klendi: ${quizSegments.length} segment, ${questionPool.length} soru bulundu.`);


            // --- Oyuncu Bilgileri ---
            const players = [
                { id: 1, name: "Oyuncu 1", age: 0, score: 0, answered: false, themeClass: '', currentQuestion: null },
                { id: 2, name: "Oyuncu 2", age: 0, score: 0, answered: false, themeClass: '', currentQuestion: null },
                { id: 3, name: "Oyuncu 3", age: 0, score: 0, answered: false, themeClass: '', currentQuestion: null }
            ];
            // --- DeÄŸiÅŸkenler ---
            let currentSegmentIndex = 0;
            let askedQuestionIds = [];

            // --- Element ReferanslarÄ± (KontrollÃ¼) ---
            const nameEntrySection = getElementOrFail('name-entry');
            const confirmNamesButton = getElementOrFail('confirm-names-button');
            const ttsSupportWarning = getElementOrFail('tts-support-warning');
            const quizContent = getElementOrFail('quiz-content');
            const narrationArea = getElementOrFail('narration-area');
            const narrationInfo = getElementOrFail('narration-info');
            const playNarrationButton = getElementOrFail('play-narration-btn');
            const scoreboardElement = getElementOrFail('scoreboard');
            const scoreboardListElement = getElementOrFail('scoreboard-list');
            const playersArea = getElementOrFail('players-area');
            const loadingIndicator = getElementOrFail('loading-indicator');
            const resultsElement = getElementOrFail('results');
            const finalScoresElement = getElementOrFail('final-scores');
            const restartButton = getElementOrFail('restart-button');
            const winnerInfoElement = getElementOrFail('winner-info');

            const nameInputs = []; const ageInputs = []; const nameDisplays = []; const ageDisplays = [];
            const playerAreaElements = []; const playerQuestionElements = []; const playerOptionsElements = []; const playerFeedbackElements = [];
            let elementsMissing = false;

            for (let i = 1; i <= 3; i++) {
                nameInputs.push(getElementOrFail(`player-${i}-name-input`, true));
                ageInputs.push(getElementOrFail(`player-${i}-age-input`, true));
                nameDisplays.push(getElementOrFail(`player-${i}-name-display`, true));
                ageDisplays.push(getElementOrFail(`player-${i}-age-display`, true));
                playerAreaElements.push(getElementOrFail(`player-area-${i}`, true));
                playerQuestionElements.push(getElementOrFail(`question-player-${i}`, true));
                playerOptionsElements.push(getElementOrFail(`options-player-${i}`, true));
                playerFeedbackElements.push(getElementOrFail(`feedback-player-${i}`, true));
                // Basit bir kontrol
                if (!playerAreaElements[i-1]) elementsMissing = true;
            }

            // EÄŸer kritik elementler eksikse, devam etme
            if (elementsMissing || !nameEntrySection || !quizContent || !resultsElement) {
                console.error("Kritik HTML elementleri bulunamadÄ±. Script durduruluyor.");
                displayGlobalError("ArayÃ¼z elementleri yÃ¼klenemedi. HTML yapÄ±sÄ±nÄ± kontrol edin.");
                return;
            }
            console.log("TÃ¼m gerekli element referanslarÄ± alÄ±ndÄ±.");


             // --- YardÄ±mcÄ± Fonksiyonlar ---
            function getElementOrFail(id, suppressError = false) {
                const element = document.getElementById(id);
                if (!element && !suppressError) {
                    console.error(`Element with ID "${id}" not found!`);
                }
                return element;
            }

            function displayGlobalError(message) {
                const container = getElementOrFail('quiz-container');
                 if (container) {
                    container.innerHTML = `<h1>Hata!</h1><p>${message}</p>`;
                    container.style.color = 'red';
                    container.style.textAlign = 'center';
                 }
            }

             function shuffleArray(array) { /* DeÄŸiÅŸiklik yok */
                  let currentIndex = array.length,  randomIndex;
                  while (currentIndex > 0) {
                      randomIndex = Math.floor(Math.random() * currentIndex);
                      currentIndex--;
                      [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
                  }
                  return array;
              }

             function getThemeClass(age) { /* DeÄŸiÅŸiklik yok */
                  if (age >= 7 && age <= 10) return 'theme-child';
                  if (age >= 11 && age <= 14) return 'theme-teen';
                  if (age >= 15 && age <= 18) return 'theme-young-adult';
                  return 'theme-default';
              }

            // Skor tablosunu gÃ¼ncelleme fonksiyonu (Daha saÄŸlam)
            function updateScoreboard() {
                if (!scoreboardListElement) return; // Element yoksa Ã§Ä±k
                scoreboardListElement.innerHTML = '';
                const sortedByIdPlayers = [...players].sort((a, b) => a.id - b.id);

                sortedByIdPlayers.forEach(player => {
                    if (player.age >= 7 && player.age <= 18) {
                        const listItem = document.createElement('li');
                        // Tema sÄ±nÄ±fÄ±nÄ± doÄŸrudan li elementine ekle
                        listItem.className = player.themeClass || 'theme-default'; // Tema sÄ±nÄ±fÄ± yoksa varsayÄ±lan ata

                        // Ä°Ã§eriÄŸi ayarla
                        const nameSpan = document.createElement('span');
                        nameSpan.className = 'name';
                        nameSpan.textContent = player.name;

                        const scoreSpan = document.createElement('span');
                        scoreSpan.className = 'score';
                        scoreSpan.textContent = `${player.score} Puan`;

                        listItem.appendChild(nameSpan);
                        listItem.appendChild(document.createTextNode(': ')); // Aradaki boÅŸluk ve iki nokta
                        listItem.appendChild(scoreSpan);

                        scoreboardListElement.appendChild(listItem);
                    }
                });
                console.log("Skor tablosu gÃ¼ncellendi.");
            }


              // --- Quiz AkÄ±ÅŸ FonksiyonlarÄ± (Daha Dikkatli) ---

              function loadSegment(segmentIndex) {
                  console.log(`Segment ${segmentIndex + 1} yÃ¼kleniyor.`);
                  // Mevcut seslendirmeyi durdur
                  if ('speechSynthesis' in window && window.speechSynthesis.speaking) {
                       window.speechSynthesis.cancel();
                       console.log("Mevcut seslendirme iptal edildi.");
                  }

                  // Segment index kontrolÃ¼
                  if (segmentIndex >= quizSegments.length) {
                       console.log("TÃ¼m segmentler bitti, sonuÃ§lar gÃ¶steriliyor.");
                       showResults();
                       return;
                  }
                  currentSegmentIndex = segmentIndex;
                  const segmentData = quizSegments[segmentIndex];
                  if (!segmentData) {
                      console.error(`Segment verisi bulunamadÄ±: index ${segmentIndex}`);
                      displayGlobalError("Segment verisi hatasÄ±. 'questions.js' dosyasÄ±nÄ± kontrol edin.");
                      return;
                  }

                  // Oyuncu alanlarÄ±nÄ± gizle ve sÄ±fÄ±rla
                  playersArea.style.display = 'none';
                  playerAreaElements.forEach((areaEl, index) => {
                      if (areaEl) {
                          areaEl.classList.remove('visible', 'answered-correct', 'answered-incorrect');
                          const feedbackEl = playerFeedbackElements[index];
                          if(feedbackEl) feedbackEl.textContent = '';
                          // Tema sÄ±nÄ±fÄ± initializeQuiz'de ayarlandÄ±ÄŸÄ± iÃ§in burada dokunmuyoruz.
                          // Borderlar CSS tarafÄ±ndan yÃ¶netiliyor.
                      }
                  });
                  console.log("Oyuncu alanlarÄ± gizlendi ve sÄ±fÄ±rlandÄ±.");

                  // Gerekli alanlarÄ± gÃ¶ster/gizle
                  if (loadingIndicator) loadingIndicator.style.display = 'none';
                  if (narrationArea) narrationArea.style.display = 'block';
                  if (scoreboardElement) scoreboardElement.style.display = 'block';

                  // AnlatÄ±m bilgilerini ayarla
                  if (narrationInfo) narrationInfo.textContent = `Segment ${segmentIndex + 1}: "${segmentData.narrationTitle || 'BaÅŸlÄ±ksÄ±z Konu'}" konusunu dinlemek iÃ§in butona basÄ±n.`;
                  if (playNarrationButton) {
                      playNarrationButton.disabled = false;
                      playNarrationButton.textContent = "AnlatÄ±mÄ± Seslendir";
                  }

                  updateScoreboard(); // Skor tablosunu her segment baÅŸÄ±nda gÃ¼ncelle
              }

             function handleNarrationEnd() {
                  console.log("AnlatÄ±m bitti/atlandÄ±, sorular yÃ¼kleniyor...");
                  if(playNarrationButton) {
                       playNarrationButton.textContent = "AnlatÄ±m Bitti";
                       playNarrationButton.disabled = true;
                  }
                  if(narrationArea) narrationArea.style.display = 'none';
                  if(loadingIndicator) loadingIndicator.style.display = 'block';

                  // SorularÄ± yÃ¼klemeden Ã¶nce kÄ±sa bir gecikme (opsiyonel)
                  setTimeout(() => {
                       if(loadingIndicator) loadingIndicator.style.display = 'none'; // YÃ¼kleniyor'u gizle
                       loadQuestionsForPlayers(currentSegmentIndex); // SorularÄ± yÃ¼kle

                       if(playersArea) playersArea.style.display = 'flex'; // Oyuncu alanÄ±nÄ± gÃ¶ster
                        console.log("Oyuncu alanÄ± gÃ¶steriliyor.");
                       // Aktif oyuncu alanlarÄ±nÄ± gÃ¶rÃ¼nÃ¼r yap (animasyon iÃ§in)
                       players.forEach(player => {
                           if (player.age >= 7 && player.age <= 18) {
                               const areaEl = playerAreaElements[player.id - 1];
                               if(areaEl) {
                                   areaEl.classList.add('visible');
                               }
                           }
                       });
                        console.log("Aktif oyuncu alanlarÄ± 'visible' yapÄ±ldÄ±.");
                  }, 300); // Daha kÄ±sa bekleme
              }

            function loadQuestionsForPlayers(segmentIdx) {
                console.log(`Segment ${segmentIdx + 1} iÃ§in sorular yÃ¼kleniyor.`);
                let currentRoundSelectedIds = [];
                let activePlayerCount = 0;

                players.forEach(player => {
                    const playerIndex = player.id - 1;
                    const areaEl = playerAreaElements[playerIndex];
                    const optionsEl = playerOptionsElements[playerIndex];
                    const feedbackEl = playerFeedbackElements[playerIndex];
                    const questionEl = playerQuestionElements[playerIndex];

                    // Elementlerin varlÄ±ÄŸÄ±nÄ± tekrar kontrol et
                    if (!areaEl || !optionsEl || !feedbackEl || !questionEl) {
                         console.error(`Oyuncu ${player.id} iÃ§in UI elementleri eksik! Bu oyuncu atlanÄ±yor.`);
                         player.answered = true; // HatalÄ± durumu cevaplamÄ±ÅŸ say
                         return; // Sonraki oyuncuya geÃ§
                    }

                    // Sadece aktif oyuncular iÃ§in iÅŸlem yap
                    if (!(player.age >= 7 && player.age <= 18)) {
                        player.answered = true;
                        areaEl.style.display = 'none';
                        console.log(`Oyuncu ${player.id} aktif deÄŸil, alanÄ± gizlendi.`);
                        return;
                    }

                    activePlayerCount++;
                    player.answered = false;
                    player.currentQuestion = null;

                    // Ã–nceki durumlarÄ± temizle
                    areaEl.classList.remove('answered-correct', 'answered-incorrect');
                    optionsEl.innerHTML = '';
                    feedbackEl.textContent = '';
                    questionEl.textContent = 'Soru aranÄ±yor...';
                    if (areaEl.style.display === 'none') {
                         areaEl.style.display = 'flex'; // GizlenmiÅŸse gÃ¶ster
                         console.log(`Oyuncu ${player.id} alanÄ± tekrar gÃ¶sterildi.`);
                    }

                    // Uygun sorularÄ± filtrele
                    const suitableQuestions = questionPool.filter(q =>
                        q.segmentId === quizSegments[segmentIdx].segmentId &&
                        player.age >= q.minAge &&
                        player.age <= q.maxAge &&
                        !askedQuestionIds.includes(q.questionId) &&
                        !currentRoundSelectedIds.includes(q.questionId)
                    );

                    console.log(`Oyuncu ${player.id} (YaÅŸ: ${player.age}) iÃ§in ${suitableQuestions.length} uygun soru bulundu.`);

                    if (suitableQuestions.length > 0) {
                        const questionData = suitableQuestions[Math.floor(Math.random() * suitableQuestions.length)];
                        player.currentQuestion = questionData;
                        askedQuestionIds.push(questionData.questionId);
                        currentRoundSelectedIds.push(questionData.questionId);

                        console.log(`Oyuncu ${player.id} iÃ§in seÃ§ilen soru ID: ${questionData.questionId}`);
                        questionEl.textContent = questionData.questionText;

                        const shuffledOptions = shuffleArray([...questionData.options]);
                        shuffledOptions.forEach(optionText => {
                            const button = document.createElement('button');
                            button.textContent = optionText;
                            // DÄ°KKAT: Burada handleAnswer'a buton referansÄ±nÄ± doÄŸru ÅŸekilde aktarmak Ã¶nemli
                            button.onclick = (event) => {
                                // event.target butona karÅŸÄ±lÄ±k gelir
                                handleAnswer(player.id, optionText, event.target);
                            };
                            optionsEl.appendChild(button);
                        });
                        console.log(`Oyuncu ${player.id} iÃ§in seÃ§enek butonlarÄ± oluÅŸturuldu.`);
                    } else {
                        console.warn(`Oyuncu ${player.id} iÃ§in uygun soru bulunamadÄ±.`);
                        questionEl.textContent = 'Size uygun soru bulunamadÄ±.';
                        player.answered = true; // Soru yoksa cevaplamÄ±ÅŸ say
                    }
                });

                // EÄŸer hiÃ§ aktif oyuncu yoksa veya hepsi soru bulamadÄ±ysa bile turu bitir
                if (activePlayerCount === 0 || players.filter(p => p.age >= 7 && p.age <= 18).every(p => p.answered)) {
                    console.log("Aktif oyuncu yok veya tÃ¼m aktif oyuncular iÃ§in soru yÃ¼klemesi tamamlandÄ±/soru bulunamadÄ±.");
                    checkRoundCompletion();
                } else {
                     console.log("Sorular yÃ¼klendi, oyuncularÄ±n cevaplamasÄ± bekleniyor.");
                }
            }


            function checkRoundCompletion() {
                const activePlayers = players.filter(p => p.age >= 7 && p.age <= 18);
                // Aktif oyuncu kalmadÄ±ysa veya tÃ¼m aktifler cevapladÄ±ysa tur biter.
                const allActiveAnswered = activePlayers.length > 0 && activePlayers.every(p => p.answered);

                console.log(`checkRoundCompletion: Aktif Oyuncu SayÄ±sÄ± = ${activePlayers.length}, Hepsi CevapladÄ± = ${allActiveAnswered}`);

                if (activePlayers.length === 0 || allActiveAnswered) {
                    console.log("Tur tamamlandÄ±, 1.8sn sonra sonraki segmente geÃ§ilecek.");
                    if(loadingIndicator) loadingIndicator.style.display = 'block'; // Sonraki segment yÃ¼kleniyor...

                    // Animasyonla gizlemeden Ã¶nce kÄ±sa bekleme
                    setTimeout(() => {
                        playerAreaElements.forEach(el => {
                            // Sadece 'visible' olanlarÄ± (yani aktif olanlarÄ±) gizle
                            if(el && el.classList.contains('visible')) {
                                el.classList.remove('visible');
                            }
                        });

                        // Gizlenme animasyonu bittikten sonra segment yÃ¼kle
                        setTimeout(() => {
                            if(playersArea) playersArea.style.display = 'none';
                            loadSegment(currentSegmentIndex + 1);
                        }, 600); // CSS transition sÃ¼resi kadar bekle (varsayÄ±lan 0.3s ise bu daha uzun olabilir, 600ms gÃ¼venli)

                    }, 1200); // Geri bildirimi (doÄŸru/yanlÄ±ÅŸ border vs.) gÃ¶rmek iÃ§in 1.2sn bekle
                }
            }


            function handleAnswer(playerId, selectedOption, clickedButton) {
                console.log(`Oyuncu ${playerId} cevap verdi: ${selectedOption}`);
                const player = players.find(p => p.id === playerId);

                // Ekstra kontroller
                if (!player) { console.error(`handleAnswer: Oyuncu ${playerId} bulunamadÄ±!`); return; }
                if (player.answered) { console.warn(`handleAnswer: Oyuncu ${playerId} zaten cevaplamÄ±ÅŸ.`); return; }
                if (!player.currentQuestion) { console.error(`handleAnswer: Oyuncu ${playerId} iÃ§in currentQuestion tanÄ±msÄ±z!`); player.answered = true; checkRoundCompletion(); return; } // Sorusu yoksa cevaplamÄ±ÅŸ say
                if (!(player.age >= 7 && player.age <= 18)) { console.warn(`handleAnswer: Aktif olmayan oyuncu ${playerId} cevaplamaya Ã§alÄ±ÅŸtÄ±.`); return; }

                player.answered = true;
                console.log(`Oyuncu ${playerId} 'answered' olarak iÅŸaretlendi.`);

                const playerIndex = player.id - 1;
                const feedbackEl = playerFeedbackElements[playerIndex];
                const sectionEl = playerAreaElements[playerIndex];
                const optionsContainer = playerOptionsElements[playerIndex];

                if (!feedbackEl || !sectionEl || !optionsContainer || !clickedButton) {
                    console.error(`handleAnswer: Oyuncu ${playerId} iÃ§in UI elementleri eksik!`);
                    checkRoundCompletion(); // Hata olsa bile turu bitirme kontrolÃ¼ yap
                    return;
                }

                const isCorrect = (selectedOption === player.currentQuestion.correctAnswer);
                const correctAnswerText = player.currentQuestion.correctAnswer;
                console.log(`Cevap ${isCorrect ? 'DoÄŸru' : 'YanlÄ±ÅŸ'}. DoÄŸru cevap: ${correctAnswerText}`);

                // TÃ¼m butonlarÄ± devre dÄ±ÅŸÄ± bÄ±rak
                const buttons = optionsContainer.getElementsByTagName('button');
                for (let btn of buttons) {
                    btn.disabled = true;
                    // TÄ±klanan butonu iÅŸaretle
                    if (btn === clickedButton) {
                        console.log("TÄ±klanan buton iÅŸaretleniyor:", isCorrect ? 'selected-correct' : 'selected-incorrect');
                        btn.classList.add(isCorrect ? 'selected-correct' : 'selected-incorrect');
                    }
                    // YanlÄ±ÅŸ cevapta doÄŸruyu gÃ¶ster
                    if (!isCorrect && btn.textContent === correctAnswerText) {
                        console.log("DoÄŸru cevap butonu iÅŸaretleniyor: reveal-correct");
                        btn.classList.add('reveal-correct');
                    }
                }

                // Geri bildirim metnini ve alan class'Ä±nÄ± ayarla
                if (isCorrect) {
                    player.score++;
                    console.log(`Oyuncu ${playerId} skoru ${player.score} oldu.`);
                    feedbackEl.textContent = "DoÄŸru!";
                    feedbackEl.className = 'player-feedback feedback-correct';
                    sectionEl.classList.remove('answered-incorrect'); // Ã–ncekini temizle (gerekirse)
                    sectionEl.classList.add('answered-correct');
                } else {
                    feedbackEl.textContent = `YanlÄ±ÅŸ! DoÄŸru: ${correctAnswerText}`;
                    feedbackEl.className = 'player-feedback feedback-incorrect';
                    sectionEl.classList.remove('answered-correct'); // Ã–ncekini temizle (gerekirse)
                    sectionEl.classList.add('answered-incorrect');
                }

                updateScoreboard(); // Skorbordu gÃ¼ncelle
                checkRoundCompletion(); // Tur bitti mi kontrol et
            }

            function showResults() {
                console.log("SonuÃ§lar gÃ¶steriliyor.");
                 if ('speechSynthesis' in window && window.speechSynthesis.speaking) {
                     window.speechSynthesis.cancel();
                 }
                 if(quizContent) quizContent.style.display = 'none';
                 if(resultsElement) resultsElement.style.display = 'block';
                 if(finalScoresElement) finalScoresElement.innerHTML = '';

                 let maxScore = -Infinity; // En dÃ¼ÅŸÃ¼k skoru bulmak iÃ§in -Infinity ile baÅŸla
                 let winners = [];
                 const activePlayers = players.filter(p => p.age >= 7 && p.age <= 18);

                 if (activePlayers.length === 0) {
                     console.log("SonuÃ§ gÃ¶sterecek aktif oyuncu yok.");
                     if(winnerInfoElement) winnerInfoElement.textContent = "YarÄ±ÅŸmaya katÄ±lan geÃ§erli oyuncu bulunamadÄ±.";
                     if(finalScoresElement) finalScoresElement.innerHTML = '<p class="no-score">GÃ¶sterilecek skor yok.</p>'; // CSS'de .no-score stil verilebilir
                     return;
                 }

                 // En yÃ¼ksek skoru bul
                 activePlayers.forEach(p => {
                    if(p.score > maxScore) {
                        maxScore = p.score;
                    }
                 });
                 console.log("En yÃ¼ksek skor:", maxScore);

                  // KazananlarÄ± bul (en yÃ¼ksek skora eÅŸit olanlar)
                  winners = activePlayers.filter(p => p.score === maxScore).map(p => p.name);
                  console.log("Kazanan(lar):", winners);


                 // SkorlarÄ± sÄ±ralÄ± gÃ¶ster
                 const sortedPlayers = [...activePlayers].sort((a, b) => b.score - a.score);
                 sortedPlayers.forEach(player => {
                     const resultLine = document.createElement('div');
                     resultLine.classList.add('result-line');
                     resultLine.classList.add(player.themeClass || 'theme-default');

                     resultLine.innerHTML = `<span class="name">${player.name} (${player.age} yaÅŸ)</span> <span class="score">${player.score} Puan</span>`;
                     if(finalScoresElement) finalScoresElement.appendChild(resultLine);
                 });

                 // Kazanan mesajÄ±nÄ± ayarla
                 if(winnerInfoElement){
                      if (maxScore < 0) { // EÄŸer en yÃ¼ksek skor bile negatifse (mÃ¼mkÃ¼n deÄŸil ama kontrol) veya 0 ise
                           winnerInfoElement.textContent = "Kimse puan alamadÄ±!";
                      } else if (winners.length > 1) {
                          winnerInfoElement.textContent = `ðŸ† Kazananlar (Berabere): ${winners.join(', ')} (${maxScore} puan)! ðŸŽ‰`;
                      } else if (winners.length === 1) {
                          winnerInfoElement.textContent = `ðŸ† Kazanan: ${winners[0]} (${maxScore} puan)! ðŸŽ‰`;
                      } else {
                           // Bu durumun olmamasÄ± gerekir ama olursa diye
                           winnerInfoElement.textContent = "SonuÃ§lar hesaplanamadÄ±.";
                      }
                 }
            }


             function initializeQuiz() {
                 console.log("Quiz baÅŸlatÄ±lÄ±yor, oyuncu bilgileri alÄ±nÄ±yor...");
                  let allAgesValid = true;
                  let playerCount = 0; // Bilgi girilen oyuncu slotu sayÄ±sÄ±
                  let validPlayerCount = 0; // GeÃ§erli yaÅŸa sahip oyuncu sayÄ±sÄ±

                  players.forEach((player, index) => {
                      const nameInput = nameInputs[index];
                      const ageInput = ageInputs[index];
                      const areaEl = playerAreaElements[index];
                      const nameEl = nameDisplays[index];
                      const ageEl = ageDisplays[index];

                      if (!nameInput || !ageInput || !areaEl || !nameEl || !ageEl) {
                          console.error(`Oyuncu ${index + 1} UI elementleri eksik.`);
                          player.age = 0; if(areaEl) areaEl.style.display = 'none';
                          return;
                      }

                      const name = nameInput.value.trim();
                      const ageString = ageInput.value;

                      // Oyuncu slotu boÅŸsa
                      if (name === '' && ageString === '') {
                          player.age = 0; player.score = 0; player.themeClass = '';
                          areaEl.className = 'player-quiz-area'; // Temizle
                          areaEl.style.display = 'none';
                          return;
                      }

                      playerCount++;
                      player.name = name === '' ? `Oyuncu ${player.id}` : name;
                      const age = parseInt(ageString);

                      // YaÅŸ kontrolÃ¼
                      if (isNaN(age) || age < 7 || age > 18) {
                          alert(`Oyuncu "${player.name}" iÃ§in geÃ§erli bir yaÅŸ (7-18) girmelisiniz.`);
                          ageInput.style.border = '2px solid red';
                          allAgesValid = false;
                          player.age = 0; player.themeClass = '';
                          areaEl.className = 'player-quiz-area'; // TemayÄ± kaldÄ±r
                          areaEl.style.display = 'flex'; // Input gÃ¶rÃ¼nsÃ¼n
                          nameEl.textContent = player.name;
                          ageEl.textContent = '(GeÃ§ersiz YaÅŸ)';
                      } else {
                          validPlayerCount++;
                          player.age = age;
                          player.themeClass = getThemeClass(age);
                          ageInput.style.border = '';
                          areaEl.style.display = 'flex';
                          areaEl.className = `player-quiz-area ${player.themeClass}`;
                          nameEl.textContent = player.name;
                          ageEl.textContent = `(${player.age} yaÅŸ)`;
                           console.log(`Oyuncu ${player.id} (${player.name}, ${player.age} yaÅŸ) geÃ§erli.`);
                      }
                      player.score = 0;
                      player.answered = false;
                      player.currentQuestion = null;
                  });

                  // BaÅŸlatma kontrolleri
                  if (!allAgesValid) {
                       console.log("GeÃ§ersiz yaÅŸ girildiÄŸi iÃ§in quiz baÅŸlatÄ±lmadÄ±.");
                       return;
                  }
                  if (validPlayerCount === 0) {
                      console.log("GeÃ§erli yaÅŸta oyuncu bulunamadÄ±ÄŸÄ± iÃ§in quiz baÅŸlatÄ±lmadÄ±.");
                      if (playerCount > 0) alert("LÃ¼tfen en az bir oyuncu iÃ§in geÃ§erli bir yaÅŸ (7-18) girin.");
                      else alert("LÃ¼tfen en az bir oyuncu iÃ§in isim ve yaÅŸ girin.");
                      return;
                  }

                  console.log(`${validPlayerCount} geÃ§erli oyuncu ile quiz baÅŸlÄ±yor.`);
                  // UI geÃ§iÅŸleri
                  if(nameEntrySection) nameEntrySection.style.display = 'none';
                  if(resultsElement) resultsElement.style.display = 'none';
                  if(quizContent) quizContent.style.display = 'block';
                  startQuiz();
             }


             function startQuiz() {
                 console.log("startQuiz Ã§aÄŸrÄ±ldÄ±.");
                  askedQuestionIds = [];
                  currentSegmentIndex = 0;
                  updateScoreboard(); // Skorbordu gÃ¶ster/gÃ¼ncelle
                  loadSegment(currentSegmentIndex); // Ä°lk segmenti yÃ¼kle
             }

            function resetToNameEntry() {
                console.log("resetToNameEntry Ã§aÄŸrÄ±ldÄ±.");
                 if ('speechSynthesis' in window && window.speechSynthesis.speaking) {
                     window.speechSynthesis.cancel();
                 }
                 if(quizContent) quizContent.style.display = 'none';
                 if(resultsElement) resultsElement.style.display = 'none';
                 if(nameEntrySection) nameEntrySection.style.display = 'flex';

                 // InputlarÄ± temizle
                 nameInputs.forEach(input => { if(input) input.value = ''; });
                 ageInputs.forEach(input => { if(input) { input.value = ''; input.style.border = ''; } });

                 // Oyuncu alanlarÄ±nÄ± sÄ±fÄ±rla (baÅŸlangÄ±Ã§ gÃ¶rÃ¼nÃ¼mÃ¼)
                 playerAreaElements.forEach((el, index) => {
                     if(el) {
                         el.style.display = 'flex'; // GiriÅŸ iÃ§in gÃ¶rÃ¼nÃ¼r yap
                         el.className = 'player-quiz-area'; // ClasslarÄ± temizle
                         const feedbackEl = playerFeedbackElements[index];
                         const questionEl = playerQuestionElements[index];
                         const optionsEl = playerOptionsElements[index];
                         const nameEl = nameDisplays[index];
                         const ageEl = ageDisplays[index];
                         if(feedbackEl) feedbackEl.textContent = '';
                         if(questionEl) questionEl.textContent = 'Soru yÃ¼kleniyor...'; // BaÅŸlangÄ±Ã§ metni
                         if(optionsEl) optionsEl.innerHTML = '';
                         if(nameEl) nameEl.textContent = `Oyuncu ${index + 1}`; // VarsayÄ±lan isim
                         if(ageEl) ageEl.textContent = '(YaÅŸ)'; // VarsayÄ±lan yaÅŸ
                     }
                 });

                 // Skorbordu temizle ve gizle
                 if(scoreboardListElement) scoreboardListElement.innerHTML = '';
                 if(scoreboardElement) scoreboardElement.style.display = 'none';

                 checkTtsSupport();
                 console.log("ArayÃ¼z isim giriÅŸine sÄ±fÄ±rlandÄ±.");
             }

             function checkTtsSupport() { /* DeÄŸiÅŸiklik yok */
                 const hasTts = 'speechSynthesis' in window && window.speechSynthesis;
                 if (ttsSupportWarning) {
                      ttsSupportWarning.style.display = hasTts ? 'none' : 'block';
                 }
                 if (playNarrationButton) {
                      playNarrationButton.disabled = false;
                      playNarrationButton.textContent = "AnlatÄ±mÄ± Seslendir";
                 }
             }

            // --- Olay Dinleyicileri (KontrollÃ¼) ---
             if (confirmNamesButton) {
                 confirmNamesButton.addEventListener('click', initializeQuiz);
             } else { console.error("confirm-names-button butonu bulunamadÄ±!"); }

             if (restartButton) {
                 restartButton.addEventListener('click', resetToNameEntry);
             } else { console.error("restart-button butonu bulunamadÄ±!"); }

             if (playNarrationButton) {
                 playNarrationButton.addEventListener('click', () => {
                    console.log("AnlatÄ±mÄ± Seslendir butonuna tÄ±klandÄ±.");
                    if (!('speechSynthesis' in window) || !window.speechSynthesis) {
                         alert("TarayÄ±cÄ±nÄ±z metin seslendirme Ã¶zelliÄŸini desteklemiyor.");
                         handleNarrationEnd(); return; // Destek yoksa anlatÄ±mÄ± atla
                    }
                    window.speechSynthesis.cancel(); // Ã–nceki konuÅŸmayÄ± durdur

                    if (!quizSegments[currentSegmentIndex]?.narrationText) {
                         console.error("Seslendirilecek metin bulunamadÄ± veya geÃ§ersiz segment index!");
                         alert("AnlatÄ±m metni bulunamadÄ±!");
                         handleNarrationEnd(); return; // AnlatÄ±m yoksa atla
                    }
                    const segmentData = quizSegments[currentSegmentIndex];
                    const utterance = new SpeechSynthesisUtterance(segmentData.narrationText);
                    utterance.lang = 'tr-TR'; utterance.rate = 0.9; utterance.pitch = 1;
                    utterance.onstart = () => console.log("Seslendirme baÅŸladÄ±.");
                    utterance.onend = () => { console.log("Seslendirme normal bitti."); handleNarrationEnd(); };
                    utterance.onerror = (event) => {
                         console.error('TTS HatasÄ±:', event);
                         alert(`Seslendirme hatasÄ±: ${event.error}. Sorulara devam edilecek.`);
                         handleNarrationEnd(); // Hata olsa bile devam et
                    };
                    playNarrationButton.disabled = true; playNarrationButton.textContent = "Seslendiriliyor...";
                    window.speechSynthesis.speak(utterance);
                 });
             } else { console.error("play-narration-btn butonu bulunamadÄ±!"); }


            // --- BaÅŸlangÄ±Ã§ NoktasÄ± ---
            console.log("BaÅŸlangÄ±Ã§: resetToNameEntry Ã§aÄŸrÄ±lÄ±yor.");
            resetToNameEntry(); // UygulamayÄ± isim giriÅŸ ekranÄ±yla baÅŸlat

        }); // DOMContentLoaded Sonu
    </script>

</body>
</html>
