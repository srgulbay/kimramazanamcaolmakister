<script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- Ses Efektleri ---
        const correctSound = new Audio('https://cdn.pixabay.com/download/audio/2022/03/10/audio_c4ccfa869e.mp3');
        const incorrectSound = new Audio('https://cdn.pixabay.com/download/audio/2021/08/04/audio_c3a530a98c.mp3');
        correctSound.onerror = () => console.error("DoÄŸru ses dosyasÄ± yÃ¼klenemedi veya Ã§alÄ±namÄ±yor.");
        incorrectSound.onerror = () => console.error("YanlÄ±ÅŸ ses dosyasÄ± yÃ¼klenemedi veya Ã§alÄ±namÄ±yor.");
        // correctSound.load(); // Ä°steÄŸe baÄŸlÄ± Ã¶n yÃ¼kleme
        // incorrectSound.load(); // Ä°steÄŸe baÄŸlÄ± Ã¶n yÃ¼kleme


        // --- SORU HAVUZU & SEGMENTLER DIÅžARIDAN questions.js'den GELÄ°YOR ---
        if (typeof quizSegments === 'undefined' || typeof questionPool === 'undefined') {
             console.error("CRITICAL ERROR: Question data (questions.js) not loaded!");
             // Display error to user
             const container = document.getElementById('quiz-container');
             if(container) {
                 container.innerHTML = `<h1>Hata!</h1><p>YarÄ±ÅŸma verileri yÃ¼klenemedi. 'questions.js' dosyasÄ±nÄ±n 'index.html' ile aynÄ± klasÃ¶rde olduÄŸundan emin olun ve sayfayÄ± yenileyin.</p>`;
                 container.style.color = 'red'; container.style.textAlign = 'center';
             }
             return; // Stop script execution
        }

        // --- Oyuncu Bilgileri ---
        const players = [
            { id: 1, name: "Oyuncu 1", age: 0, score: 0, answered: false, themeClass: '', currentQuestion: null },
            { id: 2, name: "Oyuncu 2", age: 0, score: 0, answered: false, themeClass: '', currentQuestion: null },
            { id: 3, name: "Oyuncu 3", age: 0, score: 0, answered: false, themeClass: '', currentQuestion: null }
        ];
        // --- DeÄŸiÅŸkenler ---
        let currentSegmentIndex = 0;
        // let playersAnsweredCount = 0; // ArtÄ±k checkRoundCompletion kullanÄ±lÄ±yor
        let askedQuestionIds = [];

        // --- Element ReferanslarÄ± ---
        const nameEntrySection = document.getElementById('name-entry');
        const confirmNamesButton = document.getElementById('confirm-names-button');
        const ttsSupportWarning = document.getElementById('tts-support-warning');
        const quizContent = document.getElementById('quiz-content');
        const narrationArea = document.getElementById('narration-area');
        const narrationInfo = document.getElementById('narration-info');
        const playNarrationButton = document.getElementById('play-narration-btn');
        const scoreboardElement = document.getElementById('scoreboard');
        const scoreboardListElement = document.getElementById('scoreboard-list');
        const playersArea = document.getElementById('players-area');
        const loadingIndicator = document.getElementById('loading-indicator');
        const resultsElement = document.getElementById('results');
        const finalScoresElement = document.getElementById('final-scores');
        const restartButton = document.getElementById('restart-button');
        const winnerInfoElement = document.getElementById('winner-info');
        const nameInputs = []; const ageInputs = []; const nameDisplays = []; const ageDisplays = [];
        const playerAreaElements = []; const playerQuestionElements = []; const playerOptionsElements = []; const playerFeedbackElements = [];

        for (let i = 1; i <= 3; i++) {
            nameInputs.push(document.getElementById(`player-${i}-name-input`));
            ageInputs.push(document.getElementById(`player-${i}-age-input`));
            nameDisplays.push(document.getElementById(`player-${i}-name-display`));
            ageDisplays.push(document.getElementById(`player-${i}-age-display`));
            playerAreaElements.push(document.getElementById(`player-area-${i}`));
            playerQuestionElements.push(document.getElementById(`question-player-${i}`));
            playerOptionsElements.push(document.getElementById(`options-player-${i}`));
            playerFeedbackElements.push(document.getElementById(`feedback-player-${i}`));
        }

        // --- Fonksiyonlar ---
        function shuffleArray(array) {
            let currentIndex = array.length, randomIndex;
            while (currentIndex > 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            }
            return array;
        }

        // Scoreboard'u gÃ¼ncellerken puanÄ± artan oyuncuya animasyon ekler
        function updateScoreboard(scoringPlayerId = null) {
            if (!scoreboardListElement) return;
            scoreboardListElement.innerHTML = ''; // Ã–nce temizle

            const sortedByIdPlayers = [...players].sort((a, b) => a.id - b.id);

            sortedByIdPlayers.forEach(player => {
                if (player.age >= 7 && player.age <= 18) { // Sadece aktif oyuncular
                    const listItem = document.createElement('li');
                    // Oyuncu ID'sini data attribute olarak ekle (animasyon iÃ§in kolay bulmak adÄ±na)
                    listItem.dataset.playerId = player.id;
                    listItem.classList.add(player.themeClass); // Tema sÄ±nÄ±fÄ±nÄ± ekle (sol border iÃ§in)

                    const nameSpan = `<span class="name">${player.name}</span>`; // Tema sÄ±nÄ±fÄ± li'de olduÄŸu iÃ§in name span'dan kaldÄ±rÄ±labilir
                    const scoreSpan = `<span class="score">${player.score} Puan</span>`;
                    listItem.innerHTML = `${nameSpan}${scoreSpan}`;

                    // EÄŸer bu oyuncu yeni puan aldÄ±ysa, animasyon sÄ±nÄ±fÄ±nÄ± ekle
                    if (player.id === scoringPlayerId) {
                        listItem.classList.add('score-update-animation');
                        // Animasyon bittikten sonra sÄ±nÄ±fÄ± kaldÄ±r
                        setTimeout(() => {
                            listItem.classList.remove('score-update-animation');
                        }, 600); // CSS'teki animasyon sÃ¼resiyle eÅŸleÅŸmeli (--animation-duration)
                    }

                    scoreboardListElement.appendChild(listItem);
                }
            });
        }


        function getThemeClass(age) {
            if (age >= 7 && age <= 10) return 'theme-child';
            if (age >= 11 && age <= 14) return 'theme-teen';
            if (age >= 15 && age <= 18) return 'theme-young-adult';
            return 'theme-default';
        }

        function getThemeBorderColorVar(themeClass) {
            // Bu fonksiyon artÄ±k CSS deÄŸiÅŸkenlerini dÃ¶ndÃ¼rmÃ¼yor,
            // sadece border rengi ayarlamasÄ± iÃ§in kullanÄ±labilir (ama animasyonlu border'Ä± CSS hallediyor)
            // Yine de referans olarak kalabilir veya kaldÄ±rÄ±labilir.
             switch (themeClass) {
                case 'theme-child': return 'var(--theme-child-border)';
                case 'theme-teen': return 'var(--theme-teen-border)';
                case 'theme-young-adult': return 'var(--theme-young-adult-border)';
                default: return 'transparent';
            }
        }

        function loadSegment(segmentIndex) {
            if ('speechSynthesis' in window && window.speechSynthesis.speaking) {
                window.speechSynthesis.cancel();
            }

            if (segmentIndex >= quizSegments.length) {
                showResults(); return;
            }
            currentSegmentIndex = segmentIndex;
            const segmentData = quizSegments[segmentIndex];

            playerAreaElements.forEach(el => {
                if(el) el.classList.remove('visible', 'animate-correct', 'animate-incorrect'); // TÃ¼m durumlarÄ± temizle
            });
            if(playersArea) playersArea.style.display = 'none';


            if(loadingIndicator) loadingIndicator.style.display = 'none';
            if(narrationArea) narrationArea.style.display = 'block';
            if(scoreboardElement) scoreboardElement.style.display = 'block';
            if(narrationInfo) narrationInfo.textContent = `Segment ${segmentIndex + 1}: "${segmentData.narrationTitle}" konusunu dinlemek iÃ§in butona basÄ±n.`;
            if(playNarrationButton){
                 playNarrationButton.disabled = false;
                 playNarrationButton.textContent = "AnlatÄ±mÄ± Seslendir";
            }


            players.forEach(player => {
                if (player.age >= 7 && player.age <= 18) {
                    const feedbackEl = playerFeedbackElements[player.id-1];
                    const areaEl = playerAreaElements[player.id-1];
                    if(feedbackEl) feedbackEl.textContent = '';
                    // Border'Ä± CSS hallettiÄŸi iÃ§in JS'de sÄ±fÄ±rlamaya gerek yok (transparent baÅŸlangÄ±Ã§ deÄŸeri var)
                    // if(areaEl) { areaEl.style.borderColor = 'transparent'; }
                     // Varsa butonlardaki highlight'Ä± temizle
                     const optionsEl = playerOptionsElements[player.id - 1];
                     if (optionsEl) {
                        const buttons = optionsEl.getElementsByTagName('button');
                        for (let btn of buttons) {
                             btn.classList.remove('correct-answer-highlight', 'user-incorrect-choice');
                             btn.disabled = false; // ButonlarÄ± tekrar aktif et
                             btn.style.opacity = '1'; // OpaklÄ±ÄŸÄ± sÄ±fÄ±rla
                         }
                     }
                }
            });
            updateScoreboard(); // Skorbordu gÃ¶ster/gÃ¼ncelle (animasyonsuz)
        }

        function handleNarrationEnd() {
            console.log("Narration ended, loading questions...");
            if(playNarrationButton) {
                 playNarrationButton.textContent = "AnlatÄ±m Bitti";
                 playNarrationButton.disabled = true;
            }
            if(narrationArea) narrationArea.style.display = 'none';
            if(loadingIndicator) loadingIndicator.style.display = 'block';

            setTimeout(() => {
                loadQuestionsForPlayers(currentSegmentIndex);
                if(loadingIndicator) loadingIndicator.style.display = 'none';
                if(playersArea) playersArea.style.display = 'flex';
                players.forEach(player => {
                     if (player.age >= 7 && player.age <= 18) {
                         const areaEl = playerAreaElements[player.id - 1];
                         if(areaEl) areaEl.classList.add('visible');
                     }
                });

            }, 500);
        }


        function loadQuestionsForPlayers(segmentIdx) {
            // playersAnsweredCount = 0; // ArtÄ±k kullanÄ±lmÄ±yor
            let currentRoundSelectedIds = [];

            players.forEach(player => {
                if (!(player.age >= 7 && player.age <= 18)) {
                    player.answered = true; // Aktif olmayanlarÄ± cevaplamÄ±ÅŸ say
                    return;
                }

                player.answered = false;
                player.currentQuestion = null;
                const optionsEl = playerOptionsElements[player.id-1];
                const feedbackEl = playerFeedbackElements[player.id-1];
                const questionEl = playerQuestionElements[player.id-1];
                const sectionEl = playerAreaElements[player.id-1]; // Kart alanÄ±

                 // Ã–nceki animasyon sÄ±nÄ±flarÄ±nÄ± temizle
                 if (sectionEl) {
                     sectionEl.classList.remove('animate-correct', 'animate-incorrect');
                     sectionEl.style.borderColor = 'transparent'; // BaÅŸlangÄ±Ã§ border'Ä±
                 }


                if (optionsEl) optionsEl.innerHTML = '';
                if (feedbackEl) feedbackEl.textContent = '';
                if (questionEl) questionEl.textContent = 'Soru aranÄ±yor...';


                const suitableQuestions = questionPool.filter(q =>
                    q.segmentId === quizSegments[segmentIdx].segmentId &&
                    player.age >= q.minAge &&
                    player.age <= q.maxAge &&
                    !askedQuestionIds.includes(q.questionId) &&
                    !currentRoundSelectedIds.includes(q.questionId)
                );

                let questionData = null;
                if (suitableQuestions.length > 0) {
                    questionData = suitableQuestions[Math.floor(Math.random() * suitableQuestions.length)];
                    player.currentQuestion = questionData;
                    askedQuestionIds.push(questionData.questionId);
                    currentRoundSelectedIds.push(questionData.questionId);

                    if (questionEl) questionEl.textContent = questionData.questionText;
                    if (optionsEl) {
                        const shuffledOptions = shuffleArray([...questionData.options]);
                        shuffledOptions.forEach(option => {
                            const button = document.createElement('button');
                            button.textContent = option;
                            button.onclick = () => handleAnswer(player.id, option);
                            optionsEl.appendChild(button);
                        });
                    }
                } else {
                    if (questionEl) questionEl.textContent = 'Size uygun soru bulunamadÄ±.';
                    player.answered = true; // CevaplanmÄ±ÅŸ say
                }
            });

            // Turun bitip bitmediÄŸini baÅŸlangÄ±Ã§ta da kontrol et (belki kimseye soru bulunamadÄ±)
            checkRoundCompletion();
        }

        // Aktif oyuncularÄ±n hepsinin cevaplayÄ±p cevaplamadÄ±ÄŸÄ±nÄ± kontrol eder
        function checkRoundCompletion() {
            const activePlayers = players.filter(p => p.age >= 7 && p.age <= 18);
            // EÄŸer hiÃ§ aktif oyuncu yoksa veya tÃ¼m aktif oyuncular cevapladÄ±ysa
            if (activePlayers.length === 0 || activePlayers.every(p => p.answered)) {
                // KÄ±sa bir gecikme ile sonraki segmente geÃ§ (animasyonlarÄ±n bitmesi iÃ§in)
                setTimeout(() => {
                    console.log("Round completed, moving to next segment.");
                    if(loadingIndicator) loadingIndicator.style.display = 'block';
                    playerAreaElements.forEach(el => {
                        if(el) el.classList.remove('visible');
                    });
                    setTimeout(() => { // Display none iÃ§in ek gecikme
                        if(playersArea) playersArea.style.display = 'none';
                        loadSegment(currentSegmentIndex + 1);
                    }, 300); // CSS transition sÃ¼resi kadar
                }, 1500); // Cevap sonrasÄ± bekleme sÃ¼resi (animasyon + okuma)
            }
        }


        function handleAnswer(playerId, selectedOption) {
            const player = players.find(p => p.id === playerId);
            if (!player || player.answered || !player.currentQuestion || !(player.age >= 7 && player.age <= 18)) return;

            player.answered = true;

            const feedbackEl = playerFeedbackElements[player.id - 1];
            const sectionEl = playerAreaElements[player.id - 1];
            const optionsEl = playerOptionsElements[player.id - 1]; // SeÃ§eneklerin olduÄŸu div
            const playerOptionButtons = optionsEl?.getElementsByTagName('button');

            if (!feedbackEl || !sectionEl || !optionsEl || !playerOptionButtons) {
                console.error(`UI elements not found for player ${playerId}.`);
                return;
            }

            // TÃ¼m butonlarÄ± devre dÄ±ÅŸÄ± bÄ±rak
            for (let btn of playerOptionButtons) {
                btn.disabled = true;
                // DoÄŸru cevabÄ± iÃ§eren butonu bul ve vurgula
                if (btn.textContent === player.currentQuestion.correctAnswer) {
                    btn.classList.add('correct-answer-highlight');
                }
                 // KullanÄ±cÄ±nÄ±n seÃ§tiÄŸi yanlÄ±ÅŸsa onu da iÅŸaretle (opsiyonel)
                 if (btn.textContent === selectedOption && selectedOption !== player.currentQuestion.correctAnswer) {
                     btn.classList.add('user-incorrect-choice');
                 }
            }

            let scored = false; // Puan alÄ±p almadÄ±ÄŸÄ±nÄ± takip et

            // DoÄŸru/YanlÄ±ÅŸ kontrolÃ¼, ses Ã§alma ve animasyon
            if (selectedOption === player.currentQuestion.correctAnswer) {
                player.score++;
                scored = true; // Puan aldÄ±
                if(feedbackEl){
                     feedbackEl.textContent = "DoÄŸru!";
                     feedbackEl.className = 'player-feedback feedback-correct';
                }
                if(sectionEl) sectionEl.classList.add('animate-correct');
                correctSound.play(); // DoÄŸru sesini Ã§al
            } else {
                if(feedbackEl){
                     feedbackEl.textContent = `YanlÄ±ÅŸ! DoÄŸru: ${player.currentQuestion.correctAnswer}`;
                     feedbackEl.className = 'player-feedback feedback-incorrect';
                }
                if(sectionEl) sectionEl.classList.add('animate-incorrect');
                incorrectSound.play(); // YanlÄ±ÅŸ sesini Ã§al
            }

             // Animasyon sÄ±nÄ±flarÄ±nÄ± belirli bir sÃ¼re sonra kaldÄ±r
             const animationDuration = 600; // CSS'teki --animation-duration ile eÅŸleÅŸmeli (ms cinsinden)
             setTimeout(() => {
                 if(sectionEl) sectionEl.classList.remove('animate-correct', 'animate-incorrect');
             }, animationDuration);


            // Skorbordu gÃ¼ncelle, puan alÄ±ndÄ±ysa animasyon iÃ§in ID'yi gÃ¶nder
            updateScoreboard(scored ? player.id : null);

            // Turun bitip bitmediÄŸini kontrol et
            checkRoundCompletion();
        }


        function showResults() {
            if ('speechSynthesis' in window && window.speechSynthesis.speaking) {
               window.speechSynthesis.cancel();
            }
           if(quizContent) quizContent.style.display = 'none';
           if(resultsElement) resultsElement.style.display = 'block';
           if(finalScoresElement) finalScoresElement.innerHTML = '';
           let maxScore = -1;
           let winners = [];

           const activePlayers = players.filter(p => p.age >= 7 && p.age <= 18);
           const sortedPlayers = [...activePlayers].sort((a, b) => b.score - a.score);

           if (sortedPlayers.length === 0) {
                if(winnerInfoElement) winnerInfoElement.textContent = "YarÄ±ÅŸmaya katÄ±lan oyuncu bulunamadÄ±.";
                return;
           }

           sortedPlayers.forEach(player => {
               const resultLine = document.createElement('div');
               resultLine.classList.add('result-line');
               // SonuÃ§ satÄ±rÄ±na da tema sÄ±nÄ±fÄ± ekle (opsiyonel)
               // resultLine.classList.add(player.themeClass);
               resultLine.innerHTML = `<span class="name ${player.themeClass}">${player.name} (${player.age} yaÅŸ)</span> <span class="score">${player.score} Puan</span>`;
               if(finalScoresElement) finalScoresElement.appendChild(resultLine);

               if (player.score > maxScore) {
                   maxScore = player.score;
                   winners = [player.name];
               } else if (player.score === maxScore && maxScore >= 0) {
                   winners.push(player.name);
               }
           });

            if(winnerInfoElement){
                if (maxScore <= 0 ) {
                        winnerInfoElement.textContent = "Kimse puan alamadÄ± veya yeterli soru bulunamadÄ±!";
                        winnerInfoElement.style.background = 'rgba(200, 200, 200, 0.1)'; // NÃ¶tr arka plan
                        winnerInfoElement.style.borderColor = 'rgba(150, 150, 150, 0.3)';
                        winnerInfoElement.style.color = 'var(--primary-text)'; // Normal metin rengi
                } else if (winners.length > 1) {
                    winnerInfoElement.textContent = `ðŸ† Kazananlar (Berabere): ${winners.join(', ')} (${maxScore} puan)! ðŸŽ‰`;
                    winnerInfoElement.style.background = 'linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 165, 0, 0.1))'; // AltÄ±n rengi arka plan
                    winnerInfoElement.style.borderColor = 'rgba(255, 193, 7, 0.3)';
                    winnerInfoElement.style.color = 'var(--winner-color)'; // Kazanan rengi
                } else {
                    winnerInfoElement.textContent = `ðŸ† Kazanan: ${winners[0]} (${maxScore} puan)! ðŸŽ‰`;
                     winnerInfoElement.style.background = 'linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 165, 0, 0.1))';
                    winnerInfoElement.style.borderColor = 'rgba(255, 193, 7, 0.3)';
                     winnerInfoElement.style.color = 'var(--winner-color)';
                }
            }
        }

        // initializeQuiz, startQuiz, resetToNameEntry, checkTtsSupport fonksiyonlarÄ±
        // Ã¶nceki cevapta olduÄŸu gibi kalabilir, Ã¶nemli bir deÄŸiÅŸiklik gerektirmiyorlar.
        // Sadece initializeQuiz iÃ§inde oyuncu alanlarÄ±nÄ±n baÅŸlangÄ±Ã§ta gizlenmesi/gÃ¶sterilmesi
        // ve resetToNameEntry iÃ§inde skor tablosunun gizlenmesi gibi kÃ¼Ã§Ã¼k UI ayarlamalarÄ± yapÄ±ldÄ±.

         function initializeQuiz() {
            let allAgesValid = true;
            let playerCount = 0;

            players.forEach((player, index) => {
                const nameInput = nameInputs[index];
                const ageInput = ageInputs[index];
                const areaEl = playerAreaElements[player.id - 1];

                if (!nameInput || !ageInput) {
                    console.error(`Input elements not found for player ${index + 1}.`);
                    if(areaEl) areaEl.style.display = 'none';
                    return;
                }

                const name = nameInput.value.trim();
                const ageString = ageInput.value;

                if (name === '' && ageString === '') {
                    player.age = 0; player.score = 0; player.themeClass = '';
                    if (areaEl) areaEl.style.display = 'none';
                    return;
                }

                playerCount++;
                player.name = name === '' ? `Oyuncu ${player.id}` : name;
                const age = parseInt(ageString);

                if (isNaN(age) || age < 7 || age > 18) {
                    alert(`Oyuncu "${player.name}" iÃ§in geÃ§erli bir yaÅŸ (7-18 arasÄ±) girmelisiniz veya alanÄ± boÅŸ bÄ±rakmalÄ±sÄ±nÄ±z.`);
                    if(ageInput) ageInput.style.border = '2px solid red';
                    allAgesValid = false;
                    player.age = 0;
                    if (areaEl) areaEl.style.display = 'flex'; // HatalÄ±ysa da gÃ¶ster
                } else {
                    player.age = age;
                    player.themeClass = getThemeClass(age);
                    if(ageInput) ageInput.style.border = '';
                    if (areaEl) areaEl.style.display = 'flex';
                }
                player.score = 0; player.answered = false; player.currentQuestion = null;
            });

            if (!allAgesValid || playerCount === 0) {
                 if (playerCount === 0 && allAgesValid) alert("LÃ¼tfen en az bir oyuncu iÃ§in isim ve yaÅŸ girin.");
                 return;
             }

            players.forEach((player) => {
                 if (player.age >= 7 && player.age <= 18) {
                    const areaEl = playerAreaElements[player.id - 1];
                    const nameEl = nameDisplays[player.id - 1];
                    const ageEl = ageDisplays[player.id - 1];

                    if (areaEl) {
                        areaEl.className = `player-quiz-area ${player.themeClass}`; // Tema sÄ±nÄ±fÄ±nÄ± ayarla
                         areaEl.style.display = 'flex';
                         areaEl.style.borderColor = 'transparent'; // BaÅŸlangÄ±Ã§ border'Ä±
                         areaEl.classList.remove('visible', 'animate-correct', 'animate-incorrect'); // TÃ¼m durumlarÄ± temizle
                    } else { console.error(`player-area-${player.id} not found`); }

                    if (nameEl) { nameEl.textContent = player.name; }
                    else { console.error(`player-${player.id}-name-display not found`); }

                    if (ageEl) { ageEl.textContent = `(${player.age} yaÅŸ)`; }
                    else { console.error(`player-${player.id}-age-display not found`); }
                } else {
                     const areaEl = playerAreaElements[player.id - 1];
                     if (areaEl) areaEl.style.display = 'none'; // Aktif olmayanlarÄ± gizle
                }
            });

            if(nameEntrySection) nameEntrySection.style.display = 'none';
            if(resultsElement) resultsElement.style.display = 'none';
            if(quizContent) quizContent.style.display = 'block'; // Quiz'i gÃ¶ster
             if(scoreboardElement) scoreboardElement.style.display = 'block'; // Skorbordu gÃ¶ster
            startQuiz();
        }

        function startQuiz() {
            askedQuestionIds = [];
            currentSegmentIndex = 0;
            updateScoreboard(); // BaÅŸlangÄ±Ã§ skorbordunu gÃ¶ster
            loadSegment(currentSegmentIndex);
        }

         function resetToNameEntry() {
            if ('speechSynthesis' in window && window.speechSynthesis.speaking) {
               window.speechSynthesis.cancel();
            }
            if(quizContent) quizContent.style.display = 'none';
            if(resultsElement) resultsElement.style.display = 'none';
             if(scoreboardElement) scoreboardElement.style.display = 'none'; // Skorbordu gizle
            if(nameEntrySection) nameEntrySection.style.display = 'flex';

             nameInputs.forEach(input => { if(input) input.value = ''; });
             ageInputs.forEach(input => { if(input) { input.value = ''; input.style.border = ''; } });

              // Oyuncu alanlarÄ±nÄ± tekrar gÃ¶rÃ¼nÃ¼r yap (isim giriÅŸi iÃ§in)
              // initializeQuiz zaten gizleyecek/gÃ¶sterecek, bu yÃ¼zden isteÄŸe baÄŸlÄ±
              // playerAreaElements.forEach(el => { if(el) el.style.display = 'flex'; });

            checkTtsSupport();
        }

       function checkTtsSupport() {
           const hasTts = 'speechSynthesis' in window && window.speechSynthesis;
           const warningEl = document.getElementById('tts-support-warning');
           if (warningEl) {
                warningEl.style.display = hasTts ? 'none' : 'block';
           }
           if (playNarrationButton) {
               playNarrationButton.disabled = false;
               playNarrationButton.textContent = "AnlatÄ±mÄ± Seslendir";
           }
       }


        // --- Olay Dinleyicileri ---
        if (confirmNamesButton) { confirmNamesButton.addEventListener('click', initializeQuiz); }
        else { console.error("confirm-names-button not found!"); }

        if (restartButton) { restartButton.addEventListener('click', resetToNameEntry); }
        else { console.error("restart-button not found!"); }

        if (playNarrationButton) {
            playNarrationButton.addEventListener('click', () => {
                if (!('speechSynthesis' in window) || !window.speechSynthesis) {
                    alert("TarayÄ±cÄ±nÄ±z metin seslendirme Ã¶zelliÄŸini desteklemiyor.");
                    handleNarrationEnd();
                    return;
                 }
                  window.speechSynthesis.cancel();

                if (typeof quizSegments === 'undefined' || !quizSegments[currentSegmentIndex] || !quizSegments[currentSegmentIndex].narrationText) {
                     console.error("Narration text not found or segment data missing!");
                     alert("Seslendirilecek anlatÄ±m metni bulunamadÄ±!");
                     handleNarrationEnd();
                     return;
                }
                const segmentData = quizSegments[currentSegmentIndex];
                const utterance = new SpeechSynthesisUtterance(segmentData.narrationText);
                utterance.lang = 'tr-TR'; utterance.rate = 0.9; utterance.pitch = 1;

                utterance.onend = handleNarrationEnd;
                utterance.onerror = (event) => {
                    console.error('TTS Error:', event);
                    alert(`Seslendirme sÄ±rasÄ±nda bir hata oluÅŸtu: ${event.error}. Sorulara devam edilecek.`);
                    if(playNarrationButton){
                         playNarrationButton.textContent = "Hata!";
                         playNarrationButton.disabled = false;
                    }
                    handleNarrationEnd();
                };

                playNarrationButton.disabled = true; playNarrationButton.textContent = "Seslendiriliyor...";
                window.speechSynthesis.speak(utterance);
            });
        } else { console.error("play-narration-btn not found!"); }


        // --- BaÅŸlangÄ±Ã§ ---
        resetToNameEntry(); // Uygulama yÃ¼klendiÄŸinde isim giriÅŸiyle baÅŸla

    }); // DOMContentLoaded Sonu
</script>
