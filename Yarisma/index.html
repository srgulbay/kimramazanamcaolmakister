<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TTS Destekli İslami Bilgi Yarışması (Düzeltilmiş)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
        :root {
            --primary-bg: linear-gradient(135deg, #667eea, #764ba2);
            --container-bg: rgba(255, 255, 255, 0.98);
            --question-bg: #e8eaf6;
            --scoreboard-bg: #eceff1;
            --player-bg: #f3e5f5;
            --primary-text: #333;
            --header-color: #3f51b5;
            --subheader-color: #5e35b1;
            --player-name-color: #6a1b9a;
            --button-gradient: linear-gradient(145deg, #ab47bc, #8e24aa);
            --button-hover-gradient: linear-gradient(145deg, #8e24aa, #ab47bc);
            --start-button-gradient: linear-gradient(145deg, #29b6f6, #0288d1);
            --start-button-hover-gradient: linear-gradient(145deg, #0288d1, #29b6f6);
            --correct-color: #2e7d32;
            --incorrect-color: #c62828;
            --correct-border: #66bb6a;
            --incorrect-border: #ef5350;
            --winner-color: #ff6f00;
        }
        body {
            font-family: 'Poppins', sans-serif; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; background: var(--primary-bg); color: var(--primary-text); padding: 20px; box-sizing: border-box;
        }
        #quiz-container {
            background-color: var(--container-bg); padding: 25px 35px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2); text-align: center; width: 100%; max-width: 900px;
        }
        h1, h2 { color: var(--header-color); margin-bottom: 25px; }
        h2 { color: var(--subheader-color); }
        #name-entry { padding: 20px; border: 1px solid #ddd; border-radius: 10px; margin-bottom: 20px; background-color: #fafafa; }
        .input-group { margin-bottom: 15px; text-align: left; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: 600; color: var(--player-name-color); }
        .input-group input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 1em; box-sizing: border-box; }
        #quiz-content { display: none; }
        #narration-area { margin-bottom: 25px; padding: 15px; background-color: var(--question-bg); border-radius: 10px; text-align: center; }
        #narration-area p { font-style: italic; color: #555; margin-bottom: 15px; }
         #play-narration-btn { padding: 10px 20px; font-size: 1em; cursor: pointer; background: var(--start-button-gradient); color: white; border: none; border-radius: 8px; transition: background-color 0.3s; }
         #play-narration-btn:disabled { background-color: #aaa; cursor: not-allowed; }
         #question-display-area { padding: 10px 0; border-radius: 10px; margin-bottom: 25px; min-height: 60px; display: flex; justify-content: center; align-items: center; font-size: 1.3em; font-weight: 600; }
         #current-question-text { }
         #scoreboard { background-color: var(--scoreboard-bg); padding: 15px 20px; border-radius: 10px; margin-bottom: 25px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
         #scoreboard h3 { margin: 0 0 10px 0; color: var(--subheader-color); font-size: 1.3em; }
         #scoreboard-list { list-style: none; padding: 0; margin: 0; text-align: left; }
         #scoreboard-list li { display: flex; justify-content: space-between; padding: 8px 5px; border-bottom: 1px solid #ddd; font-size: 1.1em; transition: background-color 0.3s ease; }
         #scoreboard-list li:last-child { border-bottom: none; }
         #scoreboard-list li:nth-child(1) { font-weight: 700; color: #d32f2f; }
         #scoreboard-list li:nth-child(2) { font-weight: 600; color: #7b1fa2; }
         #scoreboard-list li:nth-child(3) { font-weight: 600; color: #1976d2; }
         #scoreboard-list .rank { font-weight: bold; margin-right: 10px; min-width: 25px; display: inline-block; text-align: right; }
         #scoreboard-list .name { flex-grow: 1; margin-right: 10px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
         #scoreboard-list .score { font-weight: bold; min-width: 60px; text-align: right; }
         #players-area { display: flex; justify-content: space-around; flex-wrap: wrap; gap: 20px; margin-bottom: 25px; }
         .player-section { background-color: var(--player-bg); padding: 15px; border-radius: 10px; flex: 1 1 250px; min-width: 220px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); transition: transform 0.2s ease, border 0.3s ease; border: 3px solid transparent; }
         .player-name { font-weight: 600; font-size: 1.1em; margin-bottom: 10px; color: var(--player-name-color); word-wrap: break-word; }
         .player-score { font-size: 1em; margin-bottom: 15px; }
         .player-options button { display: block; width: 100%; padding: 10px; margin: 8px 0; border: none; border-radius: 8px; background: var(--button-gradient); color: white; cursor: pointer; font-size: 1em; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.15); }
         .player-options button:hover:not(:disabled) { background: var(--button-hover-gradient); box-shadow: 0 4px 8px rgba(0,0,0,0.2); transform: scale(1.03); }
         .player-options button:disabled { background: #cccccc; cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none; }
         .player-feedback { min-height: 25px; margin-top: 10px; font-weight: 600; font-size: 0.9em; }
         .feedback-correct { color: var(--correct-color); }
         .feedback-incorrect { color: var(--incorrect-color); }
         #results { display: none; margin-top: 30px; }
         #final-scores { margin-bottom: 20px;}
         .result-line { font-size: 1.2em; margin: 10px 0; padding: 8px; border-radius: 5px; background-color: #f0f0f0; display: flex; justify-content: space-between; }
         .result-line .name { font-weight: 600; color: var(--player-name-color); flex-grow: 1; text-align: left; margin-right: 10px; }
         .result-line .score { font-weight: bold; }
         #winner-info { font-size: 1.4em; font-weight: bold; color: var(--winner-color); margin-top: 15px; }
         #confirm-names-button, #restart-button { padding: 12px 25px; font-size: 1.2em; font-weight: 600; cursor: pointer; margin-top: 20px; background: var(--start-button-gradient); color: white; border: none; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.15); transition: all 0.3s ease; }
         #confirm-names-button:hover, #restart-button:hover { background: var(--start-button-hover-gradient); box-shadow: 0 6px 12px rgba(0,0,0,0.2); transform: translateY(-2px); }
    </style>
</head>
<body>
    <div id="quiz-container">
        <h1>TTS Destekli İslami Bilgi Yarışması (Düzeltilmiş)</h1>

        <div id="name-entry">
            <h2>Oyuncu İsimlerini Girin</h2>
            <div class="input-group"> <label for="player-1-name-input">Oyuncu 1:</label> <input type="text" id="player-1-name-input" placeholder="İsim Girin..." maxlength="20"> </div>
            <div class="input-group"> <label for="player-2-name-input">Oyuncu 2:</label> <input type="text" id="player-2-name-input" placeholder="İsim Girin..." maxlength="20"> </div>
            <div class="input-group"> <label for="player-3-name-input">Oyuncu 3:</label> <input type="text" id="player-3-name-input" placeholder="İsim Girin..." maxlength="20"> </div>
            <button id="confirm-names-button">Yarışmayı Başlat</button>
            <p id="tts-support-warning" style="color: red; margin-top: 10px; display: none;">Tarayıcınız metin seslendirme özelliğini desteklemiyor olabilir.</p>
        </div>

        <div id="quiz-content">
            <div id="narration-area" style="display: none;">
                <p id="narration-info">Şimdi dikkatle dinleyin...</p>
                <button id="play-narration-btn">Anlatımı Seslendir</button>
            </div>
            <div id="question-display-area" style="display: none;">
                 <span id="current-question-text">Soru burada görünecek...</span>
            </div>
            <div id="scoreboard" style="display: none;">
                 <h3>Skor Tablosu</h3>
                 <ul id="scoreboard-list"></ul>
            </div>
            <div id="players-area" style="display: none;">
                 <div class="player-section" id="player-1-section"> <div class="player-name" id="player-1-name-display"></div> <div class="player-score" id="score-player-1"></div> <div class="player-options" id="options-player-1"></div> <div class="player-feedback" id="feedback-player-1"></div> </div>
                 <div class="player-section" id="player-2-section"> <div class="player-name" id="player-2-name-display"></div> <div class="player-score" id="score-player-2"></div> <div class="player-options" id="options-player-2"></div> <div class="player-feedback" id="feedback-player-2"></div> </div>
                 <div class="player-section" id="player-3-section"> <div class="player-name" id="player-3-name-display"></div> <div class="player-score" id="score-player-3"></div> <div class="player-options" id="options-player-3"></div> <div class="player-feedback" id="feedback-player-3"></div> </div>
            </div>
        </div>

        <div id="results">
             <h2>Yarışma Bitti!</h2>
             <div id="final-scores"></div>
             <p id="winner-info"></p>
             <button id="restart-button">Yeni Oyun (Yeni İsimlerle)</button>
        </div>
    </div>

    <script>
        // TÜM JAVASCRIPT KODU BURADA, DOMContentLoaded içinde
        document.addEventListener('DOMContentLoaded', () => {

            // --- Veri Yapısı ---
            const quizSegments = [
                {
                    segmentId: 1,
                    narrationTitle: "Fatiha Suresi (Ayet 1-4)",
                    narrationText: "Rahmân ve Rahîm olan Allah'ın adıyla. Hamd, âlemlerin Rabbi Allah’a mahsustur. O, Rahmân’dır, Rahîm’dir. Hesap gününün sahibidir.",
                    relatedQuestions: [
                        { id: 1, questionText: "Dinlediğiniz metnin başında hangi isimle başlanıyor?", options: ["Peygamberin adıyla", "Meleklerin adıyla", "Allah'ın adıyla", "Kendi adıyla"], correctAnswer: "Allah'ın adıyla", type: "Dikkat" },
                        { id: 2, questionText: "'Hamd' kelimesi kimin içindir?", options: ["Peygamberler için", "Melekler için", "Tüm insanlar için", "Alemlerin Rabbi Allah için"], correctAnswer: "Alemlerin Rabbi Allah için", type: "Anlama" },
                        { id: 3, questionText: "Metinde Allah için hangi sıfatlar geçmektedir?", options: ["Rahman ve Rahim", "Melik ve Kuddüs", "Aziz ve Cebbar", "Alim ve Hakim"], correctAnswer: "Rahman ve Rahim", type: "Dikkat" },
                        { id: 4, questionText: "Allah, hangi günün sahibidir?", options: ["Cuma gününün", "Hesap gününün", "Kadir gecesinin", "Bayram gününün"], correctAnswer: "Hesap gününün", type: "Anlama" }
                    ]
                },
                {
                    segmentId: 2,
                    narrationTitle: "Hadis-i Şerif (Ameller ve Niyetler)",
                    narrationText: "Peygamber Efendimiz sallallahu aleyhi ve sellem şöyle buyurmuştur: Ameller ancak niyetlere göredir. Herkes için ancak niyet ettiği şey vardır. Kimin hicreti Allah'a ve Resûlü'ne ise, onun hicreti Allah'a ve Resûlü'nedir. Kimin hicreti de elde edeceği bir dünyalığa veya evleneceği bir kadına ise, onun hicreti de hicret ettiği şeyedir.",
                    relatedQuestions: [
                        { id: 5, questionText: "Dinlediğiniz hadise göre amellerin değeri neye bağlıdır?", options: ["Çokluğuna", "Zorluğuna", "Niyetlere", "Gizliliğine"], correctAnswer: "Niyetlere", type: "Anlama" },
                        { id: 6, questionText: "Hadiste bahsedilen 'hicret' ne anlama gelebilir?", options: ["Sadece Mekke'den Medine'ye göç", "Bir yerden bir yere taşınmak", "Kötülükten iyiliğe yönelmek/Allah yolunda yapılan her türlü fedakarlık", "Sadece savaşmak"], correctAnswer: "Kötülükten iyiliğe yönelmek/Allah yolunda yapılan her türlü fedakarlık", type: "Çıkarım/Anlama" },
                        { id: 7, questionText: "Hadise göre, sadece dünyalık için yapılan bir işin Allah katındaki durumu ne olabilir?", options: ["Yine de sevap kazandırır", "Niyetine göre karşılık bulur (dünyalık)", "En büyük ameldir", "Cezalandırılır"], correctAnswer: "Niyetine göre karşılık bulur (dünyalık)", type: "Çıkarım" },
                        { id: 8, questionText: "Hadiste kimin hicretinin Allah'a ve Resulü'ne olduğu belirtiliyor?", options: ["Zengin olanların", "Güçlü olanların", "Niyeti Allah ve Resulü olanların", "Yalnız yaşayanların"], correctAnswer: "Niyeti Allah ve Resulü olanların", type: "Dikkat" }
                    ]
                },
                {
                    segmentId: 3,
                    narrationTitle: "İhlas Suresi",
                    narrationText: "Rahmân ve Rahîm olan Allah'ın adıyla. De ki: O Allah birdir. Allah Samed'dir (Her şey O'na muhtaçtır, O kimseye muhtaç değildir). O doğurmamış ve doğmamıştır. Hiçbir şey O'na denk değildir.",
                     relatedQuestions: [
                        { id: 9, questionText: "Surenin başında Allah'ın hangi özelliği vurgulanıyor?", options: ["Her şeyi affetmesi", "Çok merhametli olması", "Bir (tek) olması", "Her şeyi bilmesi"], correctAnswer: "Bir (tek) olması", type: "Dikkat" },
                        { id: 10, questionText: "'Samed' ne demektir?", options: ["Doğurmamış ve doğmamış olan", "Her şeyin kendisine muhtaç olduğu", "Eşi ve benzeri olmayan", "Cezalandıran"], correctAnswer: "Her şeyin kendisine muhtaç olduğu", type: "Anlama" },
                        { id: 11, questionText: "Allah hakkında 'doğurmamış ve doğmamıştır' ifadesi neyi belirtir?", options: ["Onun başlangıcı ve sonu olmadığını", "Onun çocukları olmadığını ve anne-babası olmadığını", "Onun çok güçlü olduğunu", "Onun her yerde olduğunu"], correctAnswer: "Onun çocukları olmadığını ve anne-babası olmadığını", type: "Dikkat/Anlama" },
                        { id: 12, questionText: "Surenin sonunda Allah'ın hangi özelliği tekrar vurgulanır?", options: ["Merhameti", "Adaleti", "Eşi ve benzerinin olmadığı", "Cömertliği"], correctAnswer: "Eşi ve benzerinin olmadığı", type: "Çıkarım" }
                    ]
                },
                {
                    segmentId: 4,
                    narrationTitle: "Sabrın Önemi",
                    narrationText: "Sabır, imanın yarısıdır. Zorluklar karşısında yılgınlık göstermemek, aceleci davranmamak ve Allah'tan yardım dileyerek beklemektir. Sabredenler, sonunda mutlaka mükafatlarını alırlar. Unutmayın, her zorlukla beraber bir kolaylık vardır.",
                    relatedQuestions: [
                        { id: 13, questionText: "Metne göre sabır, neyin yarısıdır?", options: ["Hayatın", "Zenginliğin", "İmanın", "Mutluluğun"], correctAnswer: "İmanın", type: "Anlama" },
                        { id: 14, questionText: "Sabredenlerin sonunda ne alacağı belirtiliyor?", options: ["Daha fazla zorluk", "Unutulmak", "Mükafatlarını", "Pişmanlık"], correctAnswer: "Mükafatlarını", type: "Dikkat" },
                        { id: 15, questionText: "Metindeki 'Her zorlukla beraber bir kolaylık vardır' ifadesi neyi anlatır?", options: ["Zorlukların hiç bitmeyeceğini", "Kolaylığın zorluktan sonra geldiğini", "Umutlu olmayı ve Allah'ın yardımının geleceğini", "Sadece kolaylığa odaklanmayı"], correctAnswer: "Umutlu olmayı ve Allah'ın yardımının geleceğini", type: "Çıkarım" }
                    ]
                }
            ];

            // --- Oyuncu Bilgileri ---
            const players = [
                { id: 1, name: "Oyuncu 1", score: 0, answered: false },
                { id: 2, name: "Oyuncu 2", score: 0, answered: false },
                { id: 3, name: "Oyuncu 3", score: 0, answered: false }
            ];

            // --- Değişkenler ---
            let currentSegmentIndex = 0;
            let currentQuestionSubIndex = 0;
            let totalQuestionsAnswered = 0;
            let playersAnsweredCount = 0;

            // --- Element Referansları ---
            const nameEntrySection = document.getElementById('name-entry');
            const confirmNamesButton = document.getElementById('confirm-names-button');
            const ttsSupportWarning = document.getElementById('tts-support-warning');
            const quizContent = document.getElementById('quiz-content');
            const narrationArea = document.getElementById('narration-area');
            const narrationInfo = document.getElementById('narration-info');
            const playNarrationButton = document.getElementById('play-narration-btn');
            const questionDisplayArea = document.getElementById('question-display-area');
            const currentQuestionTextElement = document.getElementById('current-question-text');
            const scoreboardElement = document.getElementById('scoreboard');
            const scoreboardListElement = document.getElementById('scoreboard-list');
            const playersArea = document.getElementById('players-area');
            const resultsElement = document.getElementById('results');
            const finalScoresElement = document.getElementById('final-scores');
            const restartButton = document.getElementById('restart-button');
            const winnerInfoElement = document.getElementById('winner-info');
            const nameInputs = []; const nameDisplays = [];
            for (let i = 1; i <= 3; i++) {
                nameInputs.push(document.getElementById(`player-${i}-name-input`));
                nameDisplays.push(document.getElementById(`player-${i}-name-display`));
            }

            // --- Fonksiyonlar ---
            // function playSound(soundElement) { /* Kaldırıldı */ }

            function shuffleArray(array) {
                let currentIndex = array.length, randomIndex;
                while (currentIndex !== 0) { randomIndex = Math.floor(Math.random() * currentIndex); currentIndex--; [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]]; }
                return array;
            }

            function updateScoreboard() {
                const sortedPlayers = [...players].sort((a, b) => b.score - a.score);
                scoreboardListElement.innerHTML = '';
                sortedPlayers.forEach((player, index) => {
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `<span class="rank">${index + 1}.</span> <span class="name">${player.name}</span> <span class="score">${player.score} Puan</span>`;
                    scoreboardListElement.appendChild(listItem);
                });
            }

            function loadSegment(segmentIndex) {
                window.speechSynthesis.cancel(); // Önceki seslendirmeyi durdur
                if (segmentIndex >= quizSegments.length) {
                    showResults(); return;
                }
                currentSegmentIndex = segmentIndex;
                currentQuestionSubIndex = 0;
                const segmentData = quizSegments[segmentIndex];
                questionDisplayArea.style.display = 'none';
                playersArea.style.display = 'none';
                narrationArea.style.display = 'block';
                scoreboardElement.style.display = 'block';
                narrationInfo.textContent = `Segment ${segmentIndex + 1}: "${segmentData.narrationTitle}" konusunu dinlemek için butona basın.`;
                playNarrationButton.disabled = false;
                playNarrationButton.textContent = "Anlatımı Seslendir";
                players.forEach(player => {
                     const feedbackEl = document.getElementById(`feedback-player-${player.id}`);
                     if(feedbackEl) feedbackEl.textContent = '';
                     const sectionEl = document.getElementById(`player-${player.id}-section`);
                     if(sectionEl) sectionEl.style.border = '3px solid transparent';
                });
                updateScoreboard();
            }

            function handleNarrationEnd() {
                console.log("Seslendirme bitti.");
                playNarrationButton.textContent = "Anlatım Bitti";
                playNarrationButton.disabled = true;
                loadRelatedQuestion(currentSegmentIndex, 0);
            }

            function loadRelatedQuestion(segmentIdx, questionSubIdx) {
                 const segmentData = quizSegments[segmentIdx];
                 if (questionSubIdx >= segmentData.relatedQuestions.length) {
                    // playSound(nextSegmentSound); // Kaldırıldı
                     console.log("Segmentteki sorular bitti, sonraki segmente geçiliyor.");
                     setTimeout(() => loadSegment(segmentIdx + 1), 1000);
                     return;
                 }
                 currentQuestionSubIndex = questionSubIdx;
                 const questionData = segmentData.relatedQuestions[questionSubIdx];
                 narrationArea.style.display = 'none';
                 questionDisplayArea.style.display = 'flex';
                 playersArea.style.display = 'flex';
                 totalQuestionsAnswered++;
                 currentQuestionTextElement.textContent = `Soru ${totalQuestionsAnswered}: ${questionData.questionText}`;
                 playersAnsweredCount = 0;
                 const shuffledOptions = shuffleArray([...questionData.options]);
                 players.forEach(player => {
                     player.answered = false;
                     const optionsContainer = document.getElementById(`options-player-${player.id}`);
                     const feedbackEl = document.getElementById(`feedback-player-${player.id}`);
                     const sectionEl = document.getElementById(`player-${player.id}-section`);
                     optionsContainer.innerHTML = '';
                     if(feedbackEl) feedbackEl.textContent = '';
                     if(sectionEl) sectionEl.style.border = '3px solid transparent';
                     shuffledOptions.forEach(option => {
                         const button = document.createElement('button');
                         button.textContent = option;
                         button.onclick = () => handleAnswer(player.id, option, questionData.correctAnswer, button);
                         optionsContainer.appendChild(button);
                     });
                     document.getElementById(`score-player-${player.id}`).textContent = `Skor: ${player.score}`;
                 });
                 updateScoreboard();
            }

            function handleAnswer(playerId, selectedOption, correctAnswer, clickedButton) {
                 const player = players.find(p => p.id === playerId);
                 if (!player || player.answered) return;
                 player.answered = true;
                 playersAnsweredCount++;
                 const feedbackEl = document.getElementById(`feedback-player-${player.id}`);
                 const scoreEl = document.getElementById(`score-player-${player.id}`);
                 const sectionEl = document.getElementById(`player-${player.id}-section`);
                 const playerOptionButtons = document.getElementById(`options-player-${playerId}`).getElementsByTagName('button');
                 for(let btn of playerOptionButtons){ btn.disabled = true; if (btn === clickedButton) { btn.style.opacity = '1'; } else { btn.style.opacity = '0.6'; } }

                 if (selectedOption === correctAnswer) {
                     player.score++;
                     feedbackEl.textContent = "Doğru!";
                     feedbackEl.className = 'player-feedback feedback-correct';
                     sectionEl.style.border = `3px solid var(--correct-border)`;
                    // playSound(correctSound); // Kaldırıldı
                 } else {
                     feedbackEl.textContent = `Yanlış!`;
                     feedbackEl.className = 'player-feedback feedback-incorrect';
                     sectionEl.style.border = `3px solid var(--incorrect-border)`;
                    // playSound(incorrectSound); // Kaldırıldı
                 }
                 scoreEl.textContent = `Skor: ${player.score}`;
                 updateScoreboard();

                 if(playersAnsweredCount === players.length) {
                      setTimeout(() => {
                         loadRelatedQuestion(currentSegmentIndex, currentQuestionSubIndex + 1);
                     }, 1800);
                 }
            }

            function showResults() {
                 quizContent.style.display = 'none';
                 narrationArea.style.display = 'none';
                 questionDisplayArea.style.display = 'none';
                 playersArea.style.display = 'none';
                 scoreboardElement.style.display = 'none';
                 resultsElement.style.display = 'block';
                 // playSound(gameOverSound); // Kaldırıldı
                 finalScoresElement.innerHTML = '';
                 let maxScore = -1;
                 let winners = [];
                 const sortedPlayers = [...players].sort((a, b) => b.score - a.score);
                 sortedPlayers.forEach(player => {
                      const resultLine = document.createElement('div');
                      resultLine.classList.add('result-line');
                      resultLine.innerHTML = `<span class="name">${player.name}</span> <span class="score">${player.score} Puan</span>`;
                      finalScoresElement.appendChild(resultLine);
                      if (player.score > maxScore) { maxScore = player.score; winners = [player.name]; }
                      else if (player.score === maxScore && maxScore >= 0) { winners.push(player.name); }
                 });
                  if (maxScore < 0 || (winners.length === players.length && maxScore === 0) ) { winnerInfoElement.textContent = "Kimse puan alamadı!"; }
                  else if (winners.length > 1) { winnerInfoElement.textContent = `Kazananlar (Berabere): ${winners.join(', ')} (${maxScore} puan)`; }
                  else { winnerInfoElement.textContent = `🏆 Kazanan: ${winners[0]} (${maxScore} puan)! 🎉`; }
            }

            function initializeQuiz() {
                players.forEach((player, index) => {
                     const enteredName = nameInputs[index].value.trim();
                     player.name = enteredName === '' ? `Oyuncu ${player.id}` : enteredName;
                 });
                 nameEntrySection.style.display = 'none';
                 resultsElement.style.display = 'none';
                 quizContent.style.display = 'block';
                 // playSound(startGameSound); // Kaldırıldı
                 startQuiz();
            }

            function startQuiz() {
                players.forEach((player, index) => {
                    player.score = 0;
                    player.answered = false;
                    nameDisplays[index].textContent = player.name;
                    document.getElementById(`score-player-${player.id}`).textContent = `Skor: 0`;
                    const sectionEl = document.getElementById(`player-${player.id}-section`);
                    if(sectionEl) sectionEl.style.border = '3px solid transparent';
                });
                totalQuestionsAnswered = 0;
                currentSegmentIndex = 0;
                currentQuestionSubIndex = 0;
                updateScoreboard(); // Başlangıç skor tablosunu göster
                loadSegment(currentSegmentIndex); // İlk segmenti yükle
            }

            function resetToNameEntry() {
                 window.speechSynthesis.cancel(); // Seslendirmeyi durdur
                 quizContent.style.display = 'none';
                 resultsElement.style.display = 'none';
                 nameEntrySection.style.display = 'block';
                 narrationArea.style.display = 'none';
                 questionDisplayArea.style.display = 'none';
                 playersArea.style.display = 'none';
                 scoreboardElement.style.display = 'none';
                 checkTtsSupport(); // Tekrar destek kontrolü yap
            }

            function checkTtsSupport() {
                 if (!('speechSynthesis' in window) || !window.speechSynthesis) { // Daha sağlam kontrol
                     ttsSupportWarning.style.display = 'block';
                     confirmNamesButton.disabled = true;
                     confirmNamesButton.style.opacity = 0.5;
                 } else {
                     ttsSupportWarning.style.display = 'none';
                     confirmNamesButton.disabled = false;
                     confirmNamesButton.style.opacity = 1;
                 }
            }

            // --- Olay Dinleyicileri ---
            confirmNamesButton.addEventListener('click', initializeQuiz); // Bu satır 367 veya civarı olabilir
            restartButton.addEventListener('click', resetToNameEntry); // Bu da

            playNarrationButton.addEventListener('click', () => { // Bu da
                if (!('speechSynthesis' in window) || !window.speechSynthesis) {
                    alert("Üzgünüz, tarayıcınız metin seslendirme özelliğini desteklemiyor.");
                    return;
                }
                window.speechSynthesis.cancel();
                const segmentData = quizSegments[currentSegmentIndex];
                if (!segmentData || !segmentData.narrationText) {
                    console.error("Seslendirilecek metin bulunamadı!");
                    alert("Seslendirilecek metin bulunamadı!");
                    playNarrationButton.disabled = false; // Butonu tekrar aktif et
                    return;
                }
                const utterance = new SpeechSynthesisUtterance(segmentData.narrationText);
                utterance.lang = 'tr-TR';
                utterance.rate = 0.9;
                utterance.pitch = 1;
                utterance.onend = handleNarrationEnd;
                utterance.onerror = (event) => {
                    console.error('SpeechSynthesisUtterance.onerror', event);
                    alert(`Seslendirme hatası: ${event.error}. Lütfen sayfayı yenileyin veya farklı bir tarayıcı deneyin.`);
                    playNarrationButton.textContent = "Hata! Tekrar Dene";
                    playNarrationButton.disabled = false;
                };
                playNarrationButton.disabled = true;
                playNarrationButton.textContent = "Seslendiriliyor...";
                window.speechSynthesis.speak(utterance);
            });

            // --- Başlangıç ---
            resetToNameEntry(); // Sayfa ilk yüklendiğinde isim girişi ekranını göster

        }); // DOMContentLoaded Sonu
    </script>

</body>
</html>
