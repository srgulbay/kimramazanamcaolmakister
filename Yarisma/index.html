<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YaÅŸa Ã–zel Ä°slami Bilgi YarÄ±ÅŸmasÄ± (Revize EdilmiÅŸ)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
        :root {
            --primary-bg: linear-gradient(135deg, #72EDF2, #5151E5);
            --container-bg: rgba(255, 255, 255, 0.98);
            --question-bg: #e8eaf6;
            --scoreboard-bg: #eceff1;
            --primary-text: #333;
            --header-color: #3f51b5;
            --subheader-color: #5e35b1;
            --winner-color: #ff6f00;
            --theme-child-bg: #e0f7fa; --theme-child-border: #4dd0e1; --theme-child-header: #0097a7; --theme-child-button: linear-gradient(145deg, #26c6da, #00acc1); --theme-child-button-hover: linear-gradient(145deg, #00acc1, #26c6da);
            --theme-teen-bg: #e8f5e9; --theme-teen-border: #81c784; --theme-teen-header: #388e3c; --theme-teen-button: linear-gradient(145deg, #66bb6a, #43a047); --theme-teen-button-hover: linear-gradient(145deg, #43a047, #66bb6a);
            --theme-young-adult-bg: #f3e5f5; --theme-young-adult-border: #ce93d8; --theme-young-adult-header: #8e24aa; --theme-young-adult-button: linear-gradient(145deg, #ab47bc, #8e24aa); --theme-young-adult-button-hover: linear-gradient(145deg, #8e24aa, #ab47bc);
            --correct-color: #2e7d32; --incorrect-color: #c62828;
            --correct-border: #2e7d32; --incorrect-border: #c62828; /* Added for border feedback */
            --start-button-gradient: linear-gradient(145deg, #5c6bc0, #3f51b5); /* Button gradient */
            --start-button-hover-gradient: linear-gradient(145deg, #7986cb, #5c6bc0); /* Button hover gradient */
        }
        body { font-family: 'Poppins', sans-serif; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; background: var(--primary-bg); color: var(--primary-text); padding: 10px; box-sizing: border-box; }
        #quiz-container { background-color: var(--container-bg); padding: 20px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15); text-align: center; width: 100%; max-width: 1200px; }
        h1, h2 { color: var(--header-color); margin-bottom: 20px; } h2 { color: var(--subheader-color); font-size: 1.5em; } h3 { color: var(--subheader-color); font-size: 1.2em; margin-bottom: 10px; }
        #name-entry { padding: 20px; border: 1px solid #ddd; border-radius: 10px; margin-bottom: 20px; background-color: #fafafa; display: flex; flex-wrap: wrap; justify-content: space-around; gap: 15px; }
        .player-input-group { flex: 1 1 250px; text-align: left; background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);}
        .player-input-group label { display: block; margin-bottom: 5px; font-weight: 600; color: var(--subheader-color); }
        .player-input-group input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px; font-size: 1em; box-sizing: border-box; margin-bottom: 5px; }
        #confirm-container { width: 100%; text-align: center; margin-top: 15px; }
        #quiz-content { display: none; }
        #narration-area { margin-bottom: 20px; padding: 15px; background-color: var(--question-bg); border-radius: 10px; text-align: center; }
        #narration-area p { font-style: italic; color: #555; margin-bottom: 15px; }
        #play-narration-btn { padding: 10px 20px; font-size: 1em; cursor: pointer; background: var(--start-button-gradient); color: white; border: none; border-radius: 8px; transition: background-color 0.3s; }
        #play-narration-btn:disabled { background-color: #aaa; cursor: not-allowed; }
        #scoreboard { background-color: var(--scoreboard-bg); padding: 10px 15px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        #scoreboard h3 { margin: 0 0 10px 0; color: var(--subheader-color); font-size: 1.1em; }
        #scoreboard-list { list-style: none; padding: 0; margin: 0; display: flex; justify-content: space-around; text-align: center; flex-wrap: wrap;}
        #scoreboard-list li { font-size: 1em; padding: 5px 10px; }
        #scoreboard-list .name { font-weight: 600; }
        /* Added color to score names based on theme */
        #scoreboard-list .theme-child { color: var(--theme-child-header); }
        #scoreboard-list .theme-teen { color: var(--theme-teen-header); }
        #scoreboard-list .theme-young-adult { color: var(--theme-young-adult-header); }
        #scoreboard-list .score { font-weight: bold; margin-left: 5px; }
        #players-area { display: flex; justify-content: space-between; flex-wrap: wrap; gap: 15px; }
        .player-quiz-area { flex: 1 1 30%; min-width: 280px; border-radius: 12px; padding: 15px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); border-top: 5px solid transparent; /* Use border-top */ border-bottom: 5px solid transparent; /* Added bottom border for balance */ transition: border-color 0.5s ease, opacity 0.5s ease; text-align: center; opacity: 0; }
        .player-quiz-area.visible { opacity: 1; }
        .theme-child { background-color: var(--theme-child-bg); /* Border color set via JS */ }
        .theme-teen { background-color: var(--theme-teen-bg); /* Border color set via JS */ }
        .theme-young-adult { background-color: var(--theme-young-adult-bg); /* Border color set via JS */ }
        .player-info { margin-bottom: 15px; font-weight: 600; font-size: 1.1em; }
        .player-info .player-age { font-size: 0.9em; color: #555; margin-left: 5px; }
        .theme-child .player-info { color: var(--theme-child-header); }
        .theme-teen .player-info { color: var(--theme-teen-header); }
        .theme-young-adult .player-info { color: var(--theme-young-adult-header); }
        .player-question { min-height: 70px; margin-bottom: 15px; padding: 10px; background-color: rgba(255,255,255, 0.7); border-radius: 8px; display: flex; justify-content: center; align-items: center; font-size: 1.05em; font-weight: 600; line-height: 1.4; }
        .player-options button { display: block; width: 100%; padding: 9px; margin: 6px 0; border: none; border-radius: 8px; color: white; cursor: pointer; font-size: 0.95em; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.15); }
        .theme-child .player-options button { background: var(--theme-child-button); }
        .theme-child .player-options button:hover:not(:disabled) { background: var(--theme-child-button-hover); transform: translateY(-1px); box-shadow: 0 3px 6px rgba(0,0,0,0.2); }
        .theme-teen .player-options button { background: var(--theme-teen-button); }
        .theme-teen .player-options button:hover:not(:disabled) { background: var(--theme-teen-button-hover); transform: translateY(-1px); box-shadow: 0 3px 6px rgba(0,0,0,0.2); }
        .theme-young-adult .player-options button { background: var(--theme-young-adult-button); }
        .theme-young-adult .player-options button:hover:not(:disabled) { background: var(--theme-young-adult-button-hover); transform: translateY(-1px); box-shadow: 0 3px 6px rgba(0,0,0,0.2); }
        .player-options button:disabled { background: #cccccc !important; cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none; }
        .player-feedback { min-height: 20px; margin-top: 10px; font-weight: 600; font-size: 0.9em; }
        .feedback-correct { color: var(--correct-color); }
        .feedback-incorrect { color: var(--incorrect-color); }
        #results { display: none; margin-top: 30px; }
        #final-scores { margin-bottom: 20px;}
        .result-line { font-size: 1.2em; margin: 10px 0; padding: 8px; border-radius: 5px; background-color: #f0f0f0; display: flex; justify-content: space-between; align-items: center; } /* Added align-items */
         .result-line .name { font-weight: 600; flex-grow: 1; text-align: left; margin-right: 10px; }
         /* Added theme color to result names */
        .result-line .theme-child { color: var(--theme-child-header); }
        .result-line .theme-teen { color: var(--theme-teen-header); }
        .result-line .theme-young-adult { color: var(--theme-young-adult-header); }
        .result-line .score { font-weight: bold; background-color: rgba(0,0,0,0.05); padding: 2px 6px; border-radius: 3px; } /* Styled score slightly */
        #winner-info { font-size: 1.4em; font-weight: bold; color: var(--winner-color); margin-top: 15px; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); } /* Added text shadow */
        #confirm-names-button, #restart-button { padding: 12px 25px; font-size: 1.2em; font-weight: 600; cursor: pointer; margin-top: 20px; background: var(--start-button-gradient); color: white; border: none; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.15); transition: all 0.3s ease; }
        #confirm-names-button:hover, #restart-button:hover { background: var(--start-button-hover-gradient); box-shadow: 0 6px 12px rgba(0,0,0,0.2); transform: translateY(-2px); }
        #loading-indicator { display: none; font-size: 1.2em; color: var(--subheader-color); margin: 20px; font-weight: bold; }
    </style>
</head>
<body>
    <div id="quiz-container">
        <h1>YaÅŸa Ã–zel Ä°slami Bilgi YarÄ±ÅŸmasÄ± (Revize EdilmiÅŸ)</h1>

        <div id="name-entry">
            <div class="player-input-group">
                 <label for="player-1-name-input">Oyuncu 1 AdÄ±:</label>
                 <input type="text" id="player-1-name-input" placeholder="Ä°sim..." maxlength="20">
                 <label for="player-1-age-input">YaÅŸÄ± (7-18):</label>
                 <input type="number" id="player-1-age-input" min="7" max="18" placeholder="YaÅŸ...">
             </div>
             <div class="player-input-group">
                 <label for="player-2-name-input">Oyuncu 2 AdÄ±:</label>
                 <input type="text" id="player-2-name-input" placeholder="Ä°sim..." maxlength="20">
                 <label for="player-2-age-input">YaÅŸÄ± (7-18):</label>
                 <input type="number" id="player-2-age-input" min="7" max="18" placeholder="YaÅŸ...">
             </div>
             <div class="player-input-group">
                 <label for="player-3-name-input">Oyuncu 3 AdÄ±:</label>
                 <input type="text" id="player-3-name-input" placeholder="Ä°sim..." maxlength="20">
                 <label for="player-3-age-input">YaÅŸÄ± (7-18):</label>
                 <input type="number" id="player-3-age-input" min="7" max="18" placeholder="YaÅŸ...">
             </div>
             <div id="confirm-container">
                 <button id="confirm-names-button">YarÄ±ÅŸmayÄ± BaÅŸlat</button>
             </div>
            <p id="tts-support-warning" style="color: red; width: 100%; text-align: center; margin-top: 10px; display: none;">TarayÄ±cÄ±nÄ±z metin seslendirme Ã¶zelliÄŸini desteklemiyor olabilir. AnlatÄ±m seslendirilemeyecek.</p>
        </div>

        <div id="quiz-content">
            <div id="narration-area" style="display: none;">
                <p id="narration-info">Åžimdi dikkatle dinleyin...</p>
                <button id="play-narration-btn">AnlatÄ±mÄ± Seslendir</button>
            </div>
            <div id="loading-indicator">SÄ±radaki sorular hazÄ±rlanÄ±yor...</div>
            <div id="scoreboard" style="display: none;">
                 <h3>Skor Tablosu</h3>
                 <ul id="scoreboard-list"></ul>
            </div>
            <div id="players-area">
                 <div class="player-quiz-area" id="player-area-1">
                     <div class="player-info">
                         <span class="player-name" id="player-1-name-display">Oyuncu 1</span>
                         <span class="player-age" id="player-1-age-display">(YaÅŸ)</span>
                     </div>
                     <div class="player-question" id="question-player-1">Soru yÃ¼kleniyor...</div>
                     <div class="player-options" id="options-player-1"></div>
                     <div class="player-feedback" id="feedback-player-1"></div>
                 </div>
                 <div class="player-quiz-area" id="player-area-2">
                     <div class="player-info">
                          <span class="player-name" id="player-2-name-display">Oyuncu 2</span>
                          <span class="player-age" id="player-2-age-display">(YaÅŸ)</span>
                     </div>
                     <div class="player-question" id="question-player-2">Soru yÃ¼kleniyor...</div>
                     <div class="player-options" id="options-player-2"></div>
                     <div class="player-feedback" id="feedback-player-2"></div>
                 </div>
                 <div class="player-quiz-area" id="player-area-3">
                       <div class="player-info">
                           <span class="player-name" id="player-3-name-display">Oyuncu 3</span>
                           <span class="player-age" id="player-3-age-display">(YaÅŸ)</span>
                       </div>
                       <div class="player-question" id="question-player-3">Soru yÃ¼kleniyor...</div>
                       <div class="player-options" id="options-player-3"></div>
                       <div class="player-feedback" id="feedback-player-3"></div>
                 </div>
            </div>
        </div>

        <div id="results">
              <h2>YarÄ±ÅŸma Bitti!</h2>
              <div id="final-scores"></div>
              <p id="winner-info"></p>
              <button id="restart-button">Yeni Oyun (Yeni Ä°simlerle)</button>
        </div>
    </div>

    <script src="questions.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- SORU HAVUZU & SEGMENTLER DIÅžARIDAN questions.js'den GELÄ°YOR ---
            // Bu deÄŸiÅŸkenlerin (questionPool, quizSegments) artÄ±k questions.js iÃ§inde tanÄ±mlÄ± olduÄŸunu varsayÄ±yoruz.

            // --- Oyuncu Bilgileri ---
            const players = [
                { id: 1, name: "Oyuncu 1", age: 0, score: 0, answered: false, themeClass: '', currentQuestion: null },
                { id: 2, name: "Oyuncu 2", age: 0, score: 0, answered: false, themeClass: '', currentQuestion: null },
                { id: 3, name: "Oyuncu 3", age: 0, score: 0, answered: false, themeClass: '', currentQuestion: null }
            ];
            // --- DeÄŸiÅŸkenler ---
            let currentSegmentIndex = 0;
            let playersAnsweredCount = 0;
            let askedQuestionIds = []; // Sorulan soru ID'lerini tut

            // --- Element ReferanslarÄ± ---
            const nameEntrySection = document.getElementById('name-entry');
            const confirmNamesButton = document.getElementById('confirm-names-button');
            const ttsSupportWarning = document.getElementById('tts-support-warning');
            const quizContent = document.getElementById('quiz-content');
            const narrationArea = document.getElementById('narration-area');
            const narrationInfo = document.getElementById('narration-info');
            const playNarrationButton = document.getElementById('play-narration-btn');
            const scoreboardElement = document.getElementById('scoreboard');
            const scoreboardListElement = document.getElementById('scoreboard-list');
            const playersArea = document.getElementById('players-area');
            const loadingIndicator = document.getElementById('loading-indicator');
            const resultsElement = document.getElementById('results');
            const finalScoresElement = document.getElementById('final-scores');
            const restartButton = document.getElementById('restart-button');
            const winnerInfoElement = document.getElementById('winner-info');
            const nameInputs = []; const ageInputs = []; const nameDisplays = []; const ageDisplays = [];
            const playerAreaElements = []; const playerQuestionElements = []; const playerOptionsElements = []; const playerFeedbackElements = [];

            for (let i = 1; i <= 3; i++) {
                nameInputs.push(document.getElementById(`player-${i}-name-input`));
                ageInputs.push(document.getElementById(`player-${i}-age-input`));
                nameDisplays.push(document.getElementById(`player-${i}-name-display`));
                ageDisplays.push(document.getElementById(`player-${i}-age-display`));
                playerAreaElements.push(document.getElementById(`player-area-${i}`));
                playerQuestionElements.push(document.getElementById(`question-player-${i}`));
                playerOptionsElements.push(document.getElementById(`options-player-${i}`));
                playerFeedbackElements.push(document.getElementById(`feedback-player-${i}`));
            }

              // --- Fonksiyonlar (shuffleArray, updateScoreboard, getThemeClass vb. - DeÄŸiÅŸiklik Yok) ---
              function shuffleArray(array) {
                  let currentIndex = array.length,  randomIndex;
                  while (currentIndex > 0) {
                      randomIndex = Math.floor(Math.random() * currentIndex);
                      currentIndex--;
                      [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
                  }
                  return array;
              }

              function updateScoreboard() {
                  scoreboardListElement.innerHTML = '';
                  // Skor tablosunu oyuncu sÄ±rasÄ±na gÃ¶re deÄŸil, ID sÄ±rasÄ±na gÃ¶re gÃ¶sterelim
                  const sortedByIdPlayers = [...players].sort((a, b) => a.id - b.id);
                  sortedByIdPlayers.forEach(player => {
                      const listItem = document.createElement('li');
                      // Temaya uygun renkli isimler (isteÄŸe baÄŸlÄ±)
                      const nameSpan = `<span class="name ${player.themeClass}">${player.name}</span>`;
                      listItem.innerHTML = `${nameSpan}: <span class="score">${player.score} Puan</span>`;
                      scoreboardListElement.appendChild(listItem);
                  });
              }

              function getThemeClass(age) {
                  if (age >= 7 && age <= 10) return 'theme-child';
                  if (age >= 11 && age <= 14) return 'theme-teen';
                  if (age >= 15 && age <= 18) return 'theme-young-adult';
                  return 'theme-default'; // Gerekirse varsayÄ±lan tema
              }

              function getThemeBorderColorVar(themeClass) {
                    switch (themeClass) {
                        case 'theme-child': return 'var(--theme-child-border)';
                        case 'theme-teen': return 'var(--theme-teen-border)';
                        case 'theme-young-adult': return 'var(--theme-young-adult-border)';
                        default: return 'transparent'; // VarsayÄ±lan veya hata durumu
                    }
              }


              function loadSegment(segmentIndex) {
                   // TarayÄ±cÄ± destekliyorsa ve seslendirme varsa durdur
                   if ('speechSynthesis' in window && window.speechSynthesis.speaking) {
                       window.speechSynthesis.cancel();
                   }

                   if (segmentIndex >= quizSegments.length) {
                       showResults(); return;
                   }
                   currentSegmentIndex = segmentIndex;
                   const segmentData = quizSegments[segmentIndex];
                   playerAreaElements.forEach(el => el.classList.remove('visible')); // Ã–nce gizle
                   playersArea.style.display = 'none';
                   loadingIndicator.style.display = 'none';
                   narrationArea.style.display = 'block';
                   scoreboardElement.style.display = 'block'; // Skor tablosu hep gÃ¶rÃ¼nsÃ¼n
                   narrationInfo.textContent = `Segment ${segmentIndex + 1}: "${segmentData.narrationTitle}" konusunu dinlemek iÃ§in butona basÄ±n.`;
                   playNarrationButton.disabled = false;
                   playNarrationButton.textContent = "AnlatÄ±mÄ± Seslendir";

                   // Ã–nceki geri bildirimleri ve borderlarÄ± temizle
                   players.forEach(player => {
                       const feedbackEl = playerFeedbackElements[player.id-1];
                       const areaEl = playerAreaElements[player.id-1];
                       if(feedbackEl) feedbackEl.textContent = '';
                       if(areaEl) {
                           areaEl.style.borderTopColor = 'transparent';
                           areaEl.style.borderBottomColor = 'transparent';
                       }
                   });
                   updateScoreboard();
               }

               function handleNarrationEnd() {
                   console.log("Seslendirme bitti, sorular yÃ¼kleniyor...");
                   playNarrationButton.textContent = "AnlatÄ±m Bitti";
                   playNarrationButton.disabled = true;
                   narrationArea.style.display = 'none'; // AnlatÄ±m bitince alanÄ± gizle
                   loadingIndicator.style.display = 'block'; // YÃ¼kleme gÃ¶stergesini gÃ¶ster

                   // SorularÄ± yÃ¼klemeden Ã¶nce kÄ±sa bir gecikme
                   setTimeout(() => {
                       loadQuestionsForPlayers(currentSegmentIndex);
                       loadingIndicator.style.display = 'none'; // YÃ¼kleme bitince gÃ¶stergeyi gizle
                       playersArea.style.display = 'flex'; // Oyuncu alanlarÄ±nÄ± tekrar gÃ¶ster
                       playerAreaElements.forEach(el => {
                           el.classList.add('visible'); // Animasyonla gÃ¶rÃ¼nÃ¼r yap
                       });
                   }, 500); // 0.5 saniye gecikme
               }


               function loadQuestionsForPlayers(segmentIdx) {
                   playersAnsweredCount = 0;
                   let currentRoundSelectedIds = []; // Bu turda her oyuncu iÃ§in farklÄ± soru seÃ§ildiÄŸinden emin ol

                    // Hata kontrolÃ¼: quizSegments ve questionPool yÃ¼klenmiÅŸ mi?
                   if (typeof quizSegments === 'undefined' || typeof questionPool === 'undefined') {
                        console.error("HATA: Soru verileri (questions.js) yÃ¼klenemedi!");
                        alert("Kritik Hata: Soru verileri yÃ¼klenemedi. LÃ¼tfen sayfayÄ± yenileyin ve questions.js dosyasÄ±nÄ±n index.html ile aynÄ± dizinde olduÄŸundan emin olun.");
                        // Ä°steÄŸe baÄŸlÄ±: Oyunu durdur veya baÅŸka bir iÅŸlem yap
                        nameEntrySection.style.display = 'block'; // Ä°sim giriÅŸine dÃ¶n
                        quizContent.style.display = 'none';
                        resultsElement.style.display = 'none';
                        return; // Fonksiyonu durdur
                   }

                   players.forEach(player => {
                       player.answered = false;
                       player.currentQuestion = null;
                       const optionsEl = playerOptionsElements[player.id-1];
                       const feedbackEl = playerFeedbackElements[player.id-1];
                       const questionEl = playerQuestionElements[player.id-1];
                       const sectionEl = playerAreaElements[player.id-1];

                       if (optionsEl) optionsEl.innerHTML = '';
                       if (feedbackEl) feedbackEl.textContent = '';
                       if (questionEl) questionEl.textContent = 'Soru aranÄ±yor...';
                       // Tema border'Ä±nÄ± sÄ±fÄ±rla (transparent yap)
                       if (sectionEl) {
                            sectionEl.style.borderTopColor = 'transparent';
                            sectionEl.style.borderBottomColor = 'transparent';
                       }

                       // Uygun sorularÄ± filtrele
                       const suitableQuestions = questionPool.filter(q =>
                           q.segmentId === quizSegments[segmentIdx].segmentId &&
                           player.age >= q.minAge &&
                           player.age <= q.maxAge &&
                           !askedQuestionIds.includes(q.questionId) && // Genel olarak sorulmamÄ±ÅŸ olmalÄ±
                           !currentRoundSelectedIds.includes(q.questionId) // Bu turda baÅŸka oyuncuya sorulmamÄ±ÅŸ olmalÄ±
                       );

                       let questionData = null;
                       if (suitableQuestions.length > 0) {
                           // Rastgele bir uygun soru seÃ§
                           questionData = suitableQuestions[Math.floor(Math.random() * suitableQuestions.length)];
                           player.currentQuestion = questionData;
                           askedQuestionIds.push(questionData.questionId); // Soruldu olarak iÅŸaretle
                           currentRoundSelectedIds.push(questionData.questionId); // Bu turda seÃ§ildi olarak iÅŸaretle

                           if (questionEl) questionEl.textContent = questionData.questionText;
                           if (optionsEl) {
                               const shuffledOptions = shuffleArray([...questionData.options]);
                               shuffledOptions.forEach(option => {
                                   const button = document.createElement('button');
                                   button.textContent = option;
                                   // handleAnswer fonksiyonuna player.id ve seÃ§ilen cevabÄ± gÃ¶nder
                                   button.onclick = () => handleAnswer(player.id, option);
                                   optionsEl.appendChild(button);
                               });
                           }
                       } else {
                           // Uygun soru bulunamazsa
                           if (questionEl) questionEl.textContent = 'Size uygun soru bulunamadÄ±.';
                           player.answered = true; // CevaplanmÄ±ÅŸ say
                           playersAnsweredCount++; // Cevaplayan sayÄ±sÄ±nÄ± artÄ±r
                       }
                   });

                   // EÄŸer baÅŸlangÄ±Ã§ta hiÃ§bir oyuncuya soru bulunamadÄ±ysa (veya hepsi 'bulunamadÄ±' ise)
                   if (playersAnsweredCount === players.length && playersAnsweredCount > 0) {
                       console.log("Bu turda kimseye soru bulunamadÄ± veya hepsi otomatik geÃ§ildi.");
                       loadingIndicator.style.display = 'block';
                       playersArea.style.display = 'none';
                       setTimeout(() => loadSegment(currentSegmentIndex + 1), 1800); // Bir sonraki segmente geÃ§
                   }
               }


               function handleAnswer(playerId, selectedOption) {
                   const player = players.find(p => p.id === playerId);
                   // Oyuncu yoksa, cevaplamÄ±ÅŸsa veya sorusu yoksa Ã§Ä±k
                   if (!player || player.answered || !player.currentQuestion) return;

                   player.answered = true;
                   playersAnsweredCount++;

                   const feedbackEl = playerFeedbackElements[player.id - 1];
                   const sectionEl = playerAreaElements[player.id - 1];
                   const playerOptionButtons = playerOptionsElements[player.id - 1].getElementsByTagName('button');

                   // Hata KontrolÃ¼: Ä°lgili elementler DOM'da var mÄ±?
                   if (!feedbackEl || !sectionEl || !playerOptionButtons) {
                       console.error(`Oyuncu ${playerId} iÃ§in UI elementleri bulunamadÄ±. DOM yapÄ±sÄ±nÄ± kontrol edin.`);
                       // Ä°steÄŸe baÄŸlÄ± olarak burada iÅŸlemi durdurabilir veya kullanÄ±cÄ±ya bir mesaj gÃ¶sterebilirsiniz.
                       // Ã–rneÄŸin: alert(`Oyuncu ${playerId} arayÃ¼zÃ¼nde bir hata oluÅŸtu!`);
                       return; // Hata durumunda fonksiyondan Ã§Ä±k
                   }


                   // TÃ¼m butonlarÄ± devre dÄ±ÅŸÄ± bÄ±rak
                   for (let btn of playerOptionButtons) {
                       btn.disabled = true;
                       // SeÃ§ilen butonu gÃ¶rsel olarak farklÄ±laÅŸtÄ±rabiliriz (opsiyonel)
                       if (btn.textContent === selectedOption) {
                           // btn.style.opacity = '1';
                           // btn.style.border = '2px solid yellow'; // Ã–rnek
                       } else {
                            // DiÄŸer butonlarÄ± soluklaÅŸtÄ±r
                            btn.style.opacity = '0.6';
                       }
                   }

                    const correctBorderColor = getThemeBorderColorVar(player.themeClass);
                    const incorrectBorderColor = 'var(--incorrect-border)'; // KÄ±rmÄ±zÄ±

                    if (selectedOption === player.currentQuestion.correctAnswer) {
                        player.score++;
                        feedbackEl.textContent = "DoÄŸru!";
                        feedbackEl.className = 'player-feedback feedback-correct';
                        // Tema rengine uygun border ekle (Ã¼st ve alt)
                         sectionEl.style.borderTopColor = correctBorderColor;
                         sectionEl.style.borderBottomColor = correctBorderColor;

                    } else {
                        feedbackEl.textContent = `YanlÄ±ÅŸ! DoÄŸru: ${player.currentQuestion.correctAnswer}`; // DoÄŸru cevabÄ± gÃ¶ster
                        feedbackEl.className = 'player-feedback feedback-incorrect';
                         sectionEl.style.borderTopColor = incorrectBorderColor;
                         sectionEl.style.borderBottomColor = incorrectBorderColor;
                    }

                   updateScoreboard(); // Skorbordu anÄ±nda gÃ¼ncelle

                   // TÃ¼m oyuncular cevapladÄ±ysa sonraki segmente geÃ§
                   if (playersAnsweredCount === players.length) {
                       console.log("Tur tamamlandÄ±, sonraki segmente geÃ§iliyor.");
                       loadingIndicator.style.display = 'block'; // YÃ¼kleme gÃ¶stergesini aÃ§
                        playerAreaElements.forEach(el => el.classList.remove('visible')); // AlanlarÄ± gizle (animasyonla kaybolsun)
                        // KÄ±sa bir sÃ¼re sonra alanlarÄ± tamamen kaldÄ±r ve yeni segmente geÃ§
                       setTimeout(() => {
                            playersArea.style.display = 'none'; // AlanlarÄ± DOM'dan kaldÄ±rÄ±r gibi yap
                           loadSegment(currentSegmentIndex + 1); // Sonraki segmenti yÃ¼kle
                       }, 1800); // Geri bildirimi gÃ¶rmek iÃ§in 1.8 saniye bekle
                   }
               }


               function showResults() {
                    // Varsa aktif seslendirmeyi durdur
                    if ('speechSynthesis' in window && window.speechSynthesis.speaking) {
                       window.speechSynthesis.cancel();
                    }
                   quizContent.style.display = 'none'; // Quiz iÃ§eriÄŸini gizle
                   resultsElement.style.display = 'block'; // SonuÃ§larÄ± gÃ¶ster
                   finalScoresElement.innerHTML = ''; // Ã–nceki sonuÃ§larÄ± temizle
                   let maxScore = -1; // BaÅŸlangÄ±Ã§ta max skor -1 (0 puan alanlar da kazanan sayÄ±lmasÄ±n diye)
                   let winners = [];

                   // OyuncularÄ± skora gÃ¶re bÃ¼yÃ¼kten kÃ¼Ã§Ã¼ÄŸe sÄ±rala
                   const sortedPlayers = [...players].sort((a, b) => b.score - a.score);

                   sortedPlayers.forEach(player => {
                       const resultLine = document.createElement('div');
                       resultLine.classList.add('result-line');
                        // SonuÃ§larda da tema rengini kullanalÄ±m
                       resultLine.innerHTML = `<span class="name ${player.themeClass}">${player.name} (${player.age} yaÅŸ)</span> <span class="score">${player.score} Puan</span>`;
                       finalScoresElement.appendChild(resultLine);

                       // KazananlarÄ± belirle (en yÃ¼ksek skoru alanlar)
                       if (player.score > maxScore) {
                           maxScore = player.score;
                           winners = [player.name]; // Yeni en yÃ¼ksek skor, kazanan listesini sÄ±fÄ±rla
                       } else if (player.score === maxScore && maxScore >= 0) { // Skor eÅŸitse ve 0'dan bÃ¼yÃ¼kse listeye ekle
                           winners.push(player.name);
                       }
                   });

                   // Kazanan mesajÄ±nÄ± ayarla
                   if (maxScore <= 0 ) { // Kimse pozitif puan alamadÄ±ysa
                        winnerInfoElement.textContent = "Kimse puan alamadÄ± veya yeterli soru bulunamadÄ±!";
                   } else if (winners.length > 1) { // Beraberlik durumu
                       winnerInfoElement.textContent = `ðŸ† Kazananlar (Berabere): ${winners.join(', ')} (${maxScore} puan)! ðŸŽ‰`;
                   } else { // Tek kazanan durumu
                       winnerInfoElement.textContent = `ðŸ† Kazanan: ${winners[0]} (${maxScore} puan)! ðŸŽ‰`;
                   }
               }


               function initializeQuiz() {
                    let allAgesValid = true;
                    let playerCount = 0; // En az bir oyuncu var mÄ± kontrolÃ¼ iÃ§in

                    players.forEach((player, index) => {
                        const nameInput = nameInputs[index];
                        const ageInput = ageInputs[index];

                        // Elementler var mÄ± kontrol et
                        if (!nameInput || !ageInput) {
                            console.error(`Oyuncu ${index + 1} iÃ§in input elementleri bulunamadÄ±.`);
                            return; // Bu oyuncuyu atla
                        }

                        const name = nameInput.value.trim();
                        const ageString = ageInput.value;

                        // Ä°sim veya yaÅŸ girilmemiÅŸse bu oyuncuyu dikkate alma
                        if (name === '' && ageString === '') {
                            // EÄŸer bu slot boÅŸsa, oyuncu bilgilerini sÄ±fÄ±rla ve gÃ¶rÃ¼nmez yap
                            player.name = `Oyuncu ${player.id}`; // VarsayÄ±lan isim kalsÄ±n ama oynamayacak
                            player.age = 0;
                            player.score = 0;
                            player.themeClass = '';
                            const areaEl = playerAreaElements[player.id - 1];
                            if (areaEl) areaEl.style.display = 'none'; // Bu oyuncu alanÄ±nÄ± gizle
                            return; // Sonraki oyuncuya geÃ§
                        }

                        // Ä°sim veya yaÅŸ girilmiÅŸse, doÄŸrulama yap
                        playerCount++; // GeÃ§erli olabilecek bir oyuncu var
                        player.name = name === '' ? `Oyuncu ${player.id}` : name;
                        const age = parseInt(ageString);


                        if (isNaN(age) || age < 7 || age > 18) {
                           // YaÅŸ geÃ§ersizse kullanÄ±cÄ±yÄ± uyar
                            alert(`Oyuncu "${player.name}" iÃ§in geÃ§erli bir yaÅŸ (7-18 arasÄ±) girmelisiniz.`);
                            ageInput.style.border = '2px solid red'; // HatalÄ± alanÄ± iÅŸaretle
                            allAgesValid = false;
                        } else {
                            player.age = age;
                            player.themeClass = getThemeClass(age);
                            ageInput.style.border = ''; // Hata iÅŸaretini kaldÄ±r
                             const areaEl = playerAreaElements[player.id - 1];
                             if (areaEl) areaEl.style.display = 'flex'; // GizlenmiÅŸ olabilir, tekrar gÃ¶ster
                        }
                        // Her baÅŸlangÄ±Ã§ta skorlarÄ± sÄ±fÄ±rla
                        player.score = 0;
                        player.answered = false;
                        player.currentQuestion = null;
                    });

                    // YaÅŸlarda hata varsa veya hiÃ§ oyuncu girilmemiÅŸse baÅŸlatma
                    if (!allAgesValid || playerCount === 0) {
                         if (playerCount === 0) alert("LÃ¼tfen en az bir oyuncu iÃ§in isim ve yaÅŸ girin.");
                         return;
                     }


                    // GeÃ§erli oyuncularÄ±n UI'larÄ±nÄ± gÃ¼ncelle
                    players.forEach((player) => {
                        // Sadece yaÅŸÄ± geÃ§erli olan ve gizlenmemiÅŸ oyuncularÄ± gÃ¼ncelle
                         if (player.age >= 7 && player.age <= 18) {
                            const areaEl = playerAreaElements[player.id - 1];
                            const nameEl = nameDisplays[player.id - 1];
                            const ageEl = ageDisplays[player.id - 1];

                            if (areaEl) {
                                areaEl.className = `player-quiz-area ${player.themeClass}`; // TemayÄ± uygula
                                areaEl.style.borderTopColor = 'transparent'; // BaÅŸlangÄ±Ã§ borderlarÄ±nÄ± temizle
                                areaEl.style.borderBottomColor = 'transparent';
                            } else { console.error(`player-area-${player.id} bulunamadÄ±`); }

                            if (nameEl) { nameEl.textContent = player.name; }
                            else { console.error(`player-${player.id}-name-display bulunamadÄ±`); }

                            if (ageEl) { ageEl.textContent = `(${player.age} yaÅŸ)`; }
                            else { console.error(`player-${player.id}-age-display bulunamadÄ±`); }
                        } else {
                            // YaÅŸÄ± geÃ§ersiz olan veya hiÃ§ girilmeyen oyuncularÄ±n alanlarÄ±nÄ± gizle
                             const areaEl = playerAreaElements[player.id - 1];
                             if (areaEl) areaEl.style.display = 'none';
                        }
                    });

                    // Aktif oyuncu sayÄ±sÄ±na gÃ¶re #players-area geniÅŸliÄŸini ayarla (opsiyonel)
                     const activePlayers = players.filter(p => p.age >= 7 && p.age <= 18).length;
                     // Ã–rneÄŸin: playersArea.style.justifyContent = activePlayers < 3 ? 'center' : 'space-between';

                    nameEntrySection.style.display = 'none'; // Ä°sim giriÅŸini gizle
                    resultsElement.style.display = 'none'; // SonuÃ§larÄ± gizle (varsa)
                    quizContent.style.display = 'block'; // Quiz iÃ§eriÄŸini gÃ¶ster
                    startQuiz(); // YarÄ±ÅŸmayÄ± baÅŸlat
                }


                function startQuiz() {
                    askedQuestionIds = []; // Sorulan sorular listesini temizle
                    currentSegmentIndex = 0; // Ä°lk segmentten baÅŸla
                    // Skorlar initializeQuiz'da sÄ±fÄ±rlandÄ±, tekrar sÄ±fÄ±rlamaya gerek yok
                    updateScoreboard(); // BaÅŸlangÄ±Ã§ skor tablosunu gÃ¶ster
                    loadSegment(currentSegmentIndex); // Ä°lk segmenti yÃ¼kle
                }

                function resetToNameEntry() {
                    // Varsa aktif seslendirmeyi durdur
                    if ('speechSynthesis' in window && window.speechSynthesis.speaking) {
                       window.speechSynthesis.cancel();
                    }
                    quizContent.style.display = 'none';
                    resultsElement.style.display = 'none';
                    nameEntrySection.style.display = 'block'; // Ä°sim giriÅŸini gÃ¶ster

                     // Input alanlarÄ±nÄ± temizle ve hatalÄ± iÅŸaretleri kaldÄ±r
                     nameInputs.forEach(input => { if(input) input.value = ''; });
                     ageInputs.forEach(input => { if(input) { input.value = ''; input.style.border = ''; } });

                     // TÃ¼m oyuncu alanlarÄ±nÄ± gÃ¶rÃ¼nÃ¼r yap (yeni giriÅŸe hazÄ±r)
                     playerAreaElements.forEach(el => { if(el) el.style.display = 'flex'; });


                    checkTtsSupport(); // TTS desteÄŸini tekrar kontrol et
                }

               function checkTtsSupport() {
                   const hasTts = 'speechSynthesis' in window && window.speechSynthesis;
                   if (!hasTts) {
                       ttsSupportWarning.style.display = 'block';
                       // TTS yoksa butonu devre dÄ±ÅŸÄ± bÄ±rakmaya gerek yok,
                       // playNarrationButton event listener zaten kontrol ediyor.
                       // if(confirmNamesButton) confirmNamesButton.disabled = true; // BaÅŸlatmayÄ± engelleme
                   } else {
                       ttsSupportWarning.style.display = 'none';
                       // if(confirmNamesButton) confirmNamesButton.disabled = false;
                   }
                   // Oynatma butonu baÅŸlangÄ±Ã§ta etkin olmalÄ± (varsa)
                   if (playNarrationButton) {
                       playNarrationButton.disabled = false;
                       playNarrationButton.textContent = "AnlatÄ±mÄ± Seslendir";
                   }
               }

            // --- Olay Dinleyicileri ---
            if (confirmNamesButton) {
                confirmNamesButton.addEventListener('click', initializeQuiz);
            } else { console.error("confirm-names-button bulunamadÄ±!"); }

            if (restartButton) {
                restartButton.addEventListener('click', resetToNameEntry);
            } else { console.error("restart-button bulunamadÄ±!"); }

            if (playNarrationButton) {
                playNarrationButton.addEventListener('click', () => {
                    if (!('speechSynthesis' in window) || !window.speechSynthesis) {
                        alert("TarayÄ±cÄ±nÄ±z metin seslendirme Ã¶zelliÄŸini desteklemiyor.");
                        // Seslendirme desteklenmiyorsa, direkt sorularÄ± yÃ¼kle
                        handleNarrationEnd(); // SorularÄ± yÃ¼kleme adÄ±mÄ±na geÃ§
                        return;
                     }
                     // Zaten konuÅŸuyorsa bir ÅŸey yapma veya durdurup baÅŸtan baÅŸlat (isteÄŸe baÄŸlÄ±)
                     // if (window.speechSynthesis.speaking) return;
                      window.speechSynthesis.cancel(); // Ã–nceki konuÅŸmayÄ± durdur

                    const segmentData = quizSegments[currentSegmentIndex];
                    if (!segmentData || !segmentData.narrationText) {
                        console.error("Seslendirilecek metin bulunamadÄ±!");
                        alert("Seslendirilecek anlatÄ±m metni bulunamadÄ±!");
                        handleNarrationEnd(); // Hata olsa bile sorulara geÃ§meyi dene
                        return;
                    }
                    const utterance = new SpeechSynthesisUtterance(segmentData.narrationText);
                    utterance.lang = 'tr-TR'; utterance.rate = 0.9; utterance.pitch = 1;

                    // Seslendirme bittiÄŸinde veya hata olduÄŸunda Ã§aÄŸrÄ±lacak fonksiyonlar
                    utterance.onend = handleNarrationEnd;
                    utterance.onerror = (event) => {
                        console.error('TTS HatasÄ±:', event);
                        alert(`Seslendirme sÄ±rasÄ±nda bir hata oluÅŸtu: ${event.error}. Sorulara devam edilecek.`);
                        playNarrationButton.textContent = "Hata!";
                        playNarrationButton.disabled = false; // Tekrar deneme imkanÄ±?
                        // Hata olsa bile sorularÄ±n yÃ¼klenmesini tetikle
                        handleNarrationEnd();
                    };

                    playNarrationButton.disabled = true; playNarrationButton.textContent = "Seslendiriliyor...";
                    window.speechSynthesis.speak(utterance);
                });
            } else { console.error("play-narration-btn bulunamadÄ±!"); }


            // --- BaÅŸlangÄ±Ã§ ---
            // Hata kontrolÃ¼: Gerekli dÄ±ÅŸ deÄŸiÅŸkenler yÃ¼klenmiÅŸ mi?
             if (typeof quizSegments === 'undefined' || typeof questionPool === 'undefined') {
                console.error("HATA: Soru verileri (questions.js) yÃ¼klenemedi! Uygulama baÅŸlatÄ±lamÄ±yor.");
                // KullanÄ±cÄ±ya daha belirgin bir hata gÃ¶ster
                const container = document.getElementById('quiz-container');
                if(container) {
                    container.innerHTML = `<h1>Hata!</h1><p>YarÄ±ÅŸma verileri yÃ¼klenemedi. LÃ¼tfen 'questions.js' dosyasÄ±nÄ±n 'index.html' ile aynÄ± klasÃ¶rde olduÄŸundan emin olun ve sayfayÄ± yenileyin.</p>`;
                    container.style.color = 'red';
                    container.style.textAlign = 'center';
                }
             } else {
                 // Her ÅŸey yolundaysa, isim giriÅŸiyle baÅŸla
                resetToNameEntry(); // Sayfa ilk yÃ¼klendiÄŸinde isim giriÅŸi ekranÄ±nÄ± gÃ¶ster
             }

        }); // DOMContentLoaded Sonu
    </script>

</body>
</html>
