<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sıfırdan Gelişmiş İslami Bilgi Yarışması</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        /* --- CSS Stilleri (Önceki modern tasarım korunuyor) --- */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&display=swap');

        :root {
            --font-primary: 'Poppins', sans-serif; --font-heading: 'Merriweather', serif;
            --bg-gradient: linear-gradient(120deg, #a1c4fd 0%, #c2e9fb 100%);
            --container-bg: rgba(255, 255, 255, 0.98);
            --shadow-light: rgba(100, 116, 139, 0.1); --shadow-medium: rgba(51, 65, 85, 0.15);
            --text-primary: #1e293b; --text-secondary: #475569;
            --header-color: #1d4ed8; --subheader-color: #6d28d9; --accent-color: #f59e0b;
            --border-color: #cbd5e1; --disabled-bg: #e2e8f0; --disabled-text: #94a3b8;
            /* Temalar */
            --c-bg: #ecfeff; --c-border: #22d3ee; --c-head: #0e7490; --c-btn: linear-gradient(145deg, #67e8f9, #22d3ee); --c-btn-h: linear-gradient(145deg, #22d3ee, #67e8f9);
            --t-bg: #f0fdf4; --t-border: #34d399; --t-head: #059669; --t-btn: linear-gradient(145deg, #6ee7b7, #34d399); --t-btn-h: linear-gradient(145deg, #34d399, #6ee7b7);
            --y-bg: #fefce8; --y-border: #facc15; --y-head: #ca8a04; --y-btn: linear-gradient(145deg, #fde047, #facc15); --y-btn-h: linear-gradient(145deg, #facc15, #fde047);
            /* Geri Bildirim */
            --correct-bg: #f0fdf4; --correct-border: #22c55e; --correct-text: #166534;
            --incorrect-bg: #fff1f2; --incorrect-border: #f43f5e; --incorrect-text: #9f1239;
        }
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: var(--font-primary); display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; background: var(--bg-gradient); color: var(--text-primary); padding: 15px; line-height: 1.7; }
        #quiz-container { background-color: var(--container-bg); padding: clamp(25px, 5vw, 45px); border-radius: 24px; box-shadow: 0 20px 40px var(--shadow-medium); text-align: center; width: 100%; max-width: 1400px; border-top: 6px solid var(--header-color); }
        h1, h2, h3 { font-family: var(--font-heading); }
        h1 { color: var(--header-color); margin-bottom: 20px; font-size: clamp(2rem, 5vw, 2.8rem); }
        h2 { color: var(--subheader-color); margin-bottom: 30px; font-size: clamp(1.5rem, 4vw, 2rem); }
        h3 { color: var(--subheader-color); margin: 0 0 15px 0; font-size: 1.4em; border-bottom: 2px solid var(--border-color); padding-bottom: 5px; }
        /* --- Giriş Alanı --- */
        #name-entry { padding: 30px; border: 1px solid var(--border-color); border-radius: 16px; margin-bottom: 30px; background-color: #f9fafb; display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px; }
        .player-input-group { text-align: left; background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 5px 15px var(--shadow-light); border: 1px solid var(--border-color); }
        .player-input-group label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--subheader-color); font-size: 1em; }
        .player-input-group input { width: 100%; padding: 12px 15px; border: 1px solid #bdc3c7; border-radius: 8px; font-size: 1em; box-sizing: border-box; margin-bottom: 12px; transition: border-color 0.3s, box-shadow 0.3s; }
        .player-input-group input:focus { border-color: var(--header-color); box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.15); outline: none; }
        #confirm-container { grid-column: 1 / -1; text-align: center; margin-top: 10px; }
        /* --- Butonlar --- */
        .btn { padding: 14px 32px; font-size: 1.15em; font-weight: 600; cursor: pointer; color: white; border: none; border-radius: 10px; box-shadow: 0 5px 12px var(--shadow-medium); transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.8px; }
        .btn-primary { background: linear-gradient(145deg, #4f46e5, #3730a3); }
        .btn-primary:hover { background: linear-gradient(145deg, #3730a3, #4f46e5); box-shadow: 0 7px 18px var(--shadow-medium); transform: translateY(-3px); }
        .btn:disabled { background: var(--disabled-bg) !important; color: var(--disabled-text) !important; cursor: not-allowed; box-shadow: none; transform: none; }
        #quiz-content, #results { display: none; }
        /* --- Anlatım / Skorboard --- */
        #narration-area { margin-bottom: 30px; padding: 25px; background-color: #f0f9ff; border-radius: 16px; text-align: center; border: 1px solid #bae6fd; box-shadow: 0 4px 12px var(--shadow-light); }
        #narration-area p { color: var(--text-secondary); margin-bottom: 20px; font-size: 1.15em; font-style: normal; }
        #play-narration-btn { font-size: 1.05em; }
        #scoreboard { background-color: #fafafa; padding: 15px 25px; border-radius: 16px; margin-bottom: 30px; box-shadow: 0 4px 10px var(--shadow-light); border: 1px solid var(--border-color); }
        #scoreboard-list { display: flex; justify-content: space-evenly; flex-wrap: wrap; list-style: none; gap: 20px; }
        #scoreboard-list li { font-size: 1.1em; background: #fff; padding: 10px 18px; border-radius: 8px; box-shadow: 0 2px 5px var(--shadow-light); border: 1px solid var(--border-color); }
        #scoreboard-list .name { font-weight: 600; color: var(--subheader-color); }
        #scoreboard-list .score { font-weight: 700; margin-left: 8px; color: var(--header-color); font-size: 1.1em; }
        /* --- Oyuncu Alanları --- */
        #players-area { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 25px; }
        .player-quiz-area { border-radius: 18px; padding: 25px; box-shadow: 0 10px 25px var(--shadow-medium); border-top: 8px solid; transition: all 0.4s ease; opacity: 0; transform: scale(0.98); }
        .player-quiz-area.visible { opacity: 1; transform: scale(1); }
        .theme-child { background-color: var(--c-bg); border-color: var(--c-border); }
        .theme-teen { background-color: var(--t-bg); border-color: var(--t-border); }
        .theme-young-adult { background-color: var(--y-bg); border-color: var(--y-border); }
        .player-info { margin-bottom: 20px; font-weight: 700; font-size: 1.3em; }
        .player-info .player-age { font-size: 0.85em; color: var(--text-secondary); margin-left: 10px; font-weight: 500; }
        .theme-child .player-info { color: var(--c-head); }
        .theme-teen .player-info { color: var(--t-head); }
        .theme-young-adult .player-info { color: var(--y-head); }
        .player-question { min-height: 90px; margin-bottom: 20px; padding: 18px; background-color: rgba(255,255,255, 0.85); border-radius: 12px; display: flex; justify-content: center; align-items: center; font-size: 1.15em; font-weight: 600; line-height: 1.6; border: 1px solid var(--border-color); }
        /* Cevap Butonları */
        .player-options button { display: flex; align-items: center; width: 100%; padding: 12px 18px; margin: 10px 0; border: none; border-radius: 10px; color: white; cursor: pointer; font-size: 1.05em; font-weight: 500; transition: all 0.25s ease; box-shadow: 0 4px 8px rgba(0,0,0,0.1); position: relative; text-align: left; }
        .player-options button .option-text { flex-grow: 1; }
        .player-options button .feedback-icon { margin-left: auto; font-size: 1.3em; width: 25px; text-align: center; }
        .theme-child .player-options button { background: var(--c-btn); }
        .theme-child .player-options button:hover:not(:disabled) { background: var(--c-btn-h); transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        .theme-teen .player-options button { background: var(--t-btn); }
        .theme-teen .player-options button:hover:not(:disabled) { background: var(--t-btn-h); transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        .theme-young-adult .player-options button { background: var(--y-btn); }
        .theme-young-adult .player-options button:hover:not(:disabled) { background: var(--y-btn-h); transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        .player-options button:disabled { background: var(--disabled-bg) !important; color: var(--disabled-text) !important; cursor: not-allowed; opacity: 0.8; transform: none; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); }
        /* Görsel Geri Bildirim */
        .player-options button.selected { outline: 3px solid var(--accent-color); outline-offset: 2px; }
        .player-options button.correct { background: var(--correct-bg) !important; color: var(--correct-text) !important; border: 2px solid var(--correct-border); font-weight: 700; animation: pulseCorrect 0.6s ease; }
        .player-options button.incorrect { background: var(--incorrect-bg) !important; color: var(--incorrect-text) !important; border: 2px solid var(--incorrect-border); animation: shakeIncorrect 0.5s ease; }
        .player-options button.correct .feedback-icon::before { content: '\f00c'; font-family: 'Font Awesome 6 Free'; font-weight: 900; color: var(--correct-text); }
        .player-options button.incorrect .feedback-icon::before { content: '\f00d'; font-family: 'Font Awesome 6 Free'; font-weight: 900; color: var(--incorrect-text); }
        /* Animasyonlar */
        @keyframes pulseCorrect { 0% { transform: scale(1); } 50% { transform: scale(1.03); } 100% { transform: scale(1); } }
        @keyframes shakeIncorrect { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .player-feedback { min-height: 25px; margin-top: 15px; font-weight: 700; font-size: 1.1em; transition: color 0.3s; }
        .feedback-correct { color: var(--correct-text); }
        .feedback-incorrect { color: var(--incorrect-text); }
        /* Sonuç Alanı */
        #results { display: none; margin-top: 30px; padding: 30px; background: #fff; border-radius: 16px; box-shadow: 0 10px 25px var(--shadow-light); border: 1px solid var(--border-color); }
        #final-scores { margin-bottom: 25px; }
        .result-line { font-size: 1.2em; margin: 10px 0; padding: 12px 18px; border-radius: 8px; background-color: #f8fafc; display: flex; justify-content: space-between; align-items: center; border-left: 5px solid; transition: background-color 0.3s; }
        .result-line:hover { background-color: #f1f5f9; }
        .result-line .name { font-weight: 600; flex-grow: 1; text-align: left; margin-right: 15px; }
        .result-line .score { font-weight: 700; font-size: 1.15em;}
        .result-line.theme-child { border-color: var(--c-border); } .result-line.theme-child .name { color: var(--c-head); }
        .result-line.theme-teen { border-color: var(--t-border); } .result-line.theme-teen .name { color: var(--t-head); }
        .result-line.theme-young-adult { border-color: var(--y-border); } .result-line.theme-young-adult .name { color: var(--y-head); }
        #winner-info { font-family: var(--font-heading); font-size: 1.8em; font-weight: 700; color: var(--winner-color); margin-top: 25px; text-shadow: 1px 1px 3px var(--shadow-light); }
        #loading-indicator { display: none; font-size: 1.4em; color: var(--subheader-color); margin: 30px; font-weight: 600; }
        /* --- Küçük Ekran Ayarları --- */
        @media (max-width: 992px) { #players-area { grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;} }
        @media (max-width: 600px) { h1 { font-size: 1.8rem; } h2 {font-size: 1.4rem;} .btn { padding: 12px 24px; font-size: 1em; } #quiz-container { padding: 15px; } #name-entry { padding: 15px; gap: 15px; } .player-input-group { padding: 15px; } #players-area { gap: 15px; } }
    </style>
</head>
<body>
    <div id="quiz-container">
        <h1>Modern İslami Bilgi Yarışması</h1>

        <div id="name-entry">
            <div class="player-input-group">
                <label for="player-1-name-input">Oyuncu 1 Adı:</label>
                <input type="text" id="player-1-name-input" placeholder="İsim..." maxlength="20">
                <label for="player-1-age-input">Yaşı (7-18):</label>
                <input type="number" id="player-1-age-input" min="7" max="18" placeholder="Yaş...">
            </div>
            <div class="player-input-group">
                <label for="player-2-name-input">Oyuncu 2 Adı:</label>
                <input type="text" id="player-2-name-input" placeholder="İsim..." maxlength="20">
                <label for="player-2-age-input">Yaşı (7-18):</label>
                <input type="number" id="player-2-age-input" min="7" max="18" placeholder="Yaş...">
            </div>
            <div class="player-input-group">
                <label for="player-3-name-input">Oyuncu 3 Adı:</label>
                <input type="text" id="player-3-name-input" placeholder="İsim..." maxlength="20">
                <label for="player-3-age-input">Yaşı (7-18):</label>
                <input type="number" id="player-3-age-input" min="7" max="18" placeholder="Yaş...">
            </div>
            <div id="confirm-container">
                <button id="confirm-names-button" class="btn btn-primary">Yarışmayı Başlat</button>
            </div>
            <p id="tts-support-warning" style="color: red; width: 100%; text-align: center; margin-top: 10px; display: none;">Tarayıcınız metin seslendirme özelliğini desteklemiyor olabilir.</p>
        </div>

        <div id="quiz-content">
             <div id="narration-area" style="display: none;">
                 <p id="narration-info">Şimdi dikkatle dinleyin...</p>
                 <button id="play-narration-btn" class="btn btn-primary">Anlatımı Seslendir</button>
             </div>
             <div id="loading-indicator">Sıradaki sorular hazırlanıyor...</div>
             <div id="scoreboard" style="display: none;">
                  <h3>Skor Tablosu</h3>
                  <ul id="scoreboard-list"></ul>
             </div>
             <div id="players-area">
                  <div class="player-quiz-area" id="player-area-1"> <div class="player-info"> <span class="player-name" id="player-1-name-display"></span> <span class="player-age" id="player-1-age-display"></span> </div> <div class="player-question" id="question-player-1"></div> <div class="player-options" id="options-player-1"></div> <div class="player-feedback" id="feedback-player-1"></div> </div>
                  <div class="player-quiz-area" id="player-area-2"> <div class="player-info"> <span class="player-name" id="player-2-name-display"></span> <span class="player-age" id="player-2-age-display"></span> </div> <div class="player-question" id="question-player-2"></div> <div class="player-options" id="options-player-2"></div> <div class="player-feedback" id="feedback-player-2"></div> </div>
                  <div class="player-quiz-area" id="player-area-3"> <div class="player-info"> <span class="player-name" id="player-3-name-display"></span> <span class="player-age" id="player-3-age-display"></span> </div> <div class="player-question" id="question-player-3"></div> <div class="player-options" id="options-player-3"></div> <div class="player-feedback" id="feedback-player-3"></div> </div>
             </div>
        </div>

        <div id="results">
             <h2>Yarışma Bitti!</h2>
             <div id="final-scores"></div>
             <p id="winner-info"></p>
             <button id="restart-button" class="btn btn-primary">Yeni Oyun</button>
        </div>
    </div>

     <audio id="correct-sound" src="https://cdn.jsdelivr.net/gh/k-luna/assets-prod/sounds/correct_bell_vbr.mp3" preload="auto"></audio>
     <audio id="incorrect-sound" src="https://cdn.jsdelivr.net/gh/k-luna/assets-prod/sounds/incorrect_buzz_vbr.mp3" preload="auto"></audio>
     <script>
        // *** SIFIRDAN YAZILMIŞ JAVASCRIPT ***
        document.addEventListener('DOMContentLoaded', () => {

            // --- Veri Yapıları ---
            const quizSegments = [ /* Önceki cevaptaki 10 segment buraya eklenecek */ ];
            const questionPool = [ /* Önceki cevaptaki ~60+ soru buraya eklenecek */ ];
            const players = [
                { id: 1, name: "Oyuncu 1", age: 0, score: 0, answered: false, themeClass: '', currentQuestion: null },
                { id: 2, name: "Oyuncu 2", age: 0, score: 0, answered: false, themeClass: '', currentQuestion: null },
                { id: 3, name: "Oyuncu 3", age: 0, score: 0, answered: false, themeClass: '', currentQuestion: null }
            ];

            // --- Durum Değişkenleri ---
            let currentSegmentIndex = 0;
            let playersAnsweredCount = 0;
            let askedQuestionIds = [];
            let currentUtterance = null; // Aktif seslendirmeyi takip etmek için

            // --- Ana Element Referansları (Güvenli Erişim) ---
            const getElement = (id) => {
                const element = document.getElementById(id);
                if (!element) {
                    console.error(`Hata: "${id}" ID'li element bulunamadı! HTML'i kontrol edin.`);
                }
                return element;
            };

            const nameEntrySection = getElement('name-entry');
            const confirmNamesButton = getElement('confirm-names-button');
            const ttsSupportWarning = getElement('tts-support-warning');
            const quizContent = getElement('quiz-content');
            const narrationArea = getElement('narration-area');
            const narrationInfo = getElement('narration-info');
            const playNarrationButton = getElement('play-narration-btn');
            const scoreboardElement = getElement('scoreboard');
            const scoreboardListElement = getElement('scoreboard-list');
            const playersArea = getElement('players-area');
            const loadingIndicator = getElement('loading-indicator');
            const resultsElement = getElement('results');
            const finalScoresElement = getElement('final-scores');
            const restartButton = getElement('restart-button');
            const winnerInfoElement = getElement('winner-info');

            // Oyuncu Element Referansları (Diziler)
            const nameInputs = [], ageInputs = [], nameDisplays = [], ageDisplays = [];
            const playerAreaElements = [], playerQuestionElements = [], playerOptionsElements = [], playerFeedbackElements = [];

            for (let i = 1; i <= 3; i++) {
                nameInputs.push(getElement(`player-${i}-name-input`));
                ageInputs.push(getElement(`player-${i}-age-input`));
                nameDisplays.push(getElement(`player-${i}-name-display`));
                ageDisplays.push(getElement(`player-${i}-age-display`));
                playerAreaElements.push(getElement(`player-area-${i}`));
                playerQuestionElements.push(getElement(`question-player-${i}`));
                playerOptionsElements.push(getElement(`options-player-${i}`));
                playerFeedbackElements.push(getElement(`feedback-player-${i}`));
            }

             // Ses Efekti Elementleri
             const correctSound = getElement('correct-sound');
             const incorrectSound = getElement('incorrect-sound');

            // --- Yardımcı Fonksiyonlar ---
            function shuffleArray(array) { /* ... önceki gibi ... */ }
            function getThemeClass(age) { /* ... önceki gibi ... */ }
            function checkTtsSupport() { /* ... önceki gibi ... */ }

            function playSound(soundElement) {
                // Null kontrolü ve src kontrolü (placeholder veya boş olmamalı)
                 if (soundElement && soundElement.src && soundElement.src !== window.location.href /*boş src kontrolü*/ && !soundElement.src.includes('YOUR_SOUND_URL')) {
                    soundElement.pause();
                    soundElement.currentTime = 0;
                    soundElement.play().catch(error => console.warn("Ses efekti çalınamadı:", error));
                 }
            }

            // --- Ana Quiz Fonksiyonları ---

            function updateScoreboard() {
                if (!scoreboardListElement) return;
                scoreboardListElement.innerHTML = '';
                players.forEach(player => {
                    const listItem = document.createElement('li');
                    // Null kontrolü tema için
                    const theme = player.themeClass ? player.themeClass.split('-')[1] : 'default';
                    const nameSpan = `<span class="name theme-${theme}">${player.name}</span>`;
                    listItem.innerHTML = `${nameSpan}: <span class="score">${player.score} Puan</span>`;
                    scoreboardListElement.appendChild(listItem);
                });
            }

            function loadSegment(segmentIndex) {
                // Önceki seslendirmeyi durdur
                if (window.speechSynthesis && window.speechSynthesis.speaking) {
                    window.speechSynthesis.cancel();
                }
                currentUtterance = null; // Referansı temizle

                if (segmentIndex >= quizSegments.length) {
                    showResults(); return;
                }
                currentSegmentIndex = segmentIndex;
                const segmentData = quizSegments[segmentIndex];
                if (!segmentData) { console.error("Segment verisi bulunamadı:", segmentIndex); showResults(); return; }

                // UI Güncelleme (Null kontrolleri ile)
                if(playersArea) playersArea.style.display = 'none';
                playerAreaElements.forEach(el => { if(el) el.classList.remove('visible');});
                if(loadingIndicator) loadingIndicator.style.display = 'none';
                if(narrationArea) narrationArea.style.display = 'block';
                if(scoreboardElement) scoreboardElement.style.display = 'block';
                if(narrationInfo) narrationInfo.textContent = `Segment ${segmentIndex + 1}: "${segmentData.narrationTitle}" konusunu dinlemek için butona basın.`;
                if(playNarrationButton) { playNarrationButton.disabled = false; playNarrationButton.textContent = "Anlatımı Seslendir"; }

                players.forEach(player => {
                    const feedbackEl = playerFeedbackElements[player.id - 1];
                    const sectionEl = playerAreaElements[player.id - 1];
                    if (feedbackEl) feedbackEl.textContent = '';
                    if (sectionEl) sectionEl.style.borderColor = 'transparent';
                });
                updateScoreboard();
            }

             function playNarration() {
                 if (!('speechSynthesis' in window) || !window.speechSynthesis) {
                     alert("Üzgünüz, tarayıcınız metin seslendirme özelliğini desteklemiyor.");
                     if (playNarrationButton) playNarrationButton.disabled = true;
                     return;
                 }
                 window.speechSynthesis.cancel(); // Öncekini durdur

                 const segmentData = quizSegments[currentSegmentIndex];
                 if (!segmentData || !segmentData.narrationText) {
                     console.error("Seslendirilecek metin bulunamadı!"); alert("Metin verisi eksik!");
                     return;
                 }

                 currentUtterance = new SpeechSynthesisUtterance(segmentData.narrationText);
                 currentUtterance.lang = 'tr-TR';
                 currentUtterance.rate = 0.9;
                 currentUtterance.pitch = 1;
                 currentUtterance.onend = handleNarrationEnd;
                 currentUtterance.onerror = (event) => {
                     console.error('TTS Hatası:', event);
                     alert(`Seslendirme hatası: ${event.error}. Farklı tarayıcı deneyin veya ses paketlerini kontrol edin.`);
                     if (playNarrationButton) { playNarrationButton.textContent = "Hata!"; playNarrationButton.disabled = false; }
                     currentUtterance = null; // Hata sonrası temizle
                 };

                 if (playNarrationButton) { playNarrationButton.disabled = true; playNarrationButton.textContent = "Seslendiriliyor..."; }
                 window.speechSynthesis.speak(currentUtterance);
             }


            function handleNarrationEnd() {
                console.log("Seslendirme bitti.");
                currentUtterance = null; // Referansı temizle
                if (playNarrationButton) { playNarrationButton.textContent = "Anlatım Bitti"; playNarrationButton.disabled = true; }
                if (narrationArea) narrationArea.style.display = 'none';
                if (loadingIndicator) loadingIndicator.style.display = 'block';
                setTimeout(() => {
                    loadQuestionsForPlayers(currentSegmentIndex);
                    if (loadingIndicator) loadingIndicator.style.display = 'none';
                    if (playersArea) playersArea.style.display = 'grid';
                    playerAreaElements.forEach(el => { if(el) el.classList.add('visible'); });
                }, 500);
            }

            function loadQuestionsForPlayers(segmentIdx) {
                playersAnsweredCount = 0;
                let currentRoundSelectedIds = [];
                const segmentIdToLoad = quizSegments[segmentIdx]?.segmentId;

                if (segmentIdToLoad === undefined) { console.error("loadQuestions: Geçersiz segment index:", segmentIdx); showResults(); return; }

                players.forEach(player => {
                    player.answered = false; player.currentQuestion = null;
                    const optionsEl = playerOptionsElements[player.id - 1];
                    const feedbackEl = playerFeedbackElements[player.id - 1];
                    const questionEl = playerQuestionElements[player.id - 1];
                    const sectionEl = playerAreaElements[player.id - 1];

                    // Element kontrolleri
                    if (!optionsEl || !feedbackEl || !questionEl || !sectionEl) {
                        console.error(`loadQuestions: Oyuncu ${player.id} için element bulunamadı.`);
                        player.answered = true; // Sorunlu oyuncuyu geç
                        playersAnsweredCount++; return;
                    }

                    optionsEl.innerHTML = ''; feedbackEl.textContent = ''; questionEl.textContent = 'Soru aranıyor...';
                    sectionEl.style.borderColor = 'transparent';

                    // Soru filtreleme ve seçme
                    const suitableQuestions = questionPool.filter(q =>
                        q.segmentId === segmentIdToLoad && player.age >= q.minAge && player.age <= q.maxAge &&
                        !askedQuestionIds.includes(q.questionId) && !currentRoundSelectedIds.includes(q.questionId)
                    );

                    let questionData = null;
                    if (suitableQuestions.length > 0) {
                        questionData = suitableQuestions[Math.floor(Math.random() * suitableQuestions.length)];
                        player.currentQuestion = questionData;
                        askedQuestionIds.push(questionData.questionId);
                        currentRoundSelectedIds.push(questionData.questionId);
                        questionEl.textContent = questionData.questionText;
                        const shuffledOptions = shuffleArray([...questionData.options]);
                        shuffledOptions.forEach(option => { // Butonları oluştur
                            const button = document.createElement('button');
                            const textSpan = document.createElement('span'); textSpan.className = 'option-text'; textSpan.textContent = option;
                            const iconSpan = document.createElement('span'); iconSpan.className = 'feedback-icon';
                            button.appendChild(textSpan); button.appendChild(iconSpan);
                            button.onclick = () => handleAnswer(player.id, option);
                            optionsEl.appendChild(button);
                        });
                    } else {
                        questionEl.textContent = 'Size uygun soru bulunamadı.';
                        player.answered = true; playersAnsweredCount++;
                    }
                });

                // Turun hemen bitme kontrolü
                if (playersAnsweredCount === players.length && playersAnsweredCount > 0) {
                    console.log("Bu turda kimseye soru bulunamadı veya hepsi otomatik geçildi.");
                    if(loadingIndicator) loadingIndicator.style.display = 'block';
                    if(playersArea) playersArea.style.display = 'none';
                    setTimeout(() => loadSegment(currentSegmentIndex + 1), 1800);
                }
            }

             function handleAnswer(playerId, selectedOption) {
                 const player = players.find(p => p.id === playerId);
                 if (!player || player.answered || !player.currentQuestion) return;

                 player.answered = true; playersAnsweredCount++;

                 const feedbackEl = playerFeedbackElements[player.id-1];
                 const sectionEl = playerAreaElements[player.id-1];
                 const optionsEl = playerOptionsElements[player.id-1];

                 if (!feedbackEl || !sectionEl || !optionsEl) { console.error("handleAnswer: Elementler null"); return; } // Null Check
                 const playerOptionButtons = optionsEl.getElementsByTagName('button');

                 let correctButton = null; let selectedButton = null;

                 for(let btn of playerOptionButtons){
                     btn.disabled = true;
                     const btnTextSpan = btn.querySelector('.option-text');
                     if (!btnTextSpan) continue;
                     if (btnTextSpan.textContent === selectedOption) { selectedButton = btn; btn.classList.add('selected'); }
                     if (btnTextSpan.textContent === player.currentQuestion.correctAnswer) { correctButton = btn; }
                 }

                 // Geri bildirimler
                 if (selectedOption === player.currentQuestion.correctAnswer) {
                     player.score++; feedbackEl.textContent = "Doğru!"; feedbackEl.className = 'player-feedback feedback-correct';
                     if (selectedButton) { selectedButton.classList.remove('selected'); selectedButton.classList.add('correct'); }
                     playSound(correctSound);
                 } else {
                     feedbackEl.textContent = `Yanlış!`; feedbackEl.className = 'player-feedback feedback-incorrect';
                     if (selectedButton) { selectedButton.classList.remove('selected'); selectedButton.classList.add('incorrect'); }
                     if (correctButton) { correctButton.classList.add('correct'); } // Doğruyu göster
                     playSound(incorrectSound);
                 }
                 updateScoreboard();

                 // Tur sonu kontrolü
                 if(playersAnsweredCount === players.length) {
                     console.log("Tur tamamlandı, sonraki segmente geçiliyor.");
                     if(loadingIndicator) loadingIndicator.style.display = 'block';
                     setTimeout(() => {
                        // Buton sınıflarını temizle ve sonraki segmente geçmeden önce alanları gizle
                        playerAreaElements.forEach((area, index) => {
                             if (area) {
                                 const buttons = playerOptionsElements[index]?.getElementsByTagName('button');
                                 if (buttons) {
                                     for(let btn of buttons) {
                                         btn.classList.remove('selected', 'correct', 'incorrect');
                                         // İkonları temizle (varsa)
                                         const icon = btn.querySelector('.feedback-icon');
                                         if (icon) icon.textContent = '';
                                     }
                                 }
                                 area.classList.remove('visible');
                             }
                        });
                        if(playersArea) playersArea.style.display = 'none';
                         loadSegment(currentSegmentIndex + 1);
                     }, 2500);
                 }
             }

             function showResults() { /* ... önceki gibi ... */ }
             function initializeQuiz() { /* ... önceki gibi ... */ }
             function startQuiz() { /* ... önceki gibi ... */ }
             function resetToNameEntry() { /* ... önceki gibi ... */ }

            // --- Olay Dinleyicileri (Null Kontrollü) ---
            if (confirmNamesButton) { confirmNamesButton.addEventListener('click', initializeQuiz); }
            if (restartButton) { restartButton.addEventListener('click', resetToNameEntry); }
            if (playNarrationButton) { playNarrationButton.addEventListener('click', playNarration); }


            // --- Başlangıç ---
            checkTtsSupport(); // TTS desteğini kontrol et
            resetToNameEntry(); // Sayfa ilk yüklendiğinde isim girişi ekranını göster

        }); // DOMContentLoaded Sonu
    </script>

</body>
</html>
